{
    "version": "https://jsonfeed.org/version/1",
    "title": "wkevin Blog",
    "home_page_url": "https://wkevin.github.io/blog",
    "description": "wkevin Blog",
    "items": [
        {
            "id": "https://wkevin.github.io/blog/2024/05/29/git.rollback",
            "content_html": "<p>假设一个文件中包含下面几句：</p>\n<div class=\"language-py codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-py codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> __name__ </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"__main__\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Hello\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    exit</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果在 git master 分支中修改了一句：</p>\n<div class=\"language-py codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-py codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Hello world\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>另外一个分支 b1 先做了相同的修改，做了 git 提交，然后后删除了 <code>world</code> 回到原始状态，又做了 git 提交。</p>\n<p>此时 merge 两个分支：</p>\n<p><img decoding=\"async\" loading=\"lazy\" alt=\"alt text\" src=\"https://wkevin.github.io/assets/images/git-3cb1ace3fa4c57a48c87c035cbfe6467.png\" width=\"714\" height=\"210\" class=\"img_ev3q\"></p>\n<p>结果中 <code>world</code> 有？还是没有？</p>\n<ul>\n<li><strong>支持“没有”的</strong></li>\n</ul>\n<p>认为 b1 分支中第二次 commit 时间更靠后，应该更应该被采纳，删除了 <code>world</code> 肯定是因为发现了“错误”，都在 b1 中修正了这个“错误”了，为什么 master 分支中还要保留这个“错误”呢？</p>\n<p>万一这不是个错误，而是个“病毒”，b1 中及时删除了这个病毒，难道合入 master 后还要保留这个病毒？</p>\n<ul>\n<li><strong>支持“有”的</strong></li>\n</ul>\n<p>认为 master 分支中的增加 <code>world</code> 操作是对原文的修改，b1 分支中先加后删是“反悔”了，在做回退（rollback）操作，那么 master 分支中的操作更有价值，更应该保留。</p>\n<p>万一 master 分支这个操作修复了病毒，而 b1 分支上没意识到呢？</p>\n<ul>\n<li><strong>支持“冲突提示”的</strong></li>\n</ul>\n<p>双方都修改了同一行，为啥不提示冲突？人工解决不是更稳妥么？</p>\n<p><strong>结果：“有” -- 即：git 认为 b1 中是回退操作，master 上的修改更有价值，被采纳。</strong></p>\n<p>git merge 操作的基本流程是：</p>\n<ul>\n<li>寻找 3 个点：master 分支最新提交、b1 分支最新提交、master 和 b1 的 git merge base —— 我们暂时称为：A、B、C 点</li>\n<li>先用 A 与 C 对比，因为 A-C 之间可以有若干次提交，中间的就跳过不管了，只对比 A-C 两次提交的差异</li>\n<li>再用 B 与 C 对比</li>\n<li>然后用 2 次对比结果再进行对比</li>\n</ul>\n<p>所以寄希望 A-C 之间的变化能被 git 发现，可能会失望了。所谓“智能”的发现了回退、反悔，应该只能看做对 git 这个工作流程的溢美之词。</p>\n<p>不要以为 merge 成功了，没有提示冲突，就以为代码合并的没有问题，现实情况是复杂的，git 并没有你想象的那么智能，也许以后 git + LLM 说不定可以解决这个问题。</p>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/68557395/why-does-this-git-merge-not-result-in-conflicts\" target=\"_blank\" rel=\"noopener noreferrer\">https://stackoverflow.com/questions/68557395/why-does-this-git-merge-not-result-in-conflicts</a></li>\n<li><a href=\"https://git-scm.com/docs/merge-strategies\" target=\"_blank\" rel=\"noopener noreferrer\">https://git-scm.com/docs/merge-strategies</a></li>\n</ul>",
            "url": "https://wkevin.github.io/blog/2024/05/29/git.rollback",
            "title": "git 智能的认为你“反悔”了",
            "summary": "git.rollback",
            "date_modified": "2024-05-29T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "git",
                "rollback"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2024/03/20/web.framework.compare",
            "content_html": "<p>前天的工具优化了一下:</p>\n<ul>\n<li>输出的改为 markdown 表格: 这下拷贝到 blog 就更方便了。那今天就看看 web 框架的对比数据吧。</li>\n<li>处理 License 为空的情况。</li>\n<li>直接把 markdown link url 放进去。</li>\n</ul>\n<p>这里的 Web 框架不包括 Web Server（HTTP Server、CGI Server……），也不包括微服务框架，仅是 MVC 层面上的框架。</p>\n<p>还是按 star 数量排序。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"go\">Go<a href=\"https://wkevin.github.io/blog/2024/03/20/web.framework.compare#go\" class=\"hash-link\" aria-label=\"Direct link to Go\" title=\"Direct link to Go\">​</a></h2>\n<table><thead><tr><th>NO</th><th>ProjectName</th><th>Star/k</th><th>Fork/k</th><th>Size/M</th><th>CreateDate</th><th>LatestPush</th><th>License</th><th>Repo</th></tr></thead><tbody><tr><td>1</td><td>gin</td><td>74.8</td><td>7.8</td><td>3.2</td><td>2014-06(10)</td><td>2024-03-17</td><td>mit</td><td><a href=\"https://github.com/gin-gonic/gin\" target=\"_blank\" rel=\"noopener noreferrer\">gin-gonic/gin</a></td></tr><tr><td>2</td><td>beego</td><td>30.7</td><td>5.6</td><td>11.4</td><td>2012-02(12)</td><td>2024-03-12</td><td>other</td><td><a href=\"https://github.com/beego/beego\" target=\"_blank\" rel=\"noopener noreferrer\">beego/beego</a></td></tr><tr><td>3</td><td>echo</td><td>28.2</td><td>2.2</td><td>6.4</td><td>2015-03(9)</td><td>2024-03-13</td><td>mit</td><td><a href=\"https://github.com/labstack/echo\" target=\"_blank\" rel=\"noopener noreferrer\">labstack/echo</a></td></tr><tr><td>4</td><td>iris</td><td>24.8</td><td>2.5</td><td>17.8</td><td>2016-01(8)</td><td>2024-03-13</td><td>bsd-3-clause</td><td><a href=\"https://github.com/kataras/iris\" target=\"_blank\" rel=\"noopener noreferrer\">kataras/iris</a></td></tr><tr><td>5</td><td>gf</td><td>10.7</td><td>1.5</td><td>119.6</td><td>2017-06(7)</td><td>2024-03-17</td><td>mit</td><td><a href=\"https://github.com/gogf/gf\" target=\"_blank\" rel=\"noopener noreferrer\">gogf/gf</a></td></tr><tr><td>6</td><td>bud</td><td>5.5</td><td>0.2</td><td>25.7</td><td>2022-04(2)</td><td>2023-11-24</td><td>mit</td><td><a href=\"https://github.com/livebud/bud\" target=\"_blank\" rel=\"noopener noreferrer\">livebud/bud</a></td></tr><tr><td>7</td><td>hertz</td><td>4.6</td><td>0.4</td><td>2.7</td><td>2022-05(2)</td><td>2024-03-10</td><td>apache-2.0</td><td><a href=\"https://github.com/cloudwego/hertz\" target=\"_blank\" rel=\"noopener noreferrer\">cloudwego/hertz</a></td></tr><tr><td>8</td><td>algernon</td><td>2.6</td><td>0.1</td><td>57.7</td><td>2015-03(9)</td><td>2024-03-10</td><td>bsd-3-clause</td><td><a href=\"https://github.com/xyproto/algernon\" target=\"_blank\" rel=\"noopener noreferrer\">xyproto/algernon</a></td></tr></tbody></table>\n<p>-------- 采样时间: 2024-03-20</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"rust\">rust<a href=\"https://wkevin.github.io/blog/2024/03/20/web.framework.compare#rust\" class=\"hash-link\" aria-label=\"Direct link to rust\" title=\"Direct link to rust\">​</a></h2>\n<table><thead><tr><th>NO</th><th>ProjectName</th><th>Star/k</th><th>Fork/k</th><th>Size/M</th><th>CreateDate</th><th>LatestPush</th><th>License</th><th>Repo</th></tr></thead><tbody><tr><td>1</td><td>actix-web</td><td>20.0</td><td>1.6</td><td>13.6</td><td>2017-09(6)</td><td>2024-03-18</td><td>apache-2.0</td><td><a href=\"https://github.com/actix/actix-web\" target=\"_blank\" rel=\"noopener noreferrer\">actix/actix-web</a></td></tr><tr><td>2</td><td>axum</td><td>15.6</td><td>0.9</td><td>4.0</td><td>2021-05(3)</td><td>2024-03-18</td><td>null</td><td><a href=\"https://github.com/tokio-rs/axum\" target=\"_blank\" rel=\"noopener noreferrer\">tokio-rs/axum</a></td></tr><tr><td>3</td><td>warp</td><td>9.0</td><td>0.7</td><td>1.0</td><td>2018-07(6)</td><td>2024-02-09</td><td>mit</td><td><a href=\"https://github.com/seanmonstar/warp\" target=\"_blank\" rel=\"noopener noreferrer\">seanmonstar/warp</a></td></tr><tr><td>4</td><td>tide</td><td>4.9</td><td>0.3</td><td>1.5</td><td>2018-08(6)</td><td>2024-01-05</td><td>apache-2.0</td><td><a href=\"https://github.com/http-rs/tide\" target=\"_blank\" rel=\"noopener noreferrer\">http-rs/tide</a></td></tr><tr><td>5</td><td>tower</td><td>3.2</td><td>0.3</td><td>3.3</td><td>2017-07(7)</td><td>2024-03-18</td><td>mit</td><td><a href=\"https://github.com/tower-rs/tower\" target=\"_blank\" rel=\"noopener noreferrer\">tower-rs/tower</a></td></tr><tr><td>6</td><td>poem</td><td>3.1</td><td>0.3</td><td>4.6</td><td>2021-08(3)</td><td>2024-03-18</td><td>apache-2.0</td><td><a href=\"https://github.com/poem-web/poem\" target=\"_blank\" rel=\"noopener noreferrer\">poem-web/poem</a></td></tr><tr><td>7</td><td>salvo</td><td>2.7</td><td>0.2</td><td>14.9</td><td>2019-11(4)</td><td>2024-03-15</td><td>apache-2.0</td><td><a href=\"https://github.com/salvo-rs/salvo\" target=\"_blank\" rel=\"noopener noreferrer\">salvo-rs/salvo</a></td></tr><tr><td>8</td><td>teo</td><td>0.5</td><td>0.0</td><td>3.5</td><td>2022-05(2)</td><td>2024-03-19</td><td>apache-2.0</td><td><a href=\"https://github.com/teocloud/teo\" target=\"_blank\" rel=\"noopener noreferrer\">teocloud/teo</a></td></tr><tr><td>9</td><td>teo-python</td><td>0.0</td><td>0.0</td><td>0.5</td><td>2023-01(1)</td><td>2024-03-19</td><td>apache-2.0</td><td><a href=\"https://github.com/teocloud/teo-python\" target=\"_blank\" rel=\"noopener noreferrer\">teocloud/teo-python</a></td></tr><tr><td>10</td><td>teo-nodejs</td><td>0.0</td><td>0.0</td><td>1.3</td><td>2023-01(1)</td><td>2024-03-19</td><td>apache-2.0</td><td><a href=\"https://github.com/teocloud/teo-nodejs\" target=\"_blank\" rel=\"noopener noreferrer\">teocloud/teo-nodejs</a></td></tr></tbody></table>\n<p>-------- 采样时间: 2024-03-20</p>\n<blockquote>\n<p>axum 没有设置 license</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python\">python<a href=\"https://wkevin.github.io/blog/2024/03/20/web.framework.compare#python\" class=\"hash-link\" aria-label=\"Direct link to python\" title=\"Direct link to python\">​</a></h2>\n<table><thead><tr><th>NO</th><th>ProjectName</th><th>Star/k</th><th>Fork/k</th><th>Size/M</th><th>CreateDate</th><th>LatestPush</th><th>License</th><th>Repo</th></tr></thead><tbody><tr><td>1</td><td>django</td><td>76.2</td><td>30.5</td><td>242.0</td><td>2012-04(12)</td><td>2024-03-18</td><td>bsd-3-clause</td><td><a href=\"https://github.com/django/django\" target=\"_blank\" rel=\"noopener noreferrer\">django/django</a></td></tr><tr><td>2</td><td>fastapi</td><td>69.4</td><td>5.8</td><td>20.0</td><td>2018-12(5)</td><td>2024-03-18</td><td>mit</td><td><a href=\"https://github.com/tiangolo/fastapi\" target=\"_blank\" rel=\"noopener noreferrer\">tiangolo/fastapi</a></td></tr><tr><td>3</td><td>flask</td><td>66.0</td><td>15.9</td><td>10.2</td><td>2010-04(14)</td><td>2024-03-08</td><td>bsd-3-clause</td><td><a href=\"https://github.com/pallets/flask\" target=\"_blank\" rel=\"noopener noreferrer\">pallets/flask</a></td></tr><tr><td>4</td><td>tornado</td><td>21.5</td><td>5.5</td><td>9.9</td><td>2009-09(15)</td><td>2024-03-13</td><td>apache-2.0</td><td><a href=\"https://github.com/tornadoweb/tornado\" target=\"_blank\" rel=\"noopener noreferrer\">tornadoweb/tornado</a></td></tr><tr><td>5</td><td>sanic</td><td>17.6</td><td>1.5</td><td>8.8</td><td>2016-05(8)</td><td>2024-03-14</td><td>mit</td><td><a href=\"https://github.com/sanic-org/sanic\" target=\"_blank\" rel=\"noopener noreferrer\">sanic-org/sanic</a></td></tr><tr><td>6</td><td>starlette</td><td>9.3</td><td>0.8</td><td>6.6</td><td>2018-06(6)</td><td>2024-03-15</td><td>bsd-3-clause</td><td><a href=\"https://github.com/encode/starlette\" target=\"_blank\" rel=\"noopener noreferrer\">encode/starlette</a></td></tr><tr><td>7</td><td>bottle</td><td>8.3</td><td>1.5</td><td>6.3</td><td>2009-06(15)</td><td>2024-02-02</td><td>mit</td><td><a href=\"https://github.com/bottlepy/bottle\" target=\"_blank\" rel=\"noopener noreferrer\">bottlepy/bottle</a></td></tr><tr><td>8</td><td>vibora</td><td>5.7</td><td>0.3</td><td>0.4</td><td>2018-06(6)</td><td>2020-12-23</td><td>mit</td><td><a href=\"https://github.com/vibora-io/vibora\" target=\"_blank\" rel=\"noopener noreferrer\">vibora-io/vibora</a></td></tr><tr><td>9</td><td>pyramid</td><td>3.9</td><td>0.9</td><td>24.8</td><td>2010-10(13)</td><td>2024-03-03</td><td>other</td><td><a href=\"https://github.com/Pylons/pyramid\" target=\"_blank\" rel=\"noopener noreferrer\">Pylons/pyramid</a></td></tr><tr><td>10</td><td>quart</td><td>2.5</td><td>0.1</td><td>2.4</td><td>2017-11(6)</td><td>2024-03-06</td><td>mit</td><td><a href=\"https://github.com/pallets/quart\" target=\"_blank\" rel=\"noopener noreferrer\">pallets/quart</a></td></tr><tr><td>11</td><td>cherrypy</td><td>1.8</td><td>0.4</td><td>27.6</td><td>2016-04(8)</td><td>2024-02-25</td><td>bsd-3-clause</td><td><a href=\"https://github.com/cherrypy/cherrypy\" target=\"_blank\" rel=\"noopener noreferrer\">cherrypy/cherrypy</a></td></tr><tr><td>12</td><td>apiflask</td><td>0.9</td><td>0.1</td><td>2.1</td><td>2021-01(3)</td><td>2024-03-10</td><td>mit</td><td><a href=\"https://github.com/apiflask/apiflask\" target=\"_blank\" rel=\"noopener noreferrer\">apiflask/apiflask</a></td></tr></tbody></table>\n<p>-------- 采样时间: 2024-03-20</p>",
            "url": "https://wkevin.github.io/blog/2024/03/20/web.framework.compare",
            "title": "Web 开发框架对比",
            "summary": "web framework compare",
            "date_modified": "2024-03-20T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "web",
                "framework"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2024/03/18/github.repo.compare",
            "content_html": "<p>最近有个新项目，要重新选型 Admin 系统，但发现 <a href=\"https://www.githubcompare.com/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.githubcompare.com/</a> 频频异常，就自己写了个脚本，从 <code>https://api.github.com/repos/...</code> 下获取数据，然后抓取出自己关心的字段，再做横向对比。</p>\n<p>数据抓取结果如下：</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"仅前端--vue3--ts\">仅前端 &amp; VUE3 &amp; TS<a href=\"https://wkevin.github.io/blog/2024/03/18/github.repo.compare#%E4%BB%85%E5%89%8D%E7%AB%AF--vue3--ts\" class=\"hash-link\" aria-label=\"Direct link to 仅前端 &amp; VUE3 &amp; TS\" title=\"Direct link to 仅前端 &amp; VUE3 &amp; TS\">​</a></h2>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ProjectName          CreateDate  LatestPush  Star/k  Fork/k  Size/M  License  Repo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">vue-vben-admin       2020-07(4)  2024-03-15  21.7    5.9     23.2    mit      vbenjs/vue-vben-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">vue-manage-system    2016-11(7)  2024-01-12  18.1    5.9     3.1     mit      lin-xin/vue-manage-system</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">vue-pure-admin       2020-11(3)  2024-03-17  13.2    2.5     192.6   mit      pure-admin/vue-pure-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Geeker-Admin         2022-04(2)  2024-03-04  6.1     1.3     28.5    mit      HalseySpicy/Geeker-Admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">naive-ui-admin       2021-07(3)  2024-03-04  4.5     0.8     1.3     mit      jekip/naive-ui-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">yudao-ui-admin-vue3  2023-02(1)  2024-03-01  0.9     0.4     10.2    mit      yudaocode/yudao-ui-admin-vue3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-------- 采样时间: 2024-03-18</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"全栈\">全栈<a href=\"https://wkevin.github.io/blog/2024/03/18/github.repo.compare#%E5%85%A8%E6%A0%88\" class=\"hash-link\" aria-label=\"Direct link to 全栈\" title=\"Direct link to 全栈\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"后端-go-语言\">后端 go 语言<a href=\"https://wkevin.github.io/blog/2024/03/18/github.repo.compare#%E5%90%8E%E7%AB%AF-go-%E8%AF%AD%E8%A8%80\" class=\"hash-link\" aria-label=\"Direct link to 后端 go 语言\" title=\"Direct link to 后端 go 语言\">​</a></h3>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ProjectName    CreateDate  LatestPush  Star/k  Fork/k  Size/M  License     Repo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gin-vue-admin  2019-09(5)  2024-03-17  19.6    5.9     12.1    apache-2.0  flipped-aurora/gin-vue-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">go-admin       2020-03(4)  2024-03-14  10.6    2.2     17.4    mit         go-admin-team/go-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">go-admin       2018-06(6)  2024-03-04  7.7     1.3     51.6    apache-2.0  GoAdminGroup/go-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">goxygen        2020-02(4)  2024-03-10  3.3     0.2     8.2     apache-2.0  Shpota/goxygen</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">go-ldap-admin  2022-05(2)  2024-02-21  1.3     0.2     0.7     gpl-3.0     eryajf/go-ldap-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-------- 采样时间: 2024-03-18</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"后端-python\">后端 python<a href=\"https://wkevin.github.io/blog/2024/03/18/github.repo.compare#%E5%90%8E%E7%AB%AF-python\" class=\"hash-link\" aria-label=\"Direct link to 后端 python\" title=\"Direct link to 后端 python\">​</a></h3>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ProjectName                CreateDate   LatestPush  Star/k  Fork/k  Size/M  License       Repo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">flask-admin                2012-03      2024-03-01  5.6     1.6     15.4    bsd-3-clause  flask-admin/flask-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">fastapi-admin              2020-04      2024-03-21  2.5     0.3     6.9     apache-2.0    fastapi-admin/fastapi-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">django-suit                2013-02      2024-02-12  2.3     0.7     6.1     other         darklow/django-suit</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">django-admin-interface     2015-10      2024-03-19  1.7     0.2     1.0     mit           fabiocaccamo/django-admin-interface</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">django-admin2              2013-05      2022-08-02  1.2     0.2     3.1     bsd-3-clause  jazzband/django-admin2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">django-admin-honeypot      2011-09      2022-04-10  1.0     0.2     0.2     mit           dmpayton/django-admin-honeypot</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">django-admin-bootstrap     2012-07      2022-10-10  0.9     0.2     2.4     mit           douglasmiranda/django-admin-bootstrap</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">django-vue-admin           2020-04      2024-03-12  0.8     0.2     3.1     mit           caoqianming/django-vue-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">django-vue3-admin          2023-05      2024-03-18  0.1     0.0     5.6     apache-2.0    huge-dream/django-vue3-admin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-------- 采样时间: 2024-03-22</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>后端是 rust 的太少了，后端 Java 的我不会 —— 所以就不对比了，呵呵。</p>",
            "url": "https://wkevin.github.io/blog/2024/03/18/github.repo.compare",
            "title": "几个 github 项目选型的比较",
            "summary": "github.repo.compare",
            "date_modified": "2024-03-18T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "github",
                "repo",
                "compare"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2024/03/14/rust.methods",
            "content_html": "<p>将 rust 标准库中的几个常用类型的方法安装第一个入参（即：Move、借用、可变借用）分组整理，以便开发时做个参考。</p>\n<table><thead><tr><th style=\"text-align:center\">Type</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td style=\"text-align:center\"><strong>Cow</strong></td><td><code>from()</code></td><td><code>into_owned()</code></td><td></td><td><code>to_mut()</code></td></tr><tr><td style=\"text-align:center\"><strong>Cell</strong></td><td><code>from()</code><br><code>from_mut()</code><br><code>new()</code></td><td><code>into_inner()</code></td><td><code>set()</code><br><code>get()</code><br><code>take()</code><br><code>replace()</code></td><td><code>get_mut()</code></td></tr><tr><td style=\"text-align:center\"><strong>RefCell</strong></td><td><code>from()</code><br><code>new()</code></td><td><code>into_inner()</code></td><td><code>borrow()</code><br><code>borrow_mut()</code><br><code>take()</code><br><code>replace()</code></td><td><code>get_mut()</code></td></tr><tr><td style=\"text-align:center\"><strong>Vec</strong></td><td><code>from()</code><br><code>new()</code><br><code>with_capacity()</code></td><td><code>into_boxed_slice()</code></td><td><code>len()</code><br><code>capacity()</code><br><code>is_empyt()</code></td><td><code>insert()</code><br><code>append()</code><br><code>push()</code><br><code>pop()</code><br><code>remove()</code><br><code>drain()</code><br><code>clear()</code><br><code>splice()</code><br><code>reserve()</code><br><code>resize()</code><br><code>shrink_to()</code><br><code>truncate()</code></td></tr><tr><td style=\"text-align:center\"><strong>BTreeMap</strong></td><td><code>from()</code><br><code>new()</code></td><td><code>into_keys()</code><br><code>range()</code></td><td><code>get()</code><br><code>len()</code><br><code>keys()</code><br><code>values()</code><br><code>iter()</code><br><code>get_key_value()</code><br><code>first_key_value()</code><br><code>last_key_value()</code><br><code>contains_key()</code><br><code>is_empyt()</code></td><td><code>insert()</code><br><code>append()</code><br><code>extend</code><br><code>retain()</code><br><code>remove()</code><br><code>pop_first()</code><br><code>pop_last()</code><br><code>entry()</code><br><code>first_entry()</code><br><code>last_entry()</code></td></tr><tr><td style=\"text-align:center\"><strong>HashMap</strong></td><td><code>from()</code><br><code>new()</code></td><td><code>keys()</code><br><code>into_keys()</code><br><code>capacity()</code></td><td><code>get()</code><br><code>len()</code><br><code>values()</code><br><code>iter()</code><br><code>is_empty()</code></td><td><code>insert()</code><br><code>extend</code><br><code>retain()</code><br><code>drain()</code><br><code>remove()</code><br><code>remove_entry()</code><br><code>reserve()</code><br><code>entry()</code></td></tr><tr><td style=\"text-align:center\"><strong>Box</strong></td><td><code>from()</code><br><code>new()</code><br><code>leak()</code><br><code>pin()</code></td><td><code>downcast()</code><br><code>split()</code></td><td><code>borrow()</code></td><td><code>borrow_mut()</code><br><code>consume()</code><br><code>read_line()</code></td></tr></tbody></table>\n<p>同时还能发现一些规律，比如：</p>\n<ul>\n<li>自动解引用的类型还是少数，本文只有 Vec，但手动解引用的基本都会 impl。</li>\n<li>同名的方法要注意，比如 Vec 的 len() 和自动解引用后数组的 len()。</li>\n<li>一般都会实现个性化的 Clone、Debug、Defaut、Dref、Drop、From 等 Trait，而 Borrow、Into、ToOwned 等使用 Blanket Trait 实现。</li>\n</ul>\n<p>Blanket Implementations（一揽子实现） 即 Trait 的默认实现，几乎每个类型都实现了下面的“一揽子实现”：</p>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; Into&lt;U&gt; for T</code></td><td></td><td><code>into()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><strong><code>to_owned()</code></strong></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToString for T</code></td><td></td><td></td><td><code>to_string()</code></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"string\">string<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#string\" class=\"hash-link\" aria-label=\"Direct link to string\" title=\"Direct link to string\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"stringstring\">string::String<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#stringstring\" class=\"hash-link\" aria-label=\"Direct link to string::String\" title=\"Direct link to string::String\">​</a></h3>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"borrow\">borrow<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#borrow\" class=\"hash-link\" aria-label=\"Direct link to borrow\" title=\"Direct link to borrow\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"borrowcow\">borrow::Cow<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#borrowcow\" class=\"hash-link\" aria-label=\"Direct link to borrow::Cow\" title=\"Direct link to borrow::Cow\">​</a></h3>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><em>Methods</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;B&gt; Cow&lt;'_, B&gt;</code></td><td></td><td><strong><code>into_owned()</code></strong></td><td></td><td><strong><code>to_mut()</code></strong></td></tr><tr><td><em>Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;B&gt; Clone for Cow&lt;'_, B&gt;</code></td><td></td><td></td><td><code>clone()</code></td><td><code>clone_from()</code></td></tr><tr><td><code>impl&lt;B&gt; Deref for Cow&lt;'_, B&gt;</code></td><td></td><td></td><td><code>deref()</code></td><td></td></tr><tr><td><code>impl&lt;'a&gt; Extend&lt;Cow&lt;'a, str&gt;&gt; for String</code></td><td></td><td></td><td></td><td><code>extend()</code></td></tr><tr><td><code>impl From&lt;XXX&gt; for Cow</code></td><td><strong><code>from(XXX)</code></strong></td><td></td><td></td><td></td></tr><tr><td><code>impl From&lt;Cow&lt;XXX&gt; for YYY</code></td><td><code>from(Cow&lt;XXX&gt;)</code></td><td></td><td></td><td></td></tr><tr><td><em>Auto Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Blanket Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; Into&lt;U&gt; for T</code></td><td></td><td><code>into()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><strong><code>to_owned()</code></strong></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToString for T</code></td><td></td><td></td><td><code>to_string()</code></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cell\">cell<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#cell\" class=\"hash-link\" aria-label=\"Direct link to cell\" title=\"Direct link to cell\">​</a></h2>\n<p>突破“一个数据只有一个所有者、不可变不允许做可变借用、可变与不可变借用不能同时存在 —— 三大编译器限制”，手工解决共享访问及数据竞争问题。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cellcell\">cell::Cell<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#cellcell\" class=\"hash-link\" aria-label=\"Direct link to cell::Cell\" title=\"Direct link to cell::Cell\">​</a></h3>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><em>Methods</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Cell&lt;T&gt;</code></td><td><code>new(T)</code></td><td><code>into_inner()</code></td><td><strong><code>set()</code></strong></td><td></td></tr><tr><td></td><td></td><td></td><td><code>swap()</code></td><td></td></tr><tr><td></td><td></td><td></td><td><strong><code>replace()</code></strong></td><td></td></tr><tr><td></td><td></td><td></td><td><code>as_slice_of_cells()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Cell&lt;T&gt;</code><br><code>where T: Copy</code></td><td></td><td></td><td><strong><code>get()</code></strong></td><td></td></tr><tr><td></td><td></td><td></td><td><code>update()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Cell&lt;T&gt;</code><br><code>where T: ?Sized</code></td><td><code>from_mut()</code></td><td></td><td><code>as_ptr()</code></td><td><strong><code>get_mut()</code></strong></td></tr><tr><td><code>impl&lt;T&gt; Cell&lt;T&gt;</code><br><code>where T: Default</code></td><td></td><td></td><td><strong><code>take()</code></strong></td><td></td></tr><tr><td><em>Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Clone for Cell&lt;T&gt;</code><br><code>where T: Copy</code></td><td></td><td></td><td><code>clone()</code></td><td><code>clone_from()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for Cell&lt;T&gt;</code></td><td><code>from(T)</code></td><td></td><td></td><td></td></tr><tr><td><em>Auto Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Blanket Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><code>to_owned()</code></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cellrefcell\">cell::RefCell<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#cellrefcell\" class=\"hash-link\" aria-label=\"Direct link to cell::RefCell\" title=\"Direct link to cell::RefCell\">​</a></h3>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><em>Methods</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; RefCell&lt;T&gt;</code></td><td><code>new(T)</code></td><td><code>into_inner()</code></td><td><code>replace()</code></td><td></td></tr><tr><td></td><td></td><td></td><td><code>replace_with()</code></td><td></td></tr><tr><td></td><td></td><td></td><td><code>swap()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; RefCell&lt;T&gt;</code><br><code>where T: ?Sized</code></td><td></td><td></td><td><strong><code>borrow()</code></strong></td><td><code>get_mut()</code></td></tr><tr><td></td><td></td><td></td><td><code>try_borrow()</code></td><td><code>undo_leak()</code></td></tr><tr><td></td><td></td><td></td><td><strong><code>borrow_mut()</code></strong></td><td></td></tr><tr><td></td><td></td><td></td><td><code>try_borrow_mut()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; RefCell&lt;T&gt;</code><br><code>where T: Default</code></td><td></td><td></td><td><code>take()</code></td><td></td></tr><tr><td><em>Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Clone for RefCell&lt;T&gt;</code><br><code>where T: Clone</code></td><td></td><td></td><td><code>clone()</code></td><td><code>clone_from()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for Cell&lt;T&gt;</code></td><td><code>from(T)</code></td><td></td><td></td><td></td></tr><tr><td><em>Auto Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Blanket Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; Into&lt;U&gt; for T</code></td><td></td><td><code>into()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><code>to_owned()</code></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"vec\">vec<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#vec\" class=\"hash-link\" aria-label=\"Direct link to vec\" title=\"Direct link to vec\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"vecvec\">vec::Vec<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#vecvec\" class=\"hash-link\" aria-label=\"Direct link to vec::Vec\" title=\"Direct link to vec::Vec\">​</a></h3>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><em>Methods</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Vec&lt;T, Global&gt;</code></td><td><code>new()</code></td><td></td><td></td><td></td></tr><tr><td></td><td><code>with_capacity()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, A&gt; Vec&lt;T, A&gt;</code></td><td><code>new_in(A)</code></td><td></td><td><code>capacity()</code></td><td><code>reserve()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>try_reserve()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>shrink_to_fit()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>shrink_to()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>truncate()</code></td></tr><tr><td></td><td></td><td><code>into_boxed_slice()</code></td><td><code>as_slice()</code></td><td><code>as_mut_slice()</code></td></tr><tr><td></td><td></td><td></td><td><code>as_ptr()</code></td><td><code>as_mut_ptr()</code></td></tr><tr><td></td><td></td><td></td><td><strong><code>len()</code></strong></td><td><strong><code>insert()</code></strong></td></tr><tr><td></td><td></td><td></td><td><code>is_empty()</code></td><td><strong><code>remove()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><code>retain()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>push()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>pop()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>append()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>drain()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><code>clear()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>split_off()</code></td></tr><tr><td><code>impl&lt;T, A&gt; Vec&lt;T, A&gt;</code><br><code>where T:Clone</code></td><td></td><td></td><td></td><td><code>resize()</code></td></tr><tr><td><code>impl&lt;T, A&gt; Vec&lt;T, A&gt;</code><br><code>where A:Allocator</code></td><td></td><td></td><td></td><td><code>splice()</code></td></tr><tr><td><em><code>Deref&lt;Target = [T]&gt;</code></em> <br>自动解引用</td><td></td><td></td><td><code>**</code>len()<code>**</code></td><td></td></tr><tr><td></td><td>（略）</td><td>（略）</td><td>（略）</td><td>（略）</td></tr><tr><td><em>Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, A&gt; AsMut&lt;[T]&gt; for Vec&lt;T, A&gt;</code></td><td></td><td></td><td></td><td><code>as_mut()</code></td></tr><tr><td><code>impl&lt;T, A&gt; AsRef&lt;[T]&gt; for Vec&lt;T, A&gt;</code></td><td></td><td></td><td><code>as_ref()</code></td><td></td></tr><tr><td><code>impl&lt;T, A&gt; Clone for Vec&lt;T, A&gt;</code></td><td></td><td></td><td><code>clone()</code></td><td><code>clone_from()</code></td></tr><tr><td><code>impl&lt;T, A&gt; Deref for Vec&lt;T, A&gt;</code></td><td></td><td></td><td><code>deref()</code> 手工解引用</td><td></td></tr><tr><td><code>impl&lt;T, A&gt; DerefMut for Vec&lt;T, A&gt;</code></td><td></td><td></td><td></td><td><code>deref_mut()</code></td></tr><tr><td><code>impl&lt;T, A&gt; Drop for Vec&lt;T, A&gt;</code></td><td></td><td></td><td></td><td><code>drop()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;XXX&gt; for Vec&lt;T, Global&gt;</code></td><td><code>from(XXX)</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; From&lt;Vec&lt;XXX&gt;&gt; for YYY</code></td><td><code>from(&lt;Vec&lt;XXX&gt;&gt;)</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, A&gt; Hash for Vec&lt;T, A&gt;</code></td><td></td><td><code>hash()</code></td><td></td><td></td></tr><tr><td></td><td></td><td><code>hash_slice()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;'a, T, A&gt; Extend&lt;&amp;'a T&gt; for Vec&lt;T, A&gt;</code></td><td></td><td></td><td></td><td><strong><code>extend()</code></strong></td></tr><tr><td><em>Auto Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Blanket Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; Into&lt;U&gt; for T</code></td><td></td><td><code>into()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><code>to_owned()</code></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"collections\">collections<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#collections\" class=\"hash-link\" aria-label=\"Direct link to collections\" title=\"Direct link to collections\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"collectionsbtreemap\">collections::BTreeMap<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#collectionsbtreemap\" class=\"hash-link\" aria-label=\"Direct link to collections::BTreeMap\" title=\"Direct link to collections::BTreeMap\">​</a></h3>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><em>Methods</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;K, V&gt; BTreeMap&lt;K, V, Global&gt;</code></td><td><code>new()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;K, V, A&gt; BTreeMap&lt;K, V, A&gt;</code></td><td></td><td><code>into_keys()</code></td><td><strong><code>get()</code></strong></td><td><code>clear()</code></td></tr><tr><td></td><td></td><td></td><td><code>get_key_value()</code></td><td><code>pop_first()</code></td></tr><tr><td></td><td></td><td></td><td><code>first_key_value()</code></td><td><code>first_entry()</code></td></tr><tr><td></td><td></td><td></td><td><code>last_key_value()</code></td><td><code>last_entry()</code></td></tr><tr><td></td><td></td><td></td><td><code>contains_key()</code></td><td><code>pop_last()</code></td></tr><tr><td></td><td></td><td></td><td><strong><code>len()</code></strong></td><td><code>get_mut()</code></td></tr><tr><td></td><td></td><td></td><td><code>is_empyt()</code></td><td><strong><code>insert()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>remove()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><code>retain()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>append()</code></td></tr><tr><td></td><td></td><td><code>range()</code></td><td></td><td><code>range_mut()</code></td></tr><tr><td></td><td></td><td></td><td><code>keys()</code></td><td><strong><code>entry()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><code>split_off()</code></td></tr><tr><td></td><td></td><td></td><td><strong><code>iter()</code></strong></td><td><strong><code>iter_mut()</code></strong></td></tr><tr><td></td><td></td><td></td><td><code>values()</code></td><td><code>values_mut()</code></td></tr><tr><td><em>Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;K, V, A&gt; Clone for BTreeMap&lt;K, V, A&gt;</code></td><td></td><td></td><td><code>clone()</code></td><td></td></tr><tr><td><code>impl&lt;K, V, A&gt; Extend&lt;(K, V)&gt; for BTreeMap&lt;K, V, A&gt;</code></td><td></td><td></td><td></td><td><code>extend()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>extend_one()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>extend_reserve()</code></td></tr><tr><td><code>impl ... From&lt;..&gt; for HashMap&lt;..&gt;</code></td><td><code>from(arr: [(K, V); N])</code></td><td></td><td></td><td></td></tr><tr><td><em>Auto Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Blanket Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; Into&lt;U&gt; for T</code></td><td></td><td><code>into()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><code>to_owned()</code></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"collectionshashmap\">collections::HashMap<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#collectionshashmap\" class=\"hash-link\" aria-label=\"Direct link to collections::HashMap\" title=\"Direct link to collections::HashMap\">​</a></h3>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><em>Methods</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;K, V&gt; HashMap&lt;K, V, RandomState&gt;</code></td><td><code>new()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;K, V, S&gt; HashMap&lt;K, V, S&gt;</code></td><td></td><td><code>capacity()</code></td><td></td><td></td></tr><tr><td></td><td></td><td><strong><code>keys()</code></strong></td><td><strong><code>values()</code></strong></td><td><code>values_mut()</code></td></tr><tr><td></td><td></td><td><code>into_keys()</code></td><td><strong><code>is_empty()</code></strong></td><td><code>drain()</code></td></tr><tr><td></td><td></td><td><code>into_values()</code></td><td><code>len()</code></td><td><code>drain_filter()</code></td></tr><tr><td></td><td></td><td></td><td><strong><code>iter()</code></strong></td><td><strong><code>iter_mut()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><code>retain()</code></td></tr><tr><td></td><td></td><td></td><td><code>hasher()</code></td><td><strong><code>clear()</code></strong></td></tr><tr><td><code>impl&lt;K, V, S&gt; HashMap&lt;K, V, S&gt;</code></td><td></td><td></td><td></td><td><code>reserve()</code></td></tr><tr><td></td><td></td><td></td><td><code>get_key_value()</code></td><td><code>shrink_to_fit()</code></td></tr><tr><td></td><td></td><td></td><td><code>contains_key()</code></td><td><code>shrink_to()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>entry()</code></strong></td></tr><tr><td></td><td></td><td></td><td><strong><code>get()</code></strong></td><td><strong><code>get_mut()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>insert()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>remove()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>remove_entry()</code></strong></td></tr><tr><td><em>Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;K, V, A&gt; Clone for HashMap&lt;K, V, A&gt;</code></td><td></td><td></td><td><code>clone()</code></td><td></td></tr><tr><td><code>impl&lt;K, V, A&gt; Extend&lt;(K, V)&gt; for HashMap&lt;K, V, A&gt;</code></td><td></td><td></td><td></td><td><code>extend()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>extend_one()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><code>extend_reserve()</code></td></tr><tr><td><code>impl ... From&lt;..&gt; for HashMap&lt;..&gt;</code></td><td><code>from(arr: [(K, V); N])</code></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Auto Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Blanket Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; Into&lt;U&gt; for T</code></td><td></td><td><code>into()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><code>to_owned()</code></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"boxed\">boxed<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#boxed\" class=\"hash-link\" aria-label=\"Direct link to boxed\" title=\"Direct link to boxed\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"boxedbox\">boxed::Box<a href=\"https://wkevin.github.io/blog/2024/03/14/rust.methods#boxedbox\" class=\"hash-link\" aria-label=\"Direct link to boxed::Box\" title=\"Direct link to boxed::Box\">​</a></h3>\n<table><thead><tr><th>impl</th><th><code>(..)</code></th><th><code>(self..)</code></th><th><code>(&amp;self..)</code></th><th><code>(&amp;mut self..)</code></th></tr></thead><tbody><tr><td><em>Methods</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Box&lt;T, Global&gt;</code></td><td><code>new(T)</code></td><td></td><td></td><td></td></tr><tr><td></td><td><strong><code>pin(T)</code></strong></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Box&lt;T, Global&gt;</code></td><td><code>from_raw(T)</code></td><td></td><td></td><td></td></tr><tr><td></td><td><code>into_raw()</code></td><td></td><td></td><td></td></tr><tr><td></td><td><strong><code>leak()</code></strong></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;A&gt; Box&lt;dyn Any + 'static, A&gt;</code></td><td></td><td><strong><code>downcast()</code></strong></td><td></td><td></td></tr><tr><td><em>Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, A&gt; Borrow&lt;T&gt; for Box&lt;T, A&gt;</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T, A&gt; BorrowMut&lt;T&gt; for Box&lt;T, A&gt;</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;B: BufRead + ?Sized&gt; BufRead for Box&lt;B&gt;</code></td><td></td><td><strong><code>split()</code></strong></td><td></td><td><code>fill_buf()</code></td></tr><tr><td></td><td></td><td><code>line()</code></td><td></td><td><code>consume()</code></td></tr><tr><td></td><td></td><td></td><td></td><td><strong><code>read_until()</code></strong></td></tr><tr><td></td><td></td><td></td><td></td><td><code>read_line()</code></td></tr><tr><td><code>impl ... From&lt;XXX&gt; for Box&lt;..&gt;</code></td><td><code>from(XXX)</code></td><td></td><td></td><td></td></tr><tr><td><code>impl ... From&lt;Box&lt;XXX&gt;&gt; for xxx</code></td><td><code>from(Box&lt;XXX&gt;)</code></td><td></td><td></td><td></td></tr><tr><td><em>Auto Trait Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><em>Blanket Implementations</em></td><td></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; Any for T</code></td><td></td><td></td><td><code>type_id()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; Borrow&lt;T&gt; for T</code></td><td></td><td></td><td><code>borrow()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; BorrowMut&lt;T&gt; for T</code></td><td></td><td></td><td></td><td><code>borrow_mut()</code></td></tr><tr><td><code>impl&lt;T&gt; From&lt;T&gt; for T</code></td><td><code>from()</code></td><td></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; Into&lt;U&gt; for T</code></td><td></td><td><code>into()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;F&gt; IntoFuture for F</code></td><td></td><td><code>into_future()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToOwned for T</code></td><td></td><td></td><td><code>to_owned()</code></td><td></td></tr><tr><td><code>impl&lt;T&gt; ToString for T</code></td><td></td><td><code>to_string()</code></td><td></td><td></td></tr><tr><td><code>impl&lt;T, U&gt; TryFrom&lt;U&gt; for T</code></td><td><code>try_from()</code></td><td></td><td></td><td></td></tr></tbody></table>",
            "url": "https://wkevin.github.io/blog/2024/03/14/rust.methods",
            "title": "rust 常用类型方法分组整理",
            "summary": "rust.methods",
            "date_modified": "2024-03-14T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "rust",
                "methods"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2024/03/01/rust.cow",
            "content_html": "<p>std::borrow::Cow 是个枚举，包含 2 个变体（rust 中枚举的元素称为 Variant，变体）Borrowed、Owned，一般理解为代表对资源、数据的两种状态：借用、拥有所有权。</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">pub</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">enum</span><span class=\"token plain\"> </span><span class=\"token type-definition class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token class-name\">B</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">where</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token class-name\">B</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token class-name\">ToOwned</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">?</span><span class=\"token class-name\">Sized</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token plain\"> </span><span class=\"token class-name\">B</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> </span><span class=\"token class-name\">ToOwned</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>两种状态，比较难理解，其实是从使用用途来说的，具体到代码中后面会看到并不难理解。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"创建\">创建<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E5%88%9B%E5%BB%BA\" class=\"hash-link\" aria-label=\"Direct link to 创建\" title=\"Direct link to 创建\">​</a></h2>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> st </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> sg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">String</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"直接创建\">直接创建<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E7%9B%B4%E6%8E%A5%E5%88%9B%E5%BB%BA\" class=\"hash-link\" aria-label=\"Direct link to 直接创建\" title=\"Direct link to 直接创建\">​</a></h3>\n<p>我们可以像通用的枚举使用方式一样，分别创建：</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> b_st </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">st</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Borrowed 的绑定值是 <code>&amp;</code> 引用类型的， <code>&amp;str</code> 类型的满足要求，此时泛型类型 <code>B</code> 是 <code>str</code>，从定义上看 B 需要满足 <code>ToOwned</code>，str 也是满足的。</p>\n<p>其他类型的就要添加 <code>&amp;</code>：</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> b_sg_p </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token plain\">sg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>Owned 变量的创建：</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> o_st</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'_</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">str</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">st</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>此时泛型类型 <code>B</code> 是 <code>&amp;str</code>，和上面的 Borrowed 是不同的，并且上面显式给出了类型说明 <code>Cow&lt;'_, &amp;str&gt;</code>，而前面 Borrowed 的 <code>b_st</code> 的类型是 <code>Cow&lt;'_, str&gt;</code>，两种是不同的。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"用-from-创建\">用 from 创建<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E7%94%A8-from-%E5%88%9B%E5%BB%BA\" class=\"hash-link\" aria-label=\"Direct link to 用 from 创建\" title=\"Direct link to 用 from 创建\">​</a></h3>\n<p>不同的 from() 得到不同的 Borrowed、Owned，如：</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> f_st </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">st</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>会使用如下定义</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">-&gt;</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">str</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>所以 <code>f_st</code> 的类型是 <code>Cow&lt;'a, str&gt;::Borrowed(\"foobar\")</code>。</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> f_sg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>会使用</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token class-name\">String</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">-&gt;</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">str</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>所以 <code>f_sg</code> 的类型是 <code>Cow&lt;'a, str&gt;::Owned(\"foobar\")</code>。</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> f_sg_p </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token plain\">sg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>会使用</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token plain\"> </span><span class=\"token class-name\">String</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">-&gt;</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'a</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">str</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">as_str</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>所以 <code>f_sg_p</code> 的类型是 <code>Borrowed(\"foobar\")</code>。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"总结\">总结<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E6%80%BB%E7%BB%93\" class=\"hash-link\" aria-label=\"Direct link to 总结\" title=\"Direct link to 总结\">​</a></h3>\n<p>from(入参) 入参是引用类型，创建出来的是 Borrowed；入参不是引用类型，创建出来 Owned。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"方法\">方法<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E6%96%B9%E6%B3%95\" class=\"hash-link\" aria-label=\"Direct link to 方法\" title=\"Direct link to 方法\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"to_ownedself-和-into_ownedself\"><code>to_owned(&amp;self)</code> 和 <code>into_owned(self)</code><a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#to_ownedself-%E5%92%8C-into_ownedself\" class=\"hash-link\" aria-label=\"Direct link to to_ownedself-和-into_ownedself\" title=\"Direct link to to_ownedself-和-into_ownedself\">​</a></h3>\n<p>定义分别是：</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">to_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">-&gt;</span><span class=\"token plain\"> </span><span class=\"token class-name\">T</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">clone</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">into_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">-&gt;</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> </span><span class=\"token class-name\">ToOwned</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">match</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">to_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">owned</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> owned</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>所以不管是 Borrowed 还是 Owned ，<code>to_owned</code> 都会做 clone 操作。</li>\n<li>rust 很多类型都有 <code>to_owned(&amp;self)</code>，都是对原值的不可变引用做数据复制，并给出有所有权的新数据。但 rust 只有 Cow 有 <code>into_owned(self)</code></li>\n<li><code>into_owned(self)</code> 是对 self 的所有权转移，所以执行本方法后 self 就无法继续使用了。<!-- -->\n<ul>\n<li>Borrowed 类型的变量会先做数据的 to_owned，borrowed 数据类型不同，to_owned 是不同方法，如：<!-- -->\n<ul>\n<li>borrowed 是 str，则调用 <code>fn to_owned(&amp;self) -&gt; String</code>，返回 String，并且数据已 clone；</li>\n<li>borrowed 是 String，则调用 <code>fn to_owned(&amp;self) -&gt; T</code>，返回 String</li>\n<li>borrowed 是 Cow::Borrowed，则调用上面的 <code>fn to_owned(&amp;self) -&gt; T</code>，即 <code>clone()</code></li>\n</ul>\n</li>\n<li>Owned 类型的变量则直接返回数据的引用（owned）。</li>\n</ul>\n</li>\n</ul>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> b </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// b type: Cow&lt;'_, str&gt;::Borrowed()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> bto </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">to_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// bto 与 b type 相同: Cow&lt;'_, str&gt;::Borrowed()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> bio </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">into_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// bio type：String，因为 str::to_owned() 返回 String</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token macro property\" style=\"color:#36acaa\">assert_eq!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">bio</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token class-name\">String</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">make_ascii_uppercase</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token macro property\" style=\"color:#36acaa\">assert_eq!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">bio</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token class-name\">String</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"FOOBAR\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> o</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'_</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">str</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> oto </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> o</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">to_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// oto 与 o type 相同： Cow&lt;'_, &amp;str&gt;::Owned()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> oio </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> o</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">into_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// oio type: &amp;str -- Owned 直接返回，不做 to_owned，所以还是 str，不是 String</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token macro property\" style=\"color:#36acaa\">assert_eq!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">oio</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"to_mutmut-self\"><code>to_mut(&amp;mut self)</code><a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#to_mutmut-self\" class=\"hash-link\" aria-label=\"Direct link to to_mutmut-self\" title=\"Direct link to to_mutmut-self\">​</a></h3>\n<p><code>to_mut()</code> 实现了不越权（遇到 Borrowed 先 clone，然后把 self owned 到新数据）的返回数据的可变引用，修改后原 Cow 变量如果是 Borrowed 则不影响（因为 clone 了），如果 Owned 则影响。</p>\n<p>方法定义和实现也很直白：</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">pub</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">to_mut</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">-&gt;</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token class-name\">B</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> </span><span class=\"token class-name\">ToOwned</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">match</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">to_owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">match</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token keyword\" style=\"color:#00009f\">self</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                </span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">..</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token macro property\" style=\"color:#36acaa\">unreachable!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                </span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">ref</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> owned</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> owned</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">ref</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> owned</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> owned</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>该函数做可变借用，不转移所有权。</li>\n<li>Owned 变量返回可</li>\n<li>Borrowed 变量把 self 指向新数据的 Owned 类型</li>\n</ul>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> sg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">String</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> mb </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token plain\">sg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> mbtm </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> mb</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">to_mut</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// to_mut() 之后：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// mb 作为 self 也被指向了 clone 后的新数据，并变为 Owned</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// mb 变成了 owned 新数据 Owned 变量，和 sg 已解耦</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// mbtm 类型：String</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// mbtm 是 mb 内层数据的可变引用</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">mbtm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">make_ascii_uppercase</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// mbtm 是 mb 的可变借用，所以 mbtm 先 drop 后，mb 才能继续使用</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token macro property\" style=\"color:#36acaa\">println!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"{}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> mbtm</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 此行后 mbtm drop</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token macro property\" style=\"color:#36acaa\">println!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"{}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> mb</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// FOOBAR</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// FOOBAR</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>从打印可见：mb 和 mbtm 都被修改为大写的 FOOBAR。Owned 同理，也会同步修改。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"总结-1\">总结<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E6%80%BB%E7%BB%93-1\" class=\"hash-link\" aria-label=\"Direct link to 总结\" title=\"Direct link to 总结\">​</a></h3>\n<table><thead><tr><th>方法</th><th>入参</th><th>返回值</th><th>原理</th><th>使用场景</th><th>备注</th></tr></thead><tbody><tr><td><code>to_owned(&amp;self)</code></td><td>不可变借用</td><td>返回有所有权的复制后的新数据，类型不变（还是 Cow）</td><td>clone 新数据，与原变量解耦，所以用不可变借用（不想修改原值，复制完就解耦了）</td><td>需要有所有权的数据，赋值原数据后各自发展</td><td>不光 Cow 有，其他很多类型都有，模式都是统一的。</td></tr><tr><td><code>into_owned(self)</code></td><td>所有权转移</td><td>返回有所有权的（内层、原始）数据（类型不是 Cow）</td><td>Borrowed 先对内层数据做 to_owned（clone），Owned 直接返回</td><td>修改 Cow 中数据，拿到所有权不退</td><td>Cow 独有，into 理解为剥去 Cow 封装，对原始数据做 to_owned。</td></tr><tr><td><code>to_mut(&amp;mut self)</code></td><td>可变借用</td><td>返回（内层、原始）数据的可变引用（类型不是 Cow）</td><td>Borrowed 先对内层数据做 to_owned（clone） 并封装成 Owned，相比 <code>into_owned()</code>，此方法修改了 self</td><td>修改 Cow 中数据，不影响 Cow 变量</td><td>Cow 独有，其他类型多为 <code>into_mut(self)</code> 或 <code>as_mut(self)</code>。</td></tr></tbody></table>\n<blockquote>\n<p><code>into_owned(self)</code> 对 Borrowed 做 into_owned 似乎不公平，复制了原变量数据，同时还让原变量失效了</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"应用\">应用<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E5%BA%94%E7%94%A8\" class=\"hash-link\" aria-label=\"Direct link to 应用\" title=\"Direct link to 应用\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"写时复制\">写时复制<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6\" class=\"hash-link\" aria-label=\"Direct link to 写时复制\" title=\"Direct link to 写时复制\">​</a></h3>\n<p>官方给的 2 个例子，都演示了<strong>如何使用 to_mut() 让 Cow 在读多写少时，按需 clone 数据</strong></p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">abs_all</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">input</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'_</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token keyword\" style=\"color:#00009f\">i32</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">..</span><span class=\"token plain\">input</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">len</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> v </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> input</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> v </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// to_mut()： 遇到 Borrowed 先 Clone，遇到 Owned 不 Clone</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            input</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">to_mut</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">v</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> slice </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> input </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token plain\">slice</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">..</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// input 类型： Cow&lt;'_, [i32]&gt;::Borrowed()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">abs_all</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> input</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 不执行 to_mut()，所以 input 与 slice 没分身</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> slice </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> input </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token plain\">slice</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">..</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// input 类型： Cow&lt;'_, [i32]&gt;::Borrowed()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">abs_all</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> input</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 执行了 to_mut()吗，所以 input 与 slice 分身了</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> input </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token function\" style=\"color:#d73a49\">from</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token macro property\" style=\"color:#36acaa\">vec!</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// input 类型：Owned</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">abs_all</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">mut</span><span class=\"token plain\"> input</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 执行了 to_mut()吗，但对应 Onwed 不做 clone</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>上面例子演示了对数组或切片取绝对值的操作，想达到的效果是：假如包含负数的数组是少数（例子中 3 个数组有 2 个，给人感觉反了），那么调用 <code>abs_all</code> 应该对大多数的没有负数的数组不做数据复制操作，而仅对少数有负数的数组做复制，并修改。</p>\n<p>最终达到了：有所有权的立即修改、没所有权的写时复制修改。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"统一函数入参\">统一函数入参<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E7%BB%9F%E4%B8%80%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%82\" class=\"hash-link\" aria-label=\"Direct link to 统一函数入参\" title=\"Direct link to 统一函数入参\">​</a></h3>\n<p>Cow 还有另外一个作用，一个函数入参可包含借用或所有权转移，这样设计函数的时候有更好的兼容性。</p>\n<p>比如</p>\n<div class=\"language-cpp codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-cpp codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">fn </span><span class=\"token function\" style=\"color:#d73a49\">foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> i32</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    println</span><span class=\"token operator\" style=\"color:#393A34\">!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"{}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">fn </span><span class=\"token function\" style=\"color:#d73a49\">bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token plain\">i32</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    println</span><span class=\"token operator\" style=\"color:#393A34\">!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"{}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如何整合这 2 个函数？难道：</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">i32</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token keyword\" style=\"color:#00009f\">i32</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token punctuation\" style=\"color:#393A34\">...</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样 2 个入参对函数内部实现也造成混乱。</p>\n<div class=\"language-rust codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-rust codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">fn</span><span class=\"token plain\"> </span><span class=\"token function-definition function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token class-name\">Cow</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token lifetime-annotation symbol\" style=\"color:#36acaa\">'_</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">i32</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">match</span><span class=\"token plain\"> s </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token macro property\" style=\"color:#36acaa\">println!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"{}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token macro property\" style=\"color:#36acaa\">println!</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"{}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> s</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Borrowed</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token number\" style=\"color:#36acaa\">123</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token class-name\">Cow</span><span class=\"token punctuation\" style=\"color:#393A34\">::</span><span class=\"token class-name\">Owned</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">123</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样就漂亮的解决了问题。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"总结-2\">总结<a href=\"https://wkevin.github.io/blog/2024/03/01/rust.cow#%E6%80%BB%E7%BB%93-2\" class=\"hash-link\" aria-label=\"Direct link to 总结\" title=\"Direct link to 总结\">​</a></h3>\n<ol>\n<li>创建成 Borrowed 还是 Owned 并不重要，只需注意所有权要不要移交。</li>\n<li>用 Cow 封装后，一个类型传递更方便。</li>\n<li>需要修改被 Cow 封装的数据时，使用 <code>into_owned</code> 或 <code>to_mut</code> 取出数据，前者拿走所有权修改数据，后者通过可变借用修改数据。此时如果是 Borrowed 则先复制数据（即：写时复制）。</li>\n<li>写时复制——仅针对 Borrowed，不发生在 Owned。</li>\n</ol>",
            "url": "https://wkevin.github.io/blog/2024/03/01/rust.cow",
            "title": "rust Cow 类型的使用",
            "summary": "how to use rust Cow",
            "date_modified": "2024-03-01T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "rust",
                "Cow"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2024/01/31/rust.str.and.string",
            "content_html": "<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/rust_str_String-baf0cd0a30c2a583d654ae7de2f3b4d2.svg\" width=\"1500\" height=\"1497\" class=\"img_ev3q\"></p>\n<ul>\n<li>白色线条是创建内建类型： <code>str</code> 或 <code>&amp;str</code></li>\n<li>红色线条是创建标准库 struct： <code>std::string::String</code></li>\n<li>绿色线条是其他关联关系</li>\n</ul>\n<p>主要是为了梳理 <code>str</code> 和 <code>String</code> 如何初始化，以及有哪些方法能够互相转化。</p>\n<p>还有很多方法能够互相转化，但梳理到这里感觉都懂了，剩下的看看文档就没问题了，就不往图上整理了。</p>\n<p>最后整理了几种字符串拼接的方式。</p>",
            "url": "https://wkevin.github.io/blog/2024/01/31/rust.str.and.string",
            "title": "rust 字符串",
            "summary": "rust.str.and.string",
            "date_modified": "2024-01-31T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "rust",
                "str",
                "string"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2024/01/21/rust.fix.size.type",
            "content_html": "<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/rust_fix_size_type-e52e09a71586dbcb80b9c3537ac0af71.svg\" width=\"1723\" height=\"2060\" class=\"img_ev3q\"></p>\n<p>rust 类型有固定 size 和动态 size 的，比如 <code>str</code> 就是动态 size，本篇先梳理固定 size 的。</p>\n<p>只是捡了一些我个人关心、与 C、python、go 有差异的点来记录，跟完整记录差得远。</p>\n<p>rust 的 struct 和 enum 都挺有意思的，struct 的静态和实例方法、enum 的捆绑数据……都是特色。</p>",
            "url": "https://wkevin.github.io/blog/2024/01/21/rust.fix.size.type",
            "title": "rust 固定 size 类型",
            "summary": "rust.fix.size.type",
            "date_modified": "2024-01-21T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "rust",
                "type"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2023/11/21/python3.12",
            "content_html": "<p><strong>摘要：</strong></p>\n<p>python3.12 与 2023.10 发布正式版：3.12.0，开始进入生产阶段的生命周期。</p>\n<p>本文从 jupyter 导出，每段代码后面跟随的是代码的执行结果。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"环境搭建\">环境搭建<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\" class=\"hash-link\" aria-label=\"Direct link to 环境搭建\" title=\"Direct link to 环境搭建\">​</a></h2>\n<ol>\n<li>安装 python（下面方法 2 选 1）<!-- -->\n<ol>\n<li>pyenv &amp; venv<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pyenv install 3.12.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pyenv versions</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pyenv shell 3.12.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python -V</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python -m venv venv312</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ source venv312/bin/activate</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>docker<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># 替换其中的 `&lt;my_code&gt;` 为自己代码所在位置</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ docker run -it -d --name py312 -p 8888:8888 -v &lt;my_code&gt;:/src python:3.12</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ docker exec -it py312 bash</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n</ol>\n</li>\n<li>安装 jupyter（下面方法 2 选 1） —— 可选<!-- -->\n<ol>\n<li>jupyter lab/notebook on browser<!-- -->\n<ul>\n<li><code>pip install jupyter</code></li>\n<li><code>pip install nb_mypy black isort jupyterlab-code-formatter jupyter-black</code> —— 可选</li>\n<li><code>jupyter lab --allow-root --no-browser --ip=0.0.0.0</code> or <code>jupyter notebook --allow-root --no-browser --ip=0.0.0.0</code></li>\n<li>使用带有 token 的链接打开浏览器</li>\n<li>配置：Settings -- Settings Editor<!-- -->\n<ul>\n<li>jupyterlab-code-formatter -- （拉到最下面）-- Auto format config -- 勾选</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>jupyter notebook on VSCode<!-- -->\n<ul>\n<li>安装 VSCode Jupyter 扩展</li>\n<li>F1 - select interpreter - 选择 python venv —— 这样在 jupyter 中 kernel 才能被看到</li>\n<li>打开 ipynb 文件，右上角选择解释器</li>\n</ul>\n</li>\n</ol>\n</li>\n</ol>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-684-解析器级-gil\">PEP 684: 解析器级 GIL<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#pep-684-%E8%A7%A3%E6%9E%90%E5%99%A8%E7%BA%A7-gil\" class=\"hash-link\" aria-label=\"Direct link to PEP 684: 解析器级 GIL\" title=\"Direct link to PEP 684: 解析器级 GIL\">​</a></h2>\n<p>从 1997 年的 python v1.5 开始，可以在一个进程中运行多个解释器，但这些解释器共用一个 GIL（全局进程锁），所以虽然多线程，但其实是单线程。</p>\n<p>26 年之后，python3.12 终于从进程级 GIL 改为解释器级 GIL：<a href=\"https://peps.python.org/pep-0684/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 684 – A Per-Interpreter GIL</a></p>\n<p>每个解释器可以创建自己独立的 GIL：</p>\n<ul>\n<li>一个解释器上的多线程仍然共用一个 GIL</li>\n<li>多个解释器上的多线程使用各自的 GIL</li>\n</ul>\n<p>API 预计将在 3.13 中添加: <a href=\"https://peps.python.org/pep-0554/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 554 – Multiple Interpreters in the Stdlib</a></p>\n<ul>\n<li>新增 <code>interpreters</code> 模块</li>\n<li>新增 <code>class conCurent.futures.InterpreterPoolExecutor</code></li>\n</ul>\n<p>Demo:</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> interpreters</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">interp </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> interpreters</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    interp</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">exec</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'print(\"during\")'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">t </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> threading</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Thread</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">target</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">start</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">join</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-701f-字符串语法改进\">PEP 701：f-字符串语法改进<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#pep-701f-%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%AF%AD%E6%B3%95%E6%94%B9%E8%BF%9B\" class=\"hash-link\" aria-label=\"Direct link to PEP 701：f-字符串语法改进\" title=\"Direct link to PEP 701：f-字符串语法改进\">​</a></h2>\n<ul>\n<li>python3.6 首次引入了 f 字符串语法：<a href=\"https://peps.python.org/pep-0498/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 498 – Literal String Interpolation</a></li>\n<li>python3.7 中做了一些优化：<a href=\"https://peps.python.org/pep-0536/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 536 – Final Grammar for Literal String Interpolation</a></li>\n<li>python3.12 中做个更多的优化，主要是放弃了一些写法限制：<a href=\"https://peps.python.org/pep-0701/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 701 – Syntactic formalization of f-strings</a></li>\n</ul>\n<p>允许在表达式部分中使用引号字符（引号重用）</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">facebook </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">'Tom'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'Jerry'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">90</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Bloto\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">30</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f'Tom score: { facebook['</span><span class=\"token plain\">Tom</span><span class=\"token string\" style=\"color:#e3116c\">'] }'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Jerry score: { facebook[\"</span><span class=\"token plain\">Jerry</span><span class=\"token string\" style=\"color:#e3116c\">\"] }\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Bloto score: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\"> facebook</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">[</span><span class=\"token string-interpolation interpolation string\" style=\"color:#e3116c\">'Bloto'</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">]</span><span class=\"token string-interpolation interpolation\"> </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># print(f'Tom score: { facebook[\\'Tom\\'] }') # python3.12 之前 禁止 f 中转义字符</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>Tom score: 60<br>\n<!-- -->Jerry score: 90<br>\n<!-- -->Bloto score: 30</p>\n</blockquote>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">songs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"Take me back to Eden\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Alkaline\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Ascensionism\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"This is the playlist: {\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\".join(songs)}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># py3.12 之前可以这样实现：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"This is the playlist: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation string\" style=\"color:#e3116c\">', '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">join</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">songs</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 不同的引号</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"\"\"This is the playlist: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation string\" style=\"color:#e3116c\">', '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">join</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">songs</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 不同优先级的引号做嵌套</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>This is the playlist: Take me back to Eden, Alkaline, Ascensionism<br>\n<!-- -->This is the playlist: Take me back to Eden, Alkaline, Ascensionism<br>\n<!-- -->This is the playlist: Take me back to Eden, Alkaline, Ascensionism</p>\n</blockquote>\n<p>允许写 \\ 字符</p>\n<ul>\n<li>Unicode 字符：<code>\\N{...}</code>\n<ul>\n<li><a href=\"https://unicodeplus.com/\" target=\"_blank\" rel=\"noopener noreferrer\">这里</a> 有各种语言对应的编码</li>\n</ul>\n</li>\n<li>转义字符：<code>\\r</code>、<code>\\n</code>、<code>\\b</code>、<code>\\t</code>、<code>\\n</code></li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"This is the playlist: {\"</span><span class=\"token plain\"> \\N</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\">BLACK HEART SUIT</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\".join(songs)}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"\\N</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">snowman</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> \\N</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">Grinning Face</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> \\N</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">Face With Tears Of Joy</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> \\U0001F602 \"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>This is the playlist: Take me back to Eden ♥ Alkaline ♥ Ascensionism<br>\n<!-- -->☃ 😀 😂 😂</p>\n</blockquote>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"This is the playlist: {\"</span><span class=\"token plain\">\\n</span><span class=\"token string\" style=\"color:#e3116c\">\".join(songs)}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>This is the playlist: Take me back to Eden<br>\n<!-- -->Alkaline<br>\n<!-- -->Ascensionism</p>\n</blockquote>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> time </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> sleep</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">starts </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'***'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'++'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'-'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{\"</span><span class=\"token plain\">\\</span><span class=\"token string\" style=\"color:#e3116c\">r\".join(starts)}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>-+*</p>\n</blockquote>\n<p>嵌套方式更加直观，嵌套层级扩展到无限</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python3.6 开始，可以这样写嵌套，4层嵌套也是最多的了</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"\"\"{f'''</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation string-interpolation string\" style=\"color:#e3116c\">f'</span><span class=\"token string-interpolation interpolation string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation string-interpolation interpolation string-interpolation string\" style=\"color:#e3116c\">f\"</span><span class=\"token string-interpolation interpolation string-interpolation interpolation string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation string-interpolation interpolation string-interpolation interpolation number\" style=\"color:#36acaa\">1</span><span class=\"token string-interpolation interpolation string-interpolation interpolation string-interpolation interpolation operator\" style=\"color:#393A34\">+</span><span class=\"token string-interpolation interpolation string-interpolation interpolation string-interpolation interpolation number\" style=\"color:#36acaa\">1</span><span class=\"token string-interpolation interpolation string-interpolation interpolation string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation interpolation string-interpolation interpolation string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token string-interpolation interpolation string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation interpolation string-interpolation string\" style=\"color:#e3116c\">'</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">'''}\"\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>2</p>\n</blockquote>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python3.12 开始，可以这样写任意多层的嵌套了</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{f\"</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{f\"</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{f\"</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token string\" style=\"color:#e3116c\">\"}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token string\" style=\"color:#e3116c\">\"}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token string\" style=\"color:#e3116c\">\"}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{f\"</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{f\"</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{f\"</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token string\" style=\"color:#e3116c\">\"+\"</span><span class=\"token plain\">a</span><span class=\"token string\" style=\"color:#e3116c\">\"}\"</span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token string\" style=\"color:#e3116c\">\"b\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token string\" style=\"color:#e3116c\">\"+\"</span><span class=\"token plain\">c</span><span class=\"token string\" style=\"color:#e3116c\">\"}\"</span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token string\" style=\"color:#e3116c\">\"d\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token string\" style=\"color:#e3116c\">\"+\"</span><span class=\"token plain\">e</span><span class=\"token string\" style=\"color:#e3116c\">\"}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>2<br>\n<!-- -->2abcde</p>\n</blockquote>\n<p>可以定义跨越多行的 f-字符串并添加内联注释</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Flake8 error code: {\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> \"</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">join</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">'F401'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># module imported but unused</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">'F402'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># import module from line N shadowed by loop variable</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">'F403'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ‘from module import *’ used; unable to detect undefined names</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">'F404'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># future import(s) name after other statements</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>Flake8 error code: F401, F402, F403, F404</p>\n</blockquote>\n<p>可以在表达式组件中包含任何有效的 Python 表达式</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"{print(\"</span><span class=\"token plain\">abc</span><span class=\"token string\" style=\"color:#e3116c\">\")}\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>abc</p>\n</blockquote>\n<p>一些技巧</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 从 python3.6 开始，就支持 :</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"some words </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation number\" style=\"color:#36acaa\">1</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">+</span><span class=\"token string-interpolation interpolation number\" style=\"color:#36acaa\">2</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">:</span><span class=\"token string-interpolation interpolation format-spec\">.3f</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>'some words 3.000'</p>\n</blockquote>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 从 python3.8 开始，f字符串可以通过使用 = 运算符来调试表达式</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation number\" style=\"color:#36acaa\">1</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">+</span><span class=\"token string-interpolation interpolation number\" style=\"color:#36acaa\">1</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>'1+1=2'</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-669-cpython-监控器\">PEP 669: CPython 监控器<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#pep-669-cpython-%E7%9B%91%E6%8E%A7%E5%99%A8\" class=\"hash-link\" aria-label=\"Direct link to PEP 669: CPython 监控器\" title=\"Direct link to PEP 669: CPython 监控器\">​</a></h2>\n<p><a href=\"https://peps.python.org/pep-0669/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 669 – Low Impact Monitoring for CPython</a></p>\n<p><code>sys.monitoring</code> 是 sys 模块中的命名空间，而不是独立的模块，因此:</p>\n<ul>\n<li>不能：<code>import sys.monitoring</code> 或 <code>from sys import monitoring</code></li>\n<li>而是：<code>import sys</code> 后使用 <code>sys.monitoring</code></li>\n</ul>\n<p>monitoring 有 3 个组件：</p>\n<ol>\n<li>Tool identifiers</li>\n<li>Events</li>\n<li>Callbacks</li>\n</ol>\n<p>4 个 Tool, 3 个函数</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> sys</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 4 个 tool</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># sys.monitoring.DEBUGGER_ID = 0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># sys.monitoring.COVERAGE_ID = 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># sys.monitoring.PROFILER_ID = 2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># sys.monitoring.OPTIMIZER_ID = 5</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 3 个函数</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">free_tool_id</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DEBUGGER_ID</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">use_tool_id</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DEBUGGER_ID</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"foobar\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_tool</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DEBUGGER_ID</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>10: error: Module has no attribute \"monitoring\" [attr-defined]<br>\n<!-- -->ERROR:nb-mypy:10: error: Module has no attribute \"monitoring\" [attr-defined]<br>\n<!-- -->11: error: Module has no attribute \"monitoring\" [attr-defined]<br>\n<!-- -->ERROR:nb-mypy:11: error: Module has no attribute \"monitoring\" [attr-defined]<br>\n<!-- -->12: error: Module has no attribute \"monitoring\" [attr-defined]<br>\n<!-- -->ERROR:nb-mypy:12: error: Module has no attribute \"monitoring\" [attr-defined]\n'foobar'</p>\n</blockquote>\n<p>19 个 Event，6 个函数</p>\n<p>Event 分为 3 组：</p>\n<p>Local events：</p>\n<ol>\n<li><code>sys.monitoring.events.PY_START</code> —— Python 函数的开始</li>\n<li><code>sys.monitoring.events.PY_RESUME</code></li>\n<li><code>sys.monitoring.events.PY_RETURN</code> —— 从 Python 函数返回</li>\n<li><code>sys.monitoring.events.PY_YIELD</code></li>\n<li><code>sys.monitoring.events.CALL</code></li>\n<li><code>sys.monitoring.events.LINE</code> —— 即将执行的指令的行号与前一条指令不同</li>\n<li><code>sys.monitoring.events.INSTRUCTION</code></li>\n<li><code>sys.monitoring.events.JUMP</code></li>\n<li><code>sys.monitoring.events.BRANCH</code></li>\n<li><code>sys.monitoring.events.STOP_ITERATION</code></li>\n</ol>\n<p>Ancillary events</p>\n<ol>\n<li><code>sys.monitoring.events.C_RAISE</code> —— 非 python 函数抛异常</li>\n<li><code>sys.monitoring.events.C_RETURN</code></li>\n</ol>\n<p>Other events</p>\n<ol>\n<li><code>sys.monitoring.events.PY_THROW</code></li>\n<li><code>sys.monitoring.events.PY_UNWIND</code> —— 在异常展开期间退出 Python 函数</li>\n<li><code>sys.monitoring.events.RAISE</code> —— python 函数抛异常</li>\n<li><code>sys.monitoring.events.RERAISE</code></li>\n<li><code>sys.monitoring.events.EXCEPTION_HANDLED</code> —— 捕获异常</li>\n<li><code>sys.monitoring.events.NO_EVENTS</code></li>\n<li><code>sys.monitoring.DISABLE</code></li>\n</ol>\n<p>6 个函数：</p>\n<ol>\n<li><code>sys.monitoring.set_events(tool_id: int, event_set: int, /) → None</code>\n<ul>\n<li>可以或操作：<code>RAISE | PY_START</code></li>\n</ul>\n</li>\n<li><code>sys.monitoring.get_events(tool_id: int, /) → int</code></li>\n<li><code>sys.monitoring.get_local_events(tool_id: int, code: CodeType, /) → int</code></li>\n<li><code>sys.monitoring.set_local_events(tool_id: int, code: CodeType, event_set: int, /) → None</code></li>\n<li><code>sys.monitoring.restart_events() → None</code></li>\n<li><code>sys.monitoring.register_callback(tool_id: int, event: int, func: Callable | None, /) → Callable | None</code> —— 注册回调函数，不同的 Event 回调函数签名不同</li>\n</ol>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> sys</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> types </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> CodeType</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">M </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TD </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> M</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DEBUGGER_ID </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TC </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> M</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">COVERAGE_ID </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TP </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> M</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">PROFILER_ID </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TO </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> M</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">OPTIMIZER_ID </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 5</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">E </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">events</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">CounterWithDisable</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">disable </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">count </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__call__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">count  </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">count </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">disable</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DISABLE</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">tool </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TC</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">counter </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> CounterWithDisable</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">counter</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">count</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">register_callback</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tool</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> E</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">LINE</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> counter</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 注册回调</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_tool</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tool</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">not</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Tool 不能重复启用</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">free_tool_id</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tool</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">use_tool_id</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tool</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"ToolP\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 启用 Tool</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">monitoring</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">set_events</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tool</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> E</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">LINE </span><span class=\"token operator\" style=\"color:#393A34\">|</span><span class=\"token plain\"> E</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">PY_RETURN</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"events: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">sys</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">monitoring</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">get_events</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">tool</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">counter</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">count</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">counter</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">count</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>0<br>\n<!-- -->/home/me/.pyenv/versions/3.12.0/lib/python3.12/contextlib.py<br>\n<!-- -->events: 36<br>\n<!-- -->412<br>\n<!-- -->594</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-695-泛型新语法\">PEP 695: 泛型新语法<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#pep-695-%E6%B3%9B%E5%9E%8B%E6%96%B0%E8%AF%AD%E6%B3%95\" class=\"hash-link\" aria-label=\"Direct link to PEP 695: 泛型新语法\" title=\"Direct link to PEP 695: 泛型新语法\">​</a></h2>\n<p><a href=\"https://peps.python.org/pep-0695/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 695 – Type Parameter Syntax</a></p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 在此PEP之前定义泛型类如下所示</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Generic</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TypeAlias</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TypeVar</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_T_co </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"_T_co\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> covariant</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> bound</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">ClassA</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Generic</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_T_co</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">method1</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> _T_co</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_T </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"_T\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">func</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> _T</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> _T</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> _T</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ListOrSet</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> TypeAlias </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_T</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">|</span><span class=\"token plain\"> </span><span class=\"token builtin\">set</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_T</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>10: error: Incompatible return value type (got \"str\", expected \"_T_co\") [return-value]<br>\n<!-- -->ERROR:nb-mypy:10: error: Incompatible return value type (got \"str\", expected \"_T_co\") [return-value]<br>\n<!-- -->16: error: Missing return statement [empty-body]<br>\n<!-- -->ERROR:nb-mypy:16: error: Missing return statement [empty-body]</p>\n</blockquote>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 使用新的语法，它看起来如下所示</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">ClassA</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">T</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">method1</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> func</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">T</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token builtin\">type</span><span class=\"token plain\"> ListOrSet</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">T</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">T</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">|</span><span class=\"token plain\"> </span><span class=\"token builtin\">set</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">T</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>4: error: PEP 695 generics are not yet supported [valid-type]<br>\n<!-- -->ERROR:nb-mypy:4: error: PEP 695 generics are not yet supported [valid-type]<br>\n<!-- -->5: error: Missing return statement [empty-body]<br>\n<!-- -->ERROR:nb-mypy:5: error: Missing return statement [empty-body]<br>\n<!-- -->5: error: A function returning TypeVar should receive at least one argument containing the same TypeVar [type-var]<br>\n<!-- -->ERROR:nb-mypy:5: error: A function returning TypeVar should receive at least one argument containing the same TypeVar [type-var]<br>\n<!-- -->9: error: Missing return statement [empty-body]<br>\n<!-- -->ERROR:nb-mypy:9: error: Missing return statement [empty-body]<br>\n<!-- -->9: error: PEP 695 generics are not yet supported [valid-type]<br>\n<!-- -->ERROR:nb-mypy:9: error: PEP 695 generics are not yet supported [valid-type]<br>\n<!-- -->13: error: PEP 695 type aliases are not yet supported [valid-type]<br>\n<!-- -->ERROR:nb-mypy:13: error: PEP 695 type aliases are not yet supported [valid-type]</p>\n</blockquote>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"typing-模块修改\">typing 模块修改<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#typing-%E6%A8%A1%E5%9D%97%E4%BF%AE%E6%94%B9\" class=\"hash-link\" aria-label=\"Direct link to typing 模块修改\" title=\"Direct link to typing 模块修改\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-698-新增-override\">PEP 698: 新增 <code>@override()</code><a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#pep-698-%E6%96%B0%E5%A2%9E-override\" class=\"hash-link\" aria-label=\"Direct link to pep-698-新增-override\" title=\"Direct link to pep-698-新增-override\">​</a></h3>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 向类型检查器指示该方法旨在重写超类中的方法。</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 这允许类型检查器在打算重写基类中的某个方法实际上没有重写的情况下捕获错误。</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> override</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Base</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">get_color</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"blue\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">GoodChild</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Base</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@override</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ok: overrides Base.get_color</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">get_color</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"yellow\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">BadChild</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Base</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@override</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># type checker error: does not override Base.get_color</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">get_colour</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"red\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>19: error: Method \"get_colour\" is marked as an override, but no base method was found with this name [misc]<br>\n<!-- -->ERROR:nb-mypy:19: error: Method \"get_colour\" is marked as an override, but no base method was found with this name [misc]</p>\n</blockquote>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-692-优化-class-typeddictdict\">PEP 692: 优化 <code>class TypedDict(dict)</code><a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#pep-692-%E4%BC%98%E5%8C%96-class-typeddictdict\" class=\"hash-link\" aria-label=\"Direct link to pep-692-优化-class-typeddictdict\" title=\"Direct link to pep-692-优化-class-typeddictdict\">​</a></h3>\n<p>Python3.8 引入 <code>TypedDict</code>。</p>\n<p>创建用户的字典时，使用 <code>TypedDict</code> 做基类，linter 可完成正确的类型检查。</p>\n<p>Python3.12 优化了 <code>**kwargs 的类型标注方式</code> 的标注方式：<a href=\"https://peps.python.org/pep-0692/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 692 – Using TypedDict for more precise **kwargs typing</a></p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypedDict</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Point2D</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">TypedDict</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    y</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    label</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Point2D </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"x\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"y\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"label\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"good\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># OK</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">b</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Point2D </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"z\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"label\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"bad\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 类型检查失败</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Point2D</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">x</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> y</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> label</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"first\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token builtin\">dict</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">x</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> y</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> label</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"first\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 运行时即dict</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>11: error: Missing keys (\"x\", \"y\") for TypedDict \"Point2D\" [typeddict-item]<br>\n<!-- -->ERROR:nb-mypy:11: error: Missing keys (\"x\", \"y\") for TypedDict \"Point2D\" [typeddict-item]<br>\n<!-- -->11: error: Extra key \"z\" for TypedDict \"Point2D\" [typeddict-unknown-key]<br>\n<!-- -->ERROR:nb-mypy:11: error: Extra key \"z\" for TypedDict \"Point2D\" [typeddict-unknown-key]</p>\n</blockquote>\n<blockquote>\n</blockquote>\n<p>True</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Unpack</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python3.12 新增了 **kwargs 的类型标注方式，类型识别更精准</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">**</span><span class=\"token plain\">kwargs</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Unpack</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">Point2D</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"移除\">移除<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#%E7%A7%BB%E9%99%A4\" class=\"hash-link\" aria-label=\"Direct link to 移除\" title=\"Direct link to 移除\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"distuils-包\">distuils 包<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#distuils-%E5%8C%85\" class=\"hash-link\" aria-label=\"Direct link to distuils 包\" title=\"Direct link to distuils 包\">​</a></h3>\n<p>py3.10 开始启用，py3.12 移除。</p>\n<p>pyTP 中尚在使用，需要尽快考虑替换。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># setup.py</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> distutils</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">core </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Command</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>推荐的 pip 安装器用 setuptools 运行所有的 setup.py 脚本</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"imp-模块\">imp 模块<a href=\"https://wkevin.github.io/blog/2023/11/21/python3.12#imp-%E6%A8%A1%E5%9D%97\" class=\"hash-link\" aria-label=\"Direct link to imp 模块\" title=\"Direct link to imp 模块\">​</a></h3>\n<p>使用 importlib 模块替代其功能。</p>",
            "url": "https://wkevin.github.io/blog/2023/11/21/python3.12",
            "title": "Python3.12 介绍",
            "summary": "python3.12",
            "date_modified": "2023-11-21T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "python",
                "python3.12",
                "GIL",
                "f-str",
                "cpython_monitor"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2023/07/03/matplotlib.zh.font",
            "content_html": "<p>matplotlib\n中作图时常遇到中文显示乱码的问题，本文探索一下原因，并在文末给出一个通用的解决方案。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> os</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> matplotlib </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> mpl</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> matplotlib</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">pyplot </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> plt</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"mplfontmanager\">mpl.FontManager<a href=\"https://wkevin.github.io/blog/2023/07/03/matplotlib.zh.font#mplfontmanager\" class=\"hash-link\" aria-label=\"Direct link to mpl.FontManager\" title=\"Direct link to mpl.FontManager\">​</a></h2>\n<p>matplotlib\n中有个字体管理类，可以查询、添加、删除字体，包括系统安装、matplotlib\n安装、用户自己安装的 3 类字体。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">fm </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> mpl</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">font_manager</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">FontManager</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">afmlist</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">afmlist</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"manager 找到了 </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation builtin\">len</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">fm</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">ttflist</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> 个 ttf 字体，</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation builtin\">len</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">fm</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">afmlist</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> 个 afm 字体。\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">551</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FontEntry(fname='/data/kevin/workspace/venv/venv310/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/ttf/DejaVuSans-Bold.ttf', name='DejaVu Sans', style='normal', variant='normal', weight=700, stretch='normal', size='scalable')</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">138</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FontEntry(fname='/data/kevin/workspace/venv/venv310/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/afm/putb8a.afm', name='Utopia', style='normal', variant='normal', weight='bold', stretch='normal', size='scalable')</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">manager 找到了 551 个 ttf 字体，138 个 afm 字体。</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>字体由 FontEntry Class 封装，包括 fname、name、style… 等成员</p>\n<ul>\n<li>ttf:\n苹果公司和微软公司共同开发的一种电脑轮廓字体（曲线描边字）类型标准。</li>\n<li>afm：Adobe 公司开发，并包含了有关 Type 1 PostScript\n字体的度量特性的信息。AFM 结构需要一个定义了每一个字体符号的样式的控制模版。它主要被用于 UNIX。</li>\n</ul>\n<p>通过 manager 还能查询当前 matplotlib 使用的默认字体：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">defaultFamily</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">defaultFont</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">{'ttf': 'DejaVu Sans', 'afm': 'Helvetica'}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">{'ttf': '/data/kevin/workspace/venv/venv310/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/ttf/DejaVuSans.ttf', 'afm': '/data/kevin/workspace/venv/venv310/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/pdfcorefonts/Helvetica.afm'}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果不出意外，使用的都是 matplotlib 自带的字体，DejaVu Sans 和\nHelvetica，文件路径在 matplotlib 安装包所在的文件夹下。</p>\n<p>DejaVu\n字体是历史悠久的开源字体，<a href=\"https://github.com/dejavu-fonts/dejavu-fonts\" target=\"_blank\" rel=\"noopener noreferrer\">github</a>\n上下载该字体，3M\n左右，有体积上看也能猜出来不可能包含中日韩等东亚字体。在其\n<a href=\"https://dejavu-fonts.github.io/\" target=\"_blank\" rel=\"noopener noreferrer\">官网</a> 上可以查询它支持的字符集。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"三类字体\">三类字体<a href=\"https://wkevin.github.io/blog/2023/07/03/matplotlib.zh.font#%E4%B8%89%E7%B1%BB%E5%AD%97%E4%BD%93\" class=\"hash-link\" aria-label=\"Direct link to 三类字体\" title=\"Direct link to 三类字体\">​</a></h2>\n<p>如何分辨系统安装、matplotlib 安装、用户自己安装的 3 类字体？</p>\n<p>可以从 fname\n(文件路径)入手，缺点是如果用户强制安装到系统路径就分辨不了：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ttflist </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">systtf </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> ttflist </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fname</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">startswith</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/usr/\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">mplttf </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> ttflist </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fname</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">find</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"matplotlib\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">usrttf </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> ttflist </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fname</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">startswith</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">environ</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"HOME\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation builtin\">len</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">systtf</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> 个系统安装字体\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation builtin\">len</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">mplttf</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> 个Matplotlib安装字体\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation builtin\">len</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">usrttf</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> 个用户安装字体\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">353 个系统安装字体</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">38 个Matplotlib安装字体</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">160 个用户安装字体</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>字体这么多，其实是字体文件，基本上每个字体都有多种\nstyle，比如：极细、细、正常、粗、极粗、斜体……6、7\n个都常用，所以每种字体都多个文件。</p>\n<p>现在来看看 mpl 默认的字体 DejaVu Sans 在哪里：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token builtin\">len</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> systtf </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">find</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"DejaVu Sans\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"systtf 中发现 DejaVu Sans\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token builtin\">len</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> mplttf </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">find</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"DejaVu Sans\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"mplttf 中发现 DejaVu Sans\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token builtin\">len</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> usrttf </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">find</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"DejaVu Sans\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"usrttf 中发现 DejaVu Sans\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">systtf 中发现 DejaVu Sans</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">mplttf 中发现 DejaVu Sans</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>在 Linux 中可能会在系统和 mpl 两个集合中发现 DejaVu\nSans，因为这个字体也是 Linux 默认自带、推荐的；</p>\n<p>在 Windows 中可能只会在 mpl 自己的集合中发现了。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"发现中文字体\">发现中文字体<a href=\"https://wkevin.github.io/blog/2023/07/03/matplotlib.zh.font#%E5%8F%91%E7%8E%B0%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93\" class=\"hash-link\" aria-label=\"Direct link to 发现中文字体\" title=\"Direct link to 发现中文字体\">​</a></h2>\n<p>众多的字体中怎么发现哪些是中文字体？</p>\n<ol>\n<li><code>fc-list :lang=zh</code> 找到字体 —— 但只能用于 Linux</li>\n<li>名字中包含 CN、zh —— 但很多中文字体不满足</li>\n<li>看文件体积，我觉得至少要大于 5M 吧 —— 但只能作为参考，不能作为依据</li>\n</ol>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> subprocess </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Popen</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> PIPE</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_p </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Popen</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"fc-list :lang=zh\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> shell</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> stdout</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">PIPE</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> encoding</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"utf-8\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zhs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> _p</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">communicate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 捕获回来的 shell 打印是个字符串，用 `\\n` 表示新行，字符串很长</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 首先分割逐个提取出来。</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zhs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">zh </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> zh </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> zhs</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> zh </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 发现有空的，去掉</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"发现 </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation builtin\">len</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">zhs</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\"> 个中文字体文件\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 进一步提取出文件路径，放在 zhsfn 数组中</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zhsfn </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">zh</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\":\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> zh </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> zhs</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 提取出名称，放在 zhsn 数组中，并去重</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zhsn </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">set</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">zh</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\":\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\",\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> zh </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> zhs</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"中文字体（去重后）：\\n共 </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation builtin\">len</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">zhsn</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">, \\n前3个 </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">zhsn</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">[</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">:</span><span class=\"token string-interpolation interpolation format-spec\">3]</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">发现 234 个中文字体文件</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">中文字体（去重后）：</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">共 41,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">前3个 [' Noto Sans CJK SC', ' AR PL UKai CN', ' AR PL UKai HK']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>上面查询出了本机安装的所有中文字体，但<strong>特别需要注意的是：并非\n<code>fc-list :lang=zh</code> 能够找到的字体，Matplotlib 都能使用。</strong></p>\n<p>下面定义一个<strong>用 fontEntry 集合匹配 zhsfn</strong> 函数，来查找入参（FontEntry\n数组）与 zhsfn 的交集，以此可找出 Matplitlib 能够使用的中文字体：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fontEntries</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _fs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> fontEntries </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fname </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> zhsfn</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># _fs = sorted(_fs, key=lambda f: f[1])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># _fs.reverse()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">set</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_fs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 去重</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>上面函数中做了去重，就是每种字体的多种 style 只算一个 ——\n这也是我们口头上认为的一个字体。</p>\n<p>OK，下面可以分别查找 3 级字体中各自的中文字体：</p>\n<ul>\n<li><strong>系统安装的中文字体：</strong></li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">systtf</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['Droid Sans Fallback',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'AR PL UKai CN',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Noto Serif CJK JP',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'AR PL UMing CN',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Noto Sans CJK JP']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li><strong>Matpltlib 安装的中文字体（不出意外的话没有）：</strong></li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">mplttf</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li><strong>用户安装的中文字体：</strong></li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">usrttf</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['Sarasa Mono SC Nerd',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono Slab J',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono TC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono Slab TC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono SC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono Slab SC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono CL',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Source Han Sans CN',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono Slab CL',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'LXGW WenKai Mono',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono Slab K',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Source Han Serif SC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono K',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono HC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Source Han Sans HW SC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'LXGW WenKai',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono Slab HC',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Sarasa Mono J']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>总共交集多少个？</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token builtin\">len</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">23</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这里的数字（23），比上面所有的数字（41）要少一些，说明 Matplotlib\n并不能认出所有已安装的字体，中文字体也就同理。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"配置-plot-字体\">配置 plot 字体<a href=\"https://wkevin.github.io/blog/2023/07/03/matplotlib.zh.font#%E9%85%8D%E7%BD%AE-plot-%E5%AD%97%E4%BD%93\" class=\"hash-link\" aria-label=\"Direct link to 配置 plot 字体\" title=\"Direct link to 配置 plot 字体\">​</a></h2>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> matplotlib</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">pyplot </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> plt</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>plot 绘图只是 matplotlib 中的一个功能模块，plot\n会配置自己的参数来定义绘图中所用到的字体。</p>\n<p>plot 的参数定义在全局变量 <code>plt.rcParams</code> 中，包括日期格式、 x/y\n轴的显示、figure 的显示……其中也有 font 字体的配置：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.family\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['sans-serif']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>说明 plot 默认使用无衬线字体。字体一般分为 5 类：</p>\n<ul>\n<li>serif： 衬线</li>\n<li>sans-serif： 无衬线</li>\n<li>monospace： 等宽</li>\n<li>cursive：</li>\n<li>fantasy： 艺术字</li>\n</ul>\n<p>继续查看无衬线字体有哪些：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['DejaVu Sans',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Bitstream Vera Sans',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Computer Modern Sans Serif',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Lucida Grande',</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 'Verdana']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>继续查看无衬线字体中哪些是中文的：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">get_font_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">font_names</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    result </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> fn </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> font_names</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        result </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">entry </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> entry </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> entry</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> fn</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> result</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">get_font_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>不出意外，没有。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"添加-plot-中文字体\">添加 plot 中文字体<a href=\"https://wkevin.github.io/blog/2023/07/03/matplotlib.zh.font#%E6%B7%BB%E5%8A%A0-plot-%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93\" class=\"hash-link\" aria-label=\"Direct link to 添加 plot 中文字体\" title=\"Direct link to 添加 plot 中文字体\">​</a></h2>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">origin </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">origin</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['DejaVu Sans', 'Bitstream Vera Sans', 'Computer Modern Sans Serif']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>没有中文字体，plot 中的绘图遇到中文就是乱码，解决的办法有：</p>\n<ul>\n<li>baidu 到的常见方式：</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"SimHei\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['SimHei']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>SimHei 是 Windows 中常见的黑体中文，Linux\n没有，需要安装，这种方式跨操作系统兼容性不强，不好移植。</p>\n<ul>\n<li>修订 1</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"SimHei\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> origin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['SimHei', 'DejaVu Sans', 'Bitstream Vera Sans']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样万一 SimHei 没有，其余字体还能继续用，不至于全军覆没。</p>\n<ul>\n<li>修订 2</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> origin</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['Sarasa Mono SC Nerd', 'Sarasa Mono Slab J', 'Sarasa Mono Slab SC']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样就能保证 Matplotlib 正确使用中文了。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"猫\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"狗\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"鸡\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">show</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/cell-21-output-1-7218b87043661cdd4a16f6dc4dc16d13.png\" width=\"1287\" height=\"822\" class=\"img_ev3q\"></p>\n<ul>\n<li>修订 3</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ff </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.family\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"font.</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">ff</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    intersection_fclistzh_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"font.</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">ff</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.sans-serif\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">['Sarasa Mono SC Nerd', 'Sarasa Mono Slab J', 'Sarasa Mono Slab SC']</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样的代码更具通用性一些，万一 font.family\n被其他代码修改为无衬线字体，也能兼容。</p>\n<p><strong>所以，Linux 最终可以这样实现：</strong></p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> subprocess </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Popen</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> PIPE</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_p </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Popen</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"fc-list :lang=zh\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> shell</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> stdout</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">PIPE</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> encoding</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"utf-8\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zhs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> _p</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">communicate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zhs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">zh </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> zh </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> zhs</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> zh </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zhsfn </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">zh</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\":\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> zh </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> zhs</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">fm </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> mpl</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">font_manager</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">FontManager</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ff </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"font.family\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">intersection </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> t </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> fm</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ttflist </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fname </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> zhsfn</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 交集，得到 mpl 可用的中文</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"font.</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">ff</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> intersection </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">rcParams</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"font.</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">ff</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"猫\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"狗\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"鸡\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">plt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">show</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/cell-24-output-1-16d8ce2b4145dda2af7a1f371bfd1e27.png\" width=\"1287\" height=\"822\" class=\"img_ev3q\"></p>\n<p>如果你的操作系统或使用环境明确，当然也可以用\n<code>intersection_fclistzh_entry(fm.ttflist)</code> 查到某个中文字体，然后指定它。</p>",
            "url": "https://wkevin.github.io/blog/2023/07/03/matplotlib.zh.font",
            "title": "配置 matplotlib 中文字体",
            "summary": "matplotlib",
            "date_modified": "2023-07-03T00:00:00.000Z",
            "tags": []
        },
        {
            "id": "https://wkevin.github.io/blog/2023/05/17/vits",
            "content_html": "<p>熟悉 ViT（Vision Transformer）训练视觉模型的基本原理以及其典型方法（如 MAE，Mask Autoencoding）</p>\n<p>文中以下面形式引用 ChatGPT 答复：</p>\n<blockquote>\n<ul>\n<li>\n<p>提问</p>\n</li>\n</ul>\n<blockquote>\n<p>ChatGPT 的回答</p>\n</blockquote>\n</blockquote>\n<hr>\n<blockquote>\n<ul>\n<li>\n<p>ViT 模型出现的时间、paper、提出人</p>\n</li>\n</ul>\n<blockquote>\n<p>ViT 模型是由 Anish Athalye、Nicholas Carlini 和 David Wagner 等人于 2020 年在《Advances in Neural Information Processing Systems》会议上发布的论文**《An Image is Worth 16x16 Words: Transformers for Image Recognition at Scale》**中提出的。该论文开创性地将 Transformer 应用于计算机视觉领域，提出了一种名为 Vision Transformer（ViT）的模型，用于图像分类等计算机视觉任务。</p>\n</blockquote>\n</blockquote>\n<p>paper 链接：<a href=\"http://arxiv.org/abs/2010.11929\" target=\"_blank\" rel=\"noopener noreferrer\">http://arxiv.org/abs/2010.11929</a>: v1(2020.10), v2(2021.6)</p>\n<p>摘要：</p>\n<p>While the Transformer architecture has become the de-facto standard for natural language processing tasks, its applications to computer vision remain limited. In vision, attention is either applied in conjunction with convolutional networks, or used to replace certain components of convolutional networks while keeping their overall structure in place. We show that this reliance on CNNs is not necessary and a pure transformer applied directly to sequences of image patches can perform very well on image classification tasks. When pre-trained on large amounts of data and transferred to multiple mid-sized or small image recognition benchmarks (ImageNet, CIFAR-100, VTAB, etc.), Vision Transformer (ViT) attains excellent results compared to state-of-the-art convolutional networks while requiring substantially fewer computational resources to train.</p>\n<p>虽然 Transformer 体系结构已经成为自然语言处理任务的事实上的标准，但它在计算机视觉方面的应用仍然有限。在视觉上，注意力要么与卷积网络结合使用，要么用于替换卷积网络的某些组件，同时保持其整体结构不变。我们表明，这种对 CNN 的依赖是不必要的，直接应用于图像块序列的纯变换可以很好地执行图像分类任务。在对大量数据进行预训练并传输到多个中型或小型图像识别基准(ImageNet、CIFAR-100、VTAB 等)时，Vision Transformer(VIT)与最先进的卷积网络相比获得了出色的结果，同时需要训练的计算资源大大减少。</p>\n<hr>\n<blockquote>\n<ul>\n<li>\n<p>在 ViT 出现之前，Transformer 在视觉领域上使用都有哪些难点、痛点</p>\n</li>\n</ul>\n<blockquote>\n<ol>\n<li>需要大量的计算资源：由于图像具有高分辨率和大量的像素，如果直接使用 Transformer 进行计算会产生庞大的计算量，因而需要大量的计算资源和更复杂的计算方法。</li>\n<li>缺乏位置信息的输入：Transformer 主要是用于处理序列数据，在其应用于视觉任务时，需要将图像分成小块或将其压缩为一个向量，这样会导致一定程度上的信息丢失，尤其是位置信息的丢失，这在图像分类等任务中往往起着至关重要的作用。</li>\n<li>对于输入序列的长度敏感：由于 Transformer 的计算复杂度与输入序列的长度相关，因而对于不同大小的图像，需要进行不同的调整来处理，这将会带来时空复杂度方面的问题。</li>\n<li>无法处理变长输入：由于图像的大小和比例各不相同，需要根据实际情况对输入图像进行缩放和裁剪，这将使得数据的大小和形状不同，从而难以处理。</li>\n</ol>\n</blockquote>\n</blockquote>\n<p>Transformer Paper: <a href=\"http://arxiv.org/abs/1706.03762\" target=\"_blank\" rel=\"noopener noreferrer\">http://arxiv.org/abs/1706.03762</a></p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-17-17-09-02-f1f2ef86afefb7cd65754112c7e8a273.png#size40\" width=\"521\" height=\"773\" class=\"img_ev3q\"></p>\n<blockquote>\n<ul>\n<li>\n<p>描述一下 Transformer 模型中的注意力机制</p>\n</li>\n</ul>\n<blockquote>\n<p>在 Transformer 模型中，注意力机制是其中非常重要的组成部分。注意力机制本质上是一种加权平均，可以将输入序列中每个位置的信息集成到其他位置上。以自注意力机制（self-attention）为例，它将输入序列中的每个元素（也就是向量）映射到三个向量上，分别是查询向量（query）、键向量（key）和值向量（value）。这些向量由输入序列的线性变换得到，不同的线性变换矩阵用于产生不同的查询、键和值向量。\n接着，为了计算任何一个位置的表示，我们需要将该位置的查询向量与所有包括自身在内的键向量进行点积，然后再对这些结果进行归一化，形成一个权重分布。最后将该位置的值向量与这些归一化权重相乘，并将它们相加起来，这就产生了该位置的表示，如下述公式所示：\n<img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-17-17-34-14-5e2909c6f70d1e217f94c96a7441d025.png#size60\" width=\"672\" height=\"381\" class=\"img_ev3q\">\n在 Transformer 模型中，自注意力机制不仅可以在编码器中使用，而且可以在解码器中使用，以实现对输入序列和已经生成的部分解码序列的强大的交互和联合建模能力。注意力机制的加入使得模型能够有效地处理各种序列数据，这也是 Transformer 模型在语言模型和其他自然语言处理任务上取得成功的原因之一。</p>\n</blockquote>\n</blockquote>\n<hr>\n<blockquote>\n<ul>\n<li>\n<p>介绍一下 ViT 模型的核心内容</p>\n</li>\n</ul>\n<blockquote>\n<p>ViT (Vision Transformer) 是一种使用 Transformer 结构进行图像分类的模型。该模型由 Google Brain 提出，旨在探索将 Transformer 应用于计算机视觉任务的可能性。\nViT 模型首先将图像分解成一组固定大小的图块，每个图块通过预定义的线性投影映射到一个向量空间中。接下来，模型使用 Transformer 结构对这些向量执行自注意力操作，并在不同的 Transformer 块之间添加全局平均池化操作，最终将这些向量输入到一个全连接层进行分类。\n与传统的卷积神经网络相比，ViT 模型的架构更加简单明了，并且具有更高的灵活性，能够处理输入图像的大小和分辨率的变化。此外，ViT 模型在一些计算机视觉基准测试上取得了与最先进的卷积神经网络相当的性能。\n然而，相对于传统的卷积神经网络，ViT 模型需要更多的计算资源和更长的训练时间，因为它需要处理大量的小块图像，并且由于 ViT 排列成网格状，使得其对于一些位置相关性较强的视觉任务表现不如 CNN。\nViT 模型的出现和成功应用，为使用 Transformer 解决视觉领域的问题提供了新的思路和方法。</p>\n</blockquote>\n</blockquote>\n<p>ViT 论文中最核心的结论是：<strong>当拥有足够多的数据进行预训练的时候，ViT 的表现就会超过 CNN，突破 transformer 缺少归纳偏置的限制，可以在下游任务中获得较好的迁移效果。</strong></p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-17-16-55-31-6338840455358cfc3bed38b4ee7ea381.png\" width=\"720\" height=\"361\" class=\"img_ev3q\"></p>\n<p>在 nlp 中，输入 transformer 中的是一个序列，而在视觉领域，需要考虑如何将一个 2d 图片转化为一个 1d 的序列，最直观的想法就是将图片中的像素点输入到 transformer 中，但是这样会有一个问题，因为模型训练中图片的大小是 224*224=50176，而正常的 bert 的序列长度是 512，是 bert 的 100 倍，这个的复杂度太高了。</p>\n<p>ViT 怎么做前向（上图右侧）：将图片切分成 16x16 的 patch，每一个 patch 作为一个 token 输入到 transformer</p>\n<ul>\n<li>每个 <code>224*224</code> 的图片得到 196 个 patch</li>\n<li>每个 patch <code>16*16*3=768</code> 维向量（3 是 RGB 通道个数）</li>\n<li>给每个 patch embedding 加上一个 position embedding（cls），196 个 patch 得到 196 个位置—— 借鉴 bert</li>\n<li>所以整个输入是 <code>197*768</code> 维向量</li>\n</ul>\n<hr>\n<blockquote>\n<ul>\n<li>\n<p>ViT 模型对后续的 Transformer 视觉模型的影响和继承关系</p>\n</li>\n</ul>\n<blockquote>\n<p>ViT 模型作为一种将 Transformer 模型应用于计算机视觉任务的先驱，对后续的 Transformer 视觉模型有着重要的影响和启发作用。对于后续的 Transformer 视觉模型，可以总结出以下的继承和影响关系：</p>\n<ol>\n<li>缩小网络规模：ViT 模型的提出标志着 Transformer 模型在视觉领域的应用实现。但是，由于 ViT 模型中需要划分为固定的图块以适应 Transformer，这会导致模型对输入分辨率的敏感度而不适用于高分辨率图像。后续的 Transformer 视觉模型例如 DETR 和 Swin Transformer 等，都在模型压缩和性能提升上做出了改进和优化，使得模型更加轻量化、高效。</li>\n<li>使用不同的位置编码：ViT 模型中使用的绝对位置编码方式是基于位置信息的，每个位置的编码都是固定的，而这可能会对模型的泛化能力造成一定的影响。因此，一些后续的模型也尝试了使用相对位置编码等更加灵活、多样化的位置编码方式，来增强模型的泛化和适应能力，例如 Swin Transformer 和 PVT 等模型。</li>\n<li>增加特征金字塔结构：ViT 模型在将高分辨率图像转换为小块特征表示上存在一定的局限性。一些后续模型，例如 Swin Transformer 就利用特征金字塔结构（FPN）来实现多层特征的融合，获取更全局和复杂的上下文信息，并进一步提升模型的性能。\n总之，ViT 模型的提出为 Transformer 模型在视觉领域的应用开启了新的方向和思路。后续的 Transformer 视觉模型在融合更多优秀技术的同时，也不断突破和完善着基于 Transformer 的计算机视觉模型框架。</li>\n</ol>\n</blockquote>\n</blockquote>",
            "url": "https://wkevin.github.io/blog/2023/05/17/vits",
            "title": "ViT ChatGPT 问答",
            "summary": "vits question and ananswer by ChatGPT",
            "date_modified": "2023-05-17T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "vit"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2023/04/25/llm.survey",
            "content_html": "<p>我是从 3 月的 ChatGPT 爆发才开始关注大模型的，经过一番手忙脚乱的注册 openai 的 id、使用其 python sdk 后，这才开始转入对 LLM 的观察和学习上来。</p>\n<p>2018 年学过 CNN、RNN 后除了在视觉上做了一些产品外，NLP 基本没接触，所以对 Transformer、ViT 都略过了，忽然被 ChatGPT 刺激了一下，才发现 Transformer 除了 NLP，也已经横扫 CV 了，效果超过 NN。那好吧，赶紧补课，把 LLM 学起来。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"发展史\">发展史<a href=\"https://wkevin.github.io/blog/2023/04/25/llm.survey#%E5%8F%91%E5%B1%95%E5%8F%B2\" class=\"hash-link\" aria-label=\"Direct link to 发展史\" title=\"Direct link to 发展史\">​</a></h2>\n<p>谢天谢地，有几篇 paper 已经准备好给我填鸭式教学了：</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-17-46-f2197d1e561e4d4f67c689033bef0a30.png\" width=\"1106\" height=\"589\" class=\"img_ev3q\"></p>\n<p><a href=\"https://arxiv.org/abs/2303.18223\" target=\"_blank\" rel=\"noopener noreferrer\">https://arxiv.org/abs/2303.18223</a> —— 首先是这篇一众国人联手写的，信息整理全面。挑了一些作为我后续关注的重点（重点关注国产、开源）：</p>\n<ul>\n<li>2018 OpenAI GPT</li>\n<li>202103，THUDM（清华），GLM</li>\n<li>202104，PLC（鹏程实验室）+华为，盘古</li>\n<li>202105，OpenAI，CodeX</li>\n<li>202205，THUNLP（OpenBMB），CPM</li>\n<li>202302, Meta, LLaMA（羊驼），已经后续的 Alpaca（小羊驼）、Vicuna（野羊驼）</li>\n<li>202303，THUDM（清华）,CodeGeeX</li>\n</ul>\n<blockquote>\n<p>后续补充：</p>\n</blockquote>\n<ul>\n<li>202305，MosaicML， MPT</li>\n<li>202305， bigcode（Huggingface &amp; ServiceNow），StarCoder</li>\n</ul>\n<p>读完 paper，基本了解了 LLM 的发展历程，比如：</p>\n<ul>\n<li>Transformer 从 2017.12 Google 提出后，经过了 3 年左右的缓慢爬坡，LLM 并没有大量出现，直到 2020 年，因为算力的提升，2020.5 英伟达发布了 A100,单精度达到 19.5TFLOPS，助力了 LLM 开始狂飙。</li>\n<li>ChatGPT 是 GPT-3 之后的 InstructGPT 改造而来的。</li>\n<li>THUDM 和 THUNLP 分别是清华计算机学院和 NLP 学院的两个团队，分别打造 LLM。</li>\n<li>Google 发布的 LLM 可谓是最多，但没能创造风口，有点遗憾。后来读到 2022.02 Google 的《LaMDA: Language models for dialog applications》（<a href=\"http://arxiv.org/abs/2201.08239%EF%BC%89%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0\" target=\"_blank\" rel=\"noopener noreferrer\">http://arxiv.org/abs/2201.08239），可以看到</a> Google 诉苦良多，为了 Quality、Safety、and Groundedness，让 OpenAI 占了先机，气的很，哈哈。</li>\n<li>了解到 LLM 考虑到本地 inference 受限，大多以是所有 WebAPI 作为使用接口（ChatGPT 就是这样）。</li>\n<li>了解到各个模型根据语料库的不同，在不同领域表现不同，所以拿 GPT-3 与 AlphaCode 比谁生成的代码好就不厚道了，因为 GPT-3 的数据集里没有 Code。</li>\n</ul>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-32-51-3189742dc2adc8462a6e64f22d2cc393.png\" width=\"1245\" height=\"477\" class=\"img_ev3q\"></p>\n<p>总之，很感谢作者们的这篇文章，让我有了个全貌的了解。</p>\n<p>第 2 篇：<a href=\"https://arxiv.org/abs/2304.13712\" target=\"_blank\" rel=\"noopener noreferrer\">https://arxiv.org/abs/2304.13712</a> —— 这篇文章更学术一些，amazone 一众研究员撰写，开篇一幅图就爱了：</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-36-37-e852f7f12310afe27e68c99b8039f4e0.png\" width=\"2566\" height=\"2071\" class=\"img_ev3q\"></p>\n<p>它根据 Encoder、Decoder、Encoder&amp;Decoder 三个分支给 LLM 做了分类，当然这不是什么新分类法，Huggingface 中的文档 <a href=\"https://huggingface.co/docs/transformers/model_summary\" target=\"_blank\" rel=\"noopener noreferrer\">The Transformer model family</a> 早就是这么分类的了，但这个图画的确实好，整理的很完整，我甚至打印出来，没遇到一个最近发布的新模型，还要定位、补充进去。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"领域视角\">领域视角<a href=\"https://wkevin.github.io/blog/2023/04/25/llm.survey#%E9%A2%86%E5%9F%9F%E8%A7%86%E8%A7%92\" class=\"hash-link\" aria-label=\"Direct link to 领域视角\" title=\"Direct link to 领域视角\">​</a></h2>\n<p>最颠覆的我的，就是看到 ViT，看了 <a href=\"http://arxiv.org/abs/2010.11929\" target=\"_blank\" rel=\"noopener noreferrer\">An Image is Worth 16x16 Words: Transformers for Image Recognition at Scale</a>，再听了李沐在 Bilibili 上解读 ViT 的视频后，更加对 Transformer 兴趣盎然，后来又进一步了解到凯明大神的 MAE，以及 Diffusion 扩散模型、DiTs……好多东西扑面而来，虽然我无法弄懂里面的所有原理，但尽可能的理解对于开发基于 LLM 的 APP 应该是有益的。</p>\n<p>下面分别是 Transformer 模型在 NLP、视觉、Audio、多模态 四个领域的主流模型，图中并不是某某公司发布的 LLM，而是 LLM 的技术架构，分成四幅图很好的展示了四个应用领域（或场景）。</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-52-37-d86a5dbba4dcfcad0efeb61adc70374e.png\" width=\"1018\" height=\"326\" class=\"img_ev3q\"></p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-51-58-f19eee2bee23385fce40e0655e1518dd.png\" width=\"940\" height=\"339\" class=\"img_ev3q\"></p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-52-54-23c1f2f6cb4f1860634de6246b9c1c61.png\" width=\"1027\" height=\"345\" class=\"img_ev3q\"></p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-53-10-1e7393c67bcdb7e04b61c6e374d34f5e.png\" width=\"1023\" height=\"350\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"成本\">成本<a href=\"https://wkevin.github.io/blog/2023/04/25/llm.survey#%E6%88%90%E6%9C%AC\" class=\"hash-link\" aria-label=\"Direct link to 成本\" title=\"Direct link to 成本\">​</a></h2>\n<p>大型语言模型在尺寸和成本上都在不断扩大。2019 年发布的 GPT-2 被认为是第一个大型语言模型，它有 1.5B（15 亿）个参数，训练成本估计为 5 万美元。仅仅三年后，540B 参数，预估花费 800 万美元的 Palm 就出来了。\n2022 年末至今，在所有领域，大型语言和多模态模型都在变得更大、更贵。2023 年 4 月斯坦福发布的 《The State of AI in 2023》中显示：</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-18-03-41-a0fa461504f2e7dd99e40c3a7f466d56.png\" width=\"2000\" height=\"1333\" class=\"img_ev3q\"></p>\n<p>有些 LLM 还会在自己的网站上写明花费，比如清华 THUNLP 的 OpenBMB 社区的 CPM：43w，68 天 —— 你觉得这钱和这碳排放值不值？</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/2023-05-10-19-33-04-dd6cf4b84a8a2deadfd4722d5eda5b1e.png\" width=\"993\" height=\"507\" class=\"img_ev3q\"></p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"task\">Task<a href=\"https://wkevin.github.io/blog/2023/04/25/llm.survey#task\" class=\"hash-link\" aria-label=\"Direct link to Task\" title=\"Direct link to Task\">​</a></h2>\n<p>LLM 能做什么？怎么分类？</p>\n<p>可能很多人和我一样，从 ChatGPT 切入 LLM 后对它聊天之外的能力感觉不明显，但聊天是我们口语话的功能，并不是技术领域的 Task，比如聊天中可能需要总结一段话、预测下一句、填空、回答一个指定问题、翻译……这都是聊天，那专业的分类方式是什么，看这里：</p>\n<p><a href=\"https://huggingface.co/docs/transformers/v4.29.0/en/main_classes/pipelines#transformers\" target=\"_blank\" rel=\"noopener noreferrer\">transformers - pipeline</a></p>\n<p>列了 27 个 Task</p>\n<ul>\n<li>audio<!-- -->\n<ul>\n<li>\"audio-classification\"</li>\n<li>\"automatic-speech-recognition\"</li>\n<li>\"zero-shot-audio-classification\"</li>\n</ul>\n</li>\n<li>cv<!-- -->\n<ul>\n<li>分类<!-- -->\n<ul>\n<li>\"image-classification\"</li>\n<li>\"video-classification\"</li>\n<li>\"zero-shot-image-classification\"</li>\n</ul>\n</li>\n<li>物体检测<!-- -->\n<ul>\n<li>\"object-detection\"</li>\n<li>\"zero-shot-object-detection\"</li>\n</ul>\n</li>\n<li>分割<!-- -->\n<ul>\n<li>\"image-segmentation\"</li>\n</ul>\n</li>\n<li>深度估算<!-- -->\n<ul>\n<li>\"depth-estimation\"</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>nlp<!-- -->\n<ul>\n<li>文本分类<!-- -->\n<ul>\n<li>\"text-classification\" (alias \"sentiment-analysis\" available)</li>\n<li>\"zero-shot-classification\"</li>\n</ul>\n</li>\n<li>token 分类<!-- -->\n<ul>\n<li>\"token-classification\"</li>\n</ul>\n</li>\n<li>问答<!-- -->\n<ul>\n<li>\"question-answering\"</li>\n<li>\"table-question-answering\"</li>\n</ul>\n</li>\n<li>总结<!-- -->\n<ul>\n<li>\"summarization\"</li>\n</ul>\n</li>\n<li>翻译<!-- -->\n<ul>\n<li>\"translation\"</li>\n<li>\"translation_xx_to_yy\"</li>\n</ul>\n</li>\n<li>语言建模（生成）<!-- -->\n<ul>\n<li>\"text2text-generation\"</li>\n<li>\"text-generation\"</li>\n<li>\"fill-mask\"</li>\n<li>\"mask-generation\"</li>\n<li>\"conversational\"</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>多模态<!-- -->\n<ul>\n<li>\"document-question-answering\"</li>\n<li>\"feature-extraction\"</li>\n<li>\"image-to-text\"</li>\n<li>\"visual-question-answering\"</li>\n</ul>\n</li>\n</ul>\n<p>先建立这些概念，这样当开发 LLM 的 API 时，就可以轻松地使用 SDK 中的各种 API 及其术语、概念。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"playground\">playground<a href=\"https://wkevin.github.io/blog/2023/04/25/llm.survey#playground\" class=\"hash-link\" aria-label=\"Direct link to playground\" title=\"Direct link to playground\">​</a></h2>\n<p>虽然已经出现了一些笔记本可运行的大模型，甚至浏览器可以运行的 LLM，但主流还是在有 GPU 的电脑、工作站上运行的模式，当然最好是薅一些 Data Center 的羊毛，比如:</p>\n<ul>\n<li><a href=\"https://huggingface.co/spaces\" target=\"_blank\" rel=\"noopener noreferrer\">HuggingFace 上的 space</a> 可以用 hf 的算力，来运行一些 hf 的 model，各个 model 呈现的 UI 不一样，需要仔细挑选一下。</li>\n<li><a href=\"https://platform.openai.com/playground\" target=\"_blank\" rel=\"noopener noreferrer\">OpenAI playground</a>: OpenAI 为 ChatGPT（其实包括了 GPT 多个版本）开发的演练场，可以在里面玩一玩，对应学习 openai 的 python sdk 包是有帮助的。</li>\n</ul>",
            "url": "https://wkevin.github.io/blog/2023/04/25/llm.survey",
            "title": "LLM 概览",
            "summary": "llm.survey",
            "date_modified": "2023-04-25T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "llm",
                "survey"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2023/04/10/openai.cookbook",
            "content_html": "<p>openAI 提供多种 API：</p>\n<ol>\n<li>webAPI: 使用 curl、postman、insomnia 等访问。</li>\n<li>python API：<code>pip install openai</code> 即可开始使用，源码在 <a href=\"https://github/openai/openai-python\" target=\"_blank\" rel=\"noopener noreferrer\">github</a>上开源，文档没有专门的，但 OpenAI 另外一个开源项目 <a href=\"https://github/openai/openai-cookbook\" target=\"_blank\" rel=\"noopener noreferrer\">cookbook</a> 中有很多例子可以参考。</li>\n<li>Node.js API: <code>npm install openai</code> 即可开始使用，源码在 <a href=\"https://github.com/openai/openai-node\" target=\"_blank\" rel=\"noopener noreferrer\">github</a>上开源，</li>\n<li>.NET API: 貌似开发中……</li>\n</ol>\n<p>其实 python 和 Node.js 的底层基础还是 webAPI，只不过可以用高级语言更灵活的写代码操作。</p>\n<p>官网的 <a href=\"https://platform.openai.com/docs/api-reference\" target=\"_blank\" rel=\"noopener noreferrer\">API Reference</a> 上可以查看文档，里面基本每个主题都列出了 curl、python、nodejs 三种 API 使用的方法，及其应答数据的样例。</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/three.api.on.openai.website-cdf40106cf19663b36c456a8b63bdee8.gif\" width=\"965\" height=\"443\" class=\"img_ev3q\"></p>\n<p>比如上面例子中的获取 openai 开放可用的模型列表，python 的用法是：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> os</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> openai</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">openai</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">api_key </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getenv</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"OPENAI_API_KEY\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">openai</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Model</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">curl https://api.openai.com/v1/chat/completions \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -H \"Content-Type: application/json\" \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -H \"Authorization: Bearer $OPENAI_API_KEY\" \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -d '{</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     \"model\": \"gpt-3.5-turbo\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     \"messages\": [{\"role\": \"user\", \"content\": \"Say this is a test!\"}],</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     \"temperature\": 0.7</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   }'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>",
            "url": "https://wkevin.github.io/blog/2023/04/10/openai.cookbook",
            "title": "OpenAI python SDK",
            "summary": "openai.cookbook",
            "date_modified": "2023-04-10T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "openai",
                "cookbook"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/11/10/python3.11",
            "content_html": "<p>Python 3.11 于 2022.10.24 发布正式版 3.11.0，历经 1 年开发和测试：</p>\n<ul>\n<li>2021.10 - 2022.04：发布 7 个 a 版本；</li>\n<li>2022.05 - 2022.07：发布 5 个 b 版本；</li>\n<li>2022.8.8：rc1</li>\n<li>2022.9.12：rc2</li>\n<li>2022.10.24：3.11.0</li>\n</ul>\n<p>重点新特性：</p>\n<ul>\n<li>Runtime、解释器<!-- -->\n<ul>\n<li>Faster Cpython</li>\n<li>bytecode 中添加偏移量对应关系，以便 traceback 中指明出错位置</li>\n</ul>\n</li>\n<li>语言（语法、词法）<!-- -->\n<ul>\n<li>新增“异常组”：<code>ExceptionGroup</code> &amp; <code>try...except*</code></li>\n</ul>\n</li>\n<li>标准库<!-- -->\n<ul>\n<li>新增 <code>tomllib</code> 模块</li>\n<li><code>asyncio</code> 模块<!-- -->\n<ul>\n<li>新增“任务组”：<code>asyncio.TaskGroup</code></li>\n<li><code>Task</code> 新增 <code>cancelling()</code>, <code>uncancel()</code> 方法</li>\n</ul>\n</li>\n<li><code>inspect</code> 模块<!-- -->\n<ul>\n<li>新增 <code>getmembers_static()</code></li>\n</ul>\n</li>\n<li><code>dataclasses</code> 模块</li>\n<li><code>typing</code> 模块<!-- -->\n<ul>\n<li>增加 <code>typing.TypeVarTuple</code></li>\n<li>增加 <code>typing.Self</code></li>\n<li>增加 <code>typing.LiteralString</code></li>\n<li>增加 <code>typing.TypedDict</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>本文来导读一下这个刚刚正式揭开面纱的新版本。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"refer\">Refer<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#refer\" class=\"hash-link\" aria-label=\"Direct link to Refer\" title=\"Direct link to Refer\">​</a></h2>\n<p>本文内容大多源自下面文档，及其文档中的相关链接文档。</p>\n<ol>\n<li><a href=\"https://www.python.org/downloads/release/python-3110/\" target=\"_blank\" rel=\"noopener noreferrer\">Python 3.11.0 Release</a>: 2022.10.24</li>\n<li><a href=\"https://docs.python.org/release/3.11.0/whatsnew/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">What’s New In Python 3.11</a>（<a href=\"https://docs.python.org/release/3.11.0/whatsnew/changelog.html?utm_source=pocket_saves\" target=\"_blank\" rel=\"noopener noreferrer\">Changelog</a>）</li>\n<li><a href=\"https://peps.python.org/pep-0664/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 664 - 3.11 Release Schedule</a></li>\n</ol>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"runtime解释器\">Runtime、解释器<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#runtime%E8%A7%A3%E9%87%8A%E5%99%A8\" class=\"hash-link\" aria-label=\"Direct link to Runtime、解释器\" title=\"Direct link to Runtime、解释器\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"faster-cpython\">Faster CPython<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#faster-cpython\" class=\"hash-link\" aria-label=\"Direct link to Faster CPython\" title=\"Direct link to Faster CPython\">​</a></h3>\n<p>2020 年底一位普通 python 开发者 Mark 提出了此计划，2021 年 5 月得到 python 之父 Guio 的加入，微软投资成立了一个专门小组……小组成功落实到 python3.11 中，Mark 也被微软聘用了。</p>\n<p>此计划的主要工作内容有：</p>\n<ul>\n<li>PEP659：python 解释器用专业化（spectifaction）指令自适应替换原（高频）指令。</li>\n<li>运行时更快的加载。</li>\n<li>减小函数调用的开销：堆栈帧（frame）使用更少的内存和更快的设计。</li>\n<li>“零开销”异常处理。</li>\n</ul>\n<p>号称：Python 3.11 比 Python 3.10 快 10-60%，平均 25%。3.11.0 只是一个开始，后续版本会持续发力。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-659----draft\"><a href=\"https://peps.python.org/pep-0659/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 659</a> -- Draft<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#pep-659----draft\" class=\"hash-link\" aria-label=\"Direct link to pep-659----draft\" title=\"Direct link to pep-659----draft\">​</a></h4>\n<p>为“专业化”指令开发“自适应”形式，称之为：自适应指令。一旦代码中指令执行了足够多的次数，该指令就会被“专业化”，即替换为更快的、新的、自适应指令。—— 此过程称之为“<strong>加速（Quickening）</strong>”。</p>\n<p>与现有的 bytecode 相比，quickening 的优点：</p>\n<ul>\n<li>可以运行时更改：指令替换是运行时自动发生的</li>\n<li>可以开发出 super-instructions：跨多行、多操作数</li>\n<li>不需要处理 tracing，因为它可以退回到 bytecode 执行 tracing</li>\n</ul>\n<p>eg: <code>LOAD_ATTR</code> 替换为 <code>LOAD_ATTR_ADAPTIVE</code>。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"加载过程加快\">加载过程加快<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%8A%A0%E5%BF%AB\" class=\"hash-link\" aria-label=\"Direct link to 加载过程加快\" title=\"Direct link to 加载过程加快\">​</a></h4>\n<p>Python 将 bytecode 缓存在 <code>__pycache__</code> 目录下，，以加速模块加载。</p>\n<ul>\n<li>3.10：<!-- -->\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Read __pycache__ -&gt; Unmarshal -&gt; Heap allocated code object -&gt; Evaluate</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>3.11: core 模块被 <code>frozen</code>(code object &amp; bytecode 被静态缓存)<!-- -->\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Statically allocated code object -&gt; Evaluate</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n</ul>\n<p>实测：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(venv310) $ time python -c \"pass\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python -c \"pass\"  0.01s user 0.00s system 98% cpu 0.019 total</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(venv310) $ time python -c \"import os\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python -c \"import os\"  0.02s user 0.01s system 98% cpu 0.028 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(venv311) $ time python -c \"pass\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python -c \"pass\"  0.02s user 0.00s system 98% cpu 0.017 total</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(venv311) $ time python -c \"import os\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python -c \"import os\"  0.01s user 0.01s system 97% cpu 0.022 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>一点点提升，不是很明显，多次执行还有反复。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"运行速度加快\">运行速度加快<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E8%BF%90%E8%A1%8C%E9%80%9F%E5%BA%A6%E5%8A%A0%E5%BF%AB\" class=\"hash-link\" aria-label=\"Direct link to 运行速度加快\" title=\"Direct link to 运行速度加快\">​</a></h4>\n<p>函数调用时 cpython 会创建 frame 保存运行信息，frame 在 3.11 中的改变：</p>\n<ul>\n<li>Streamlined the frame creation process.</li>\n<li>Avoided memory allocation by generously re-using frame space on the C stack.</li>\n<li>Streamlined the internal frame struct to contain only essential information. Frames previously held extra debugging and memory management information.</li>\n</ul>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-657----traceback-中包含细粒度错误信息\"><a href=\"https://peps.python.org/pep-0657/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 657</a> -- traceback 中包含细粒度错误信息<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#pep-657----traceback-%E4%B8%AD%E5%8C%85%E5%90%AB%E7%BB%86%E7%B2%92%E5%BA%A6%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF\" class=\"hash-link\" aria-label=\"Direct link to pep-657----traceback-中包含细粒度错误信息\" title=\"Direct link to pep-657----traceback-中包含细粒度错误信息\">​</a></h3>\n<p>之前的编译保留了字节码到行号的映射关系，但无法映射到哪个表达式，python11 中添加了行号和偏移量（新增 <code>co_positions</code> 属性）用以在 traceback 中提供更方便的定位信息。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">x </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">x</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"a\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">x</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"a\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"b\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"c\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>py10<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python310 main.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Traceback (most recent call last):</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File \"/home/me/py311/main.py\", line 3, in &lt;module&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x[\"a\"][\"b\"][\"c\"] = 1</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TypeError: 'int' object is not subscriptable</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>py311<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python311 main.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Traceback (most recent call last):</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File \"/home/me/py311/main.py\", line 3, in &lt;module&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x[\"a\"][\"b\"][\"c\"] = 1</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    ~~~~~~^^^^^</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TypeError: 'int' object is not subscriptable</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<code>~~~~~~^^^^^</code> 为新增提示。</li>\n</ul>\n<p>函数调用链中也能突出显示：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"a\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"a\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"b\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"c\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foo: %s\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>py10<!-- -->\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Traceback </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">most recent call last</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File </span><span class=\"token string\" style=\"color:#e3116c\">\"/home/me/py311/main.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line </span><span class=\"token number\" style=\"color:#36acaa\">11</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\">module</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File </span><span class=\"token string\" style=\"color:#e3116c\">\"/home/me/py311/main.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line </span><span class=\"token number\" style=\"color:#36acaa\">8</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> bar</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foo: %s\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File </span><span class=\"token string\" style=\"color:#e3116c\">\"/home/me/py311/main.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line </span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> foo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"a\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"b\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"c\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'int'</span><span class=\"token plain\"> </span><span class=\"token builtin\">object</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">not</span><span class=\"token plain\"> subscriptable</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>py311<!-- -->\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Traceback </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">most recent call last</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File </span><span class=\"token string\" style=\"color:#e3116c\">\"/home/me/py311/main.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line </span><span class=\"token number\" style=\"color:#36acaa\">11</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\">module</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File </span><span class=\"token string\" style=\"color:#e3116c\">\"/home/me/py311/main.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line </span><span class=\"token number\" style=\"color:#36acaa\">8</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> bar</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foo: %s\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                      </span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  File </span><span class=\"token string\" style=\"color:#e3116c\">\"/home/me/py311/main.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line </span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> foo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"a\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"b\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"c\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token operator\" style=\"color:#393A34\">~</span><span class=\"token operator\" style=\"color:#393A34\">~</span><span class=\"token operator\" style=\"color:#393A34\">~</span><span class=\"token operator\" style=\"color:#393A34\">~</span><span class=\"token operator\" style=\"color:#393A34\">~</span><span class=\"token operator\" style=\"color:#393A34\">~</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token operator\" style=\"color:#393A34\">^</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'int'</span><span class=\"token plain\"> </span><span class=\"token builtin\">object</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">not</span><span class=\"token plain\"> subscriptable</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<code>foo()</code> 和 <code>[\"b\"]</code> 下面都给出了提示。</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"语言语法词法\">语言（语法、词法）<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E8%AF%AD%E8%A8%80%E8%AF%AD%E6%B3%95%E8%AF%8D%E6%B3%95\" class=\"hash-link\" aria-label=\"Direct link to 语言（语法、词法）\" title=\"Direct link to 语言（语法、词法）\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pep-654----exception-groups-and-except\"><a href=\"https://peps.python.org/pep-0654/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 654</a> -- Exception Groups and <code>except*</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#pep-654----exception-groups-and-except\" class=\"hash-link\" aria-label=\"Direct link to pep-654----exception-groups-and-except\" title=\"Direct link to pep-654----exception-groups-and-except\">​</a></h3>\n<p><strong>痛点</strong></p>\n<ul>\n<li>异步库并发多任务引发的连锁异常没有办法整合、汇聚、关联。</li>\n<li>相同操作多次尝试（如 <code>socket.create_connection</code> 多次连接都失败才停止）中的多个异常如何整合？</li>\n<li>多个回调函数中若有异常的策略：如 <code>atexit.registry()</code> 允许用户注册多个退出回调函数，退出时依次运行，但若其中多个抛了异常，则用户只会拿到最后 1 个。很多 3rd 库也是这个策略，如 Pytest 在 teardown 中注册 finalizers。</li>\n<li>复杂计算中的异常通常难以定位。</li>\n<li>装饰器（wrapper）中的异常会屏蔽掉被封装体的信息。</li>\n</ul>\n<p><strong>解决方案</strong></p>\n<p>3.11 新增了 <a href=\"http://10.7.225.106:8888/python/python-doc/en/python-3.11.0-docs-html/library/exceptions.html#exception-groups\" target=\"_blank\" rel=\"noopener noreferrer\">ExceptionGroup &amp; BaseExceptionGroup</a></p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">exception ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">msg</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> excs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">exception BaseExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">msg</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> excs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>他俩在整个标准库内建异常中的继承关系是：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">BaseException</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> ├── BaseExceptionGroup</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> ├── GeneratorExit</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> ├── KeyboardInterrupt</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> ├── SystemExit</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> └── Exception</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ├── ArithmeticError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      │    ├── FloatingPointError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      │    ├── OverflowError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      │    └── ZeroDivisionError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ├── AssertionError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ├── AttributeError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ├── BufferError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ├── EOFError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ├── ExceptionGroup </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">BaseExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ├── </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"创建\">创建<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%88%9B%E5%BB%BA\" class=\"hash-link\" aria-label=\"Direct link to 创建\" title=\"Direct link to 创建\">​</a></h4>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> traceback</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token string\" style=\"color:#e3116c\">\"one\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"two\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"three\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> ExceptionGroup </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">eg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">         </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output: one (3 sub-exceptions)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">eg</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">message</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output: one</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">eg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># + Exception Group Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |   File \"/home/me/py311/main.py\", line 20, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |     raise ExceptionGroup(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># | ExceptionGroup: one (3 sub-exceptions)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | TypeError: 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +---------------- 2 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | ExceptionGroup: two (2 sub-exceptions)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       | TypeError: 2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       +---------------- 2 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       | ValueError: 3</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       +------------------------------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +---------------- 3 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | ExceptionGroup: three (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       | OSError: 4</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       +------------------------------------</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"提取子集subgroup\">提取子集：<code>subgroup</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E6%8F%90%E5%8F%96%E5%AD%90%E9%9B%86subgroup\" class=\"hash-link\" aria-label=\"Direct link to 提取子集subgroup\" title=\"Direct link to 提取子集subgroup\">​</a></h4>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">subeg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">subgroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">lambda</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">isinstance</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">subeg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># + Exception Group Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |   File \"/home/me/py311/main.py\", line 20, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |     raise ExceptionGroup(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># | ExceptionGroup: one (2 sub-exceptions)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | TypeError: 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +---------------- 2 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | ExceptionGroup: two (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       | TypeError: 2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       +------------------------------------</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>或者直接写类型</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">subeg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">subgroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">subeg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># + Exception Group Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |   File \"/home/me/py311/main.py\", line 20, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |     raise ExceptionGroup(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># | ExceptionGroup: one (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   | ExceptionGroup: two (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | ValueError: 3</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +------------------------------------</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>还可以传入元祖集合</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">subeg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">subgroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">subeg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># + Exception Group Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |   File \"/home/me/py311/main.py\", line 20, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># |     raise ExceptionGroup(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># | ExceptionGroup: one (2 sub-exceptions)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   | ExceptionGroup: two (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | ValueError: 3</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +------------------------------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   +---------------- 2 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   | ExceptionGroup: three (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | OSError: 4</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +------------------------------------</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"拆分成-2-个子集split\">拆分成 2 个子集：<code>split</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E6%8B%86%E5%88%86%E6%88%90-2-%E4%B8%AA%E5%AD%90%E9%9B%86split\" class=\"hash-link\" aria-label=\"Direct link to 拆分成-2-个子集split\" title=\"Direct link to 拆分成-2-个子集split\">​</a></h4>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">subeg1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> subeg2 </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">lambda</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">isinstance</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">subeg1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 与上面 subeg 相同</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">subeg2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 其余 2 个异常</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"创建子类derive\">创建子类：<code>derive</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%88%9B%E5%BB%BA%E5%AD%90%E7%B1%BBderive\" class=\"hash-link\" aria-label=\"Direct link to 创建子类derive\" title=\"Direct link to 创建子类derive\">​</a></h4>\n<p><code>subgroup</code> 和 <code>split</code> 内部调用的是一个名为 <code>derive</code> 的方法，该方法可以创建一个子类（与原类有相同的 <code>message</code>、<code>__traceback__</code>、<code>__cause__</code>, <code>__context__</code> and <code>__notes__</code>），但会重新做一些封装，我们也可以手工调用 <code>derive</code> 创建自己的子类，或在继承类中重载此方法。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">BaseExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">BaseException</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Generic</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_BaseExceptionT_co</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__new__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cls</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">Self</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> __message</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> __exceptions</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Sequence</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_BaseExceptionT_co</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> Self</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">BaseExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_ExceptionT_co</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Exception</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__new__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cls</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">Self</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> __message</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> __exceptions</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Sequence</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_ExceptionT_co</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> Self</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>注：3.11 的最终实现与 PEP654 中不同。</p>\n</blockquote>\n<ul>\n<li><code>BaseExceptionGroup</code> 和 <code>ExceptionGroup</code> 没有定义 <code>__init__</code>，仅定义了 <code>__new__</code></li>\n<li><code>__new__(cls,...) -&gt; Self</code> 实例化，入参是对象，返回该对象的实例</li>\n<li><code>__init__(self,...)</code> 初始化，self 即使用 <code>__new__</code> 创建的实例</li>\n<li>python 把实例化和初始化分开，利于我们更灵活的操作，比如：可以重载 <code>__new__</code> 方便的实现“单例类”</li>\n</ul>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// python 源码: Lib/Objects/exceptions.c</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">static</span><span class=\"token plain\"> PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">BaseExceptionGroup_derive</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">self_</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyBaseExceptionGroupObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">self </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">_PyBaseExceptionGroupObject_cast</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self_</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">excs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token constant\" style=\"color:#36acaa\">NULL</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">!</span><span class=\"token function\" style=\"color:#d73a49\">PyArg_ParseTuple</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"O\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;</span><span class=\"token plain\">excs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token constant\" style=\"color:#36acaa\">NULL</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">init_args </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyTuple_Pack</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> self</span><span class=\"token operator\" style=\"color:#393A34\">-&gt;</span><span class=\"token plain\">msg</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> excs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">!</span><span class=\"token plain\">init_args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token constant\" style=\"color:#36acaa\">NULL</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">eg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyObject_CallObject</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        PyExc_BaseExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> init_args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token function\" style=\"color:#d73a49\">Py_DECREF</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">init_args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>我们在 python 层重载基本 1 行就能达到相同的效果了：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">MyExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">derive</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> exc</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> MyGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">message</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> exc</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>目前感觉创建子类和创作 derive 方法用处不大，不多说了。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"异常处理\">异常处理<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86\" class=\"hash-link\" aria-label=\"Direct link to 异常处理\" title=\"Direct link to 异常处理\">​</a></h4>\n<p>捕获到异常组后，我们可能对这些内容感兴趣：</p>\n<ol>\n<li>组里有多少个异常，树形结构如何？</li>\n<li>每个叶子是一个具体的异常，如何提取？</li>\n<li>异常组（树）中是否有重复异常，我可不希望重复处理？</li>\n</ol>\n<p>所以首要任务是提取出所有叶子节点的异常：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">leaf_generator</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">exc</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> tbs</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> tbs </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        tbs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tbs</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">append</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">exc</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__traceback__</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token builtin\">isinstance</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">exc</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> BaseExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> e </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> exc</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">exceptions</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">yield</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> leaf_generator</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> tbs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">else</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">yield</span><span class=\"token plain\"> exc</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> tbs</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tbs</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">pop</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">v</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">v</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> e</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"eg\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> foo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    bar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> BaseException </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    eg </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> e</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">exc</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> tbs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">enumerate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">leaf_generator</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">eg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"\\n=== Exception #</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">i</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">+</span><span class=\"token string-interpolation interpolation number\" style=\"color:#36acaa\">1</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">:\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">exc</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"The complete traceback for Exception #</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">i</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">+</span><span class=\"token string-interpolation interpolation number\" style=\"color:#36acaa\">1</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">:\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> tb </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> tbs</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_tb</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tb</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># === Exception #1:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 51, in foo</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     raise ValueError(v)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ValueError: 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># The complete traceback for Exception #1:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 61, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     bar()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 57, in bar</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     raise ExceptionGroup(\"eg\", [foo(1), foo(2)])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 51, in foo</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     raise ValueError(v)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># === Exception #2:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 51, in foo</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     raise ValueError(v)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ValueError: 2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># The complete traceback for Exception #2:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 61, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     bar()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 57, in bar</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     raise ExceptionGroup(\"eg\", [foo(1), foo(2)])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 51, in foo</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     raise ValueError(v)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"tryexcept\"><code>try...except*</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#tryexcept\" class=\"hash-link\" aria-label=\"Direct link to tryexcept\" title=\"Direct link to tryexcept\">​</a></h4>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> SpamError</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> FooError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">BarError</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> BazError</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><code>except*</code> 表示每个子句可以处理多个异常，可以匹配异常组，及其子组。当匹配子组后，剩余的异常有后续的 <code>except*</code> 匹配。</p>\n<p>所以，一个异常组可能导致多个 <code>except*</code> 被命中，但每次命中只会执行一次。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token string\" style=\"color:#e3116c\">\"one\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"two\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"three\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 只会命中并执行一次，不会进来两次</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 原理是：eg = origin_eg.subgroup((ValueError, OSError))</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"ValueError and OSError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">eg</span><span class=\"token string-interpolation interpolation conversion-option punctuation\" style=\"color:#393A34\">!r</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> TypeError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"TypeError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">eg</span><span class=\"token string-interpolation interpolation conversion-option punctuation\" style=\"color:#393A34\">!r</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ValueError and OSError: ExceptionGroup('one', [ExceptionGroup('two', [ValueError(3)]), ExceptionGroup('three', [OSError(4)])])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># TypeError: ExceptionGroup('one', [TypeError(1), ExceptionGroup('two', [TypeError(2)])])</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"naked-exception\">Naked Exception<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#naked-exception\" class=\"hash-link\" aria-label=\"Direct link to Naked Exception\" title=\"Direct link to Naked Exception\">​</a></h4>\n<p>python 将 <code>raise</code> 后面没有具体异常的用法称为裸异常。裸异常通常在 <code>except</code> 中再次抛出：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> BlockingIOError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># BlockingIOError()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># BlockingIOError()</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但此时即使不是裸异常，输出也是一样的：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> BlockingIOError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> e</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># BlockingIOError()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># BlockingIOError()</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>那区别是是什么？—— 裸异常在 <code>except</code> 中二次引发异常时，<code>raise</code> 和 <code>raise e</code> 并不等效：</p>\n<ul>\n<li><code>raise</code>: 不会将当前 frame 添加到调用栈里。</li>\n<li><code>raise e</code>: 会添加。</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> ZeroDivisionError</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 146, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     foobar()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 141, in foobar</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     1 / 0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     ~~^~~</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ZeroDivisionError: division by zer</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> ZeroDivisionError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> e</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 146, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     foobar()</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 143, in foobar</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     raise e</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 141, in foobar</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     1 / 0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     ~~^~~</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ZeroDivisionError: division by zero</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>说回异常组，当在 <code>try...except*</code> 中捕获到一般异常，而不是异常组时，此时的一般异常对于 <code>except*</code> 来说也可以视为裸异常。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> BlockingIOError</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> OSError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> eg</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># BlockingIOError 是 OSError 的子类</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">eg</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ExceptionGroup('', (BlockingIOError(),))</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>当用 <code>except*</code> 捕获到裸异常，则生成一个 message 为空的 <code>ExceptionGroup(\"\", &lt;普通异常&gt;)</code>。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"在-except-中引发异常\">在 <code>except*</code> 中引发异常<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%9C%A8-except-%E4%B8%AD%E5%BC%95%E5%8F%91%E5%BC%82%E5%B8%B8\" class=\"hash-link\" aria-label=\"Direct link to 在-except-中引发异常\" title=\"Direct link to 在-except-中引发异常\">​</a></h4>\n<p>我们继续来研究二次抛出异常的问题，看看异常组是如何处理的。</p>\n<ul>\n<li>隐式抛出（二次抛出裸异常）</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token string\" style=\"color:#e3116c\">\"eg\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"nested\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">6</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> ValueError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"*ValueError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">e</span><span class=\"token string-interpolation interpolation conversion-option punctuation\" style=\"color:#393A34\">!r</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [1,[4]]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\">                        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 隐式抛出（二次抛出裸异常）</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> OSError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"*OSError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">e</span><span class=\"token string-interpolation interpolation conversion-option punctuation\" style=\"color:#393A34\">!r</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [3,[6]]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> ExceptionGroup </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [1,2,[4,5]]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># *ValueError: ExceptionGroup('eg', [ValueError(1), ExceptionGroup('nested', [ValueError(4)])])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># *OSError: ExceptionGroup('eg', [OSError(3), ExceptionGroup('nested', [OSError(6)])])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ExceptionGroup('eg', [ValueError(1), TypeError(2), ExceptionGroup('nested', [ValueError(4), TypeError(5)])])</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>显式抛出（二次抛出非裸异常）</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token string\" style=\"color:#e3116c\">\"eg\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"nested\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TypeError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> OSError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">6</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> ValueError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"*ValueError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">e</span><span class=\"token string-interpolation interpolation conversion-option punctuation\" style=\"color:#393A34\">!r</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [1,[4]]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> e                       </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 显式抛出（二次抛出非裸异常）</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> OSError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"*OSError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">e</span><span class=\"token string-interpolation interpolation conversion-option punctuation\" style=\"color:#393A34\">!r</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [3,[6]]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> ExceptionGroup </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [1,[4]],[2,[5]]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># *ValueError: ExceptionGroup('eg', [ValueError(1), ExceptionGroup('nested', [ValueError(4)])])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># *OSError: ExceptionGroup('eg', [OSError(3), ExceptionGroup('nested', [OSError(6)])])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ExceptionGroup('', [</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   ExceptionGroup('eg', [</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       ValueError(1),</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       ExceptionGroup('nested', [</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#           ValueError(4)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       ])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   ]),</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   ExceptionGroup('eg', [</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       TypeError(2),</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       ExceptionGroup('nested', [TypeError(5)])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   ])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ])</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>链式抛出（Chaining）：捕获到异常后，重新抛出一个新异常。</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"eg\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"a\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> ValueError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> KeyError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 另一种写法：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> ExceptionGroup </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">repr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ExceptionGroup('', [KeyError(ExceptionGroup('eg', [ValueError('a')]))])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    traceback</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">print_exception</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   | ExceptionGroup:  (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | Exception Group Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     |   File \"/home/me/py311/main.py\", line 142, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     |     raise ExceptionGroup(\"eg\", [ValueError(\"a\")])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | ExceptionGroup: eg (1 sub-exception)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     +-+---------------- 1 ----------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       | ValueError: a</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#       +------------------------------------</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     |</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | During handling of the above exception, another exception occurred:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     |</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     |   File \"/home/me/py311/main.py\", line 144, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     |     raise KeyError(e)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     | KeyError: ExceptionGroup('eg', [ValueError('a')])</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><strong>总结</strong>：</p>\n<ul>\n<li>隐式抛出得到 <code>[1,2,[4,5]]</code>，显式抛出得到 <code>[1,[4]],[2,[5]]</code>。</li>\n<li>最外层的异常捕获在做“聚合”操作：重新抛弃的异常和未处理的异常被聚合在一起。<!-- -->\n<ul>\n<li>隐式抛出的聚合结构与原始异常组一致。</li>\n<li>显式抛出的聚合结构是将被抛异常与未处理异常做拼接，得到新的异常组。</li>\n</ul>\n</li>\n<li>链式抛出：在恰当的位置得到 <code>During handling of the above exception, another exception occurred:</code> 的提示。</li>\n<li><code>except*</code> 中构造而异常组是个临时变量，不会影响原异常组的结构。</li>\n</ul>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"禁止-except--except-混用\">禁止 <code>except</code> &amp; <code>except*</code> 混用<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E7%A6%81%E6%AD%A2-except--except-%E6%B7%B7%E7%94%A8\" class=\"hash-link\" aria-label=\"Direct link to 禁止-except--except-混用\" title=\"Direct link to 禁止-except--except-混用\">​</a></h4>\n<p>flake8 已经能报错：</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">SyntaxError: cannot have both 'except' and 'except*' on the same 'try'flake8(E999)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"捕获-exceptiongroupbaseexceptiongroup-使用-except-而不能用-except\">捕获 <code>ExceptionGroup</code>、<code>BaseExceptionGroup</code> 使用 <code>except</code> 而不能用 <code>except*</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E6%8D%95%E8%8E%B7-exceptiongroupbaseexceptiongroup-%E4%BD%BF%E7%94%A8-except-%E8%80%8C%E4%B8%8D%E8%83%BD%E7%94%A8-except\" class=\"hash-link\" aria-label=\"Direct link to 捕获-exceptiongroupbaseexceptiongroup-使用-except-而不能用-except\" title=\"Direct link to 捕获-exceptiongroupbaseexceptiongroup-使用-except-而不能用-except\">​</a></h4>\n<p>flake8 &amp; pylint 当前无法静态检查，但运行时会报错：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> ExceptionGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/home/me/py311/main.py\", line 152, in &lt;module&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     except* ExceptionGroup:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># TypeError: catching ExceptionGroup with except* is not allowed. Use except instead.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"禁止使用-except-空匹配\">禁止使用 <code>except*:</code> 空匹配<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E7%A6%81%E6%AD%A2%E4%BD%BF%E7%94%A8-except-%E7%A9%BA%E5%8C%B9%E9%85%8D\" class=\"hash-link\" aria-label=\"Direct link to 禁止使用-except-空匹配\" title=\"Direct link to 禁止使用-except-空匹配\">​</a></h4>\n<p>flake8 已经能报错：</p>\n<div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">SyntaxError: expected one or more exception typesflake8(E999)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"标准库\">标准库<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E6%A0%87%E5%87%86%E5%BA%93\" class=\"hash-link\" aria-label=\"Direct link to 标准库\" title=\"Direct link to 标准库\">​</a></h2>\n<p><a href=\"https://pybit.es/articles/finding-new-and-removed-python-3-11-modules-in-8-lines-of-code/\" target=\"_blank\" rel=\"noopener noreferrer\">8 行代码找到 3.11 标准库的变更</a>:</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python3.10 REPL - pickling module names</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token operator\" style=\"color:#393A34\">&gt;&gt;</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> sys</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token operator\" style=\"color:#393A34\">&gt;&gt;</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> </span><span class=\"token builtin\">open</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"mods\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"wb\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> f</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">     pickle</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">dump</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">stdlib_module_names</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> f</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python3.11 REPL - compare</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token operator\" style=\"color:#393A34\">&gt;&gt;</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> sys</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token operator\" style=\"color:#393A34\">&gt;&gt;</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> </span><span class=\"token builtin\">open</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"mods\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"rb\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> f</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">     mods_310 </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> pickle</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">load</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">f</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># added</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token operator\" style=\"color:#393A34\">&gt;&gt;</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">stdlib_module_names </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\"> mods_310</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token builtin\">frozenset</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">'_typing'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'_scproxy'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'_tokenize'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'tomllib'</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># removed</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token operator\" style=\"color:#393A34\">&gt;&gt;</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> mods_310 </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\"> sys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">stdlib_module_names</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token builtin\">frozenset</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">'binhex'</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"tomllib-pep-680\">tomllib: <a href=\"https://peps.python.org/pep-0680/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 680</a><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#tomllib-pep-680\" class=\"hash-link\" aria-label=\"Direct link to tomllib-pep-680\" title=\"Direct link to tomllib-pep-680\">​</a></h3>\n<p>标准库新增了 TOML 配置文件格式的解析库。虽然 toml 格式已经存在了十多年，但 python 并没有引入标准库。</p>\n<p>python 同时也表明以后包或项目的元数据 TOML 将作为首选格式。</p>\n<p>pytp 的 pyproject.toml：</p>\n<div class=\"language-yml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yml codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">build</span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\">system</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">requires = </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"setuptools\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"wheel\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">tool.black</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\">`</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">line</span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\">length = 88`</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">target</span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\">version = </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'py37'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">tool.flake8</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">line</span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\">length = 88</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>对于 <code>[foo.bar]</code> 是拆分为 2 个索引的。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> tomllib</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> </span><span class=\"token builtin\">open</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"pyproject.toml\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"rb\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> f</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    data </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> tomllib</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">load</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">f</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">             </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># &lt;class 'dict'&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"build-system\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">   </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># {'requires': ['setuptools', 'wheel']}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"tool\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"tool\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"black\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># {'line-length': 88, 'target-version': ['py37']}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"tool\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"flake8\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># {'line-length': 88}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"asynciotaskgroup\"><a href=\"http://10.7.225.106:8888/python/python-doc/cn/python-3.11.0-docs-html/library/asyncio-task.html#asyncio.TaskGroup\" target=\"_blank\" rel=\"noopener noreferrer\">asyncio.TaskGroup</a><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#asynciotaskgroup\" class=\"hash-link\" aria-label=\"Direct link to asynciotaskgroup\" title=\"Direct link to asynciotaskgroup\">​</a></h3>\n<p>新增 <code>asyncio.TaskGroup</code> 未来用于替代 <code>asyncio.gather</code>。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"复习-awaitable\">复习 awaitable<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%A4%8D%E4%B9%A0-awaitable\" class=\"hash-link\" aria-label=\"Direct link to 复习 awaitable\" title=\"Direct link to 复习 awaitable\">​</a></h4>\n<p>aws 是 awaitable 的复数，asyncio 定义了 3 种 awaitable 对象：</p>\n<ol>\n<li>协程对象（指调用协程函数返回的对象）<!-- -->\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> i</span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\">i</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 能执行，但得不到结果</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>task: 用于并行调度协程的对象，基于协程函数创建<!-- -->\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    task </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> task</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">result</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 可以通过 task 得到结果，cancel等操作</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>Futures：底层对象，表示一个异步操作的结果，基于协程函数、task、future 和 loop 创建。<!-- -->\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    future </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> loop</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> future         </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 其实此处也是 task</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">result</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n</ol>\n<ul>\n<li><strong>Task 是 Future 的子类</strong>，所以具有 Future 的 <code>result()</code>、<code>done()</code>、<code>cancell()</code>、<code>add_done_callback</code> 等方法。</li>\n<li><code>ensure_future()</code> 返回的其实也是 Task（所以我们真的很少需要直接接触 Future），其实 <code>ensure_future()</code> 底层也会调用 <code>create_task()</code>，所以 Future 相比 Task 是底层，但 <code>ensure_future()</code> 相比 <code>create_task()</code> 却是上层。</li>\n</ul>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python-src/Lib/asyncio/tasks.py</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">_ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro_or_future</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> loop</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> loop </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        loop </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> events</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_get_event_loop</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">stacklevel</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> loop</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro_or_future</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> context</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    loop </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> events</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_running_loop</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> context </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        task </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> loop</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">else</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        task </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> loop</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> context</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">context</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><code>ensure_future()</code> 和 <code>create_task()</code> 都会首先获取 loop，前者获取 <code>_get_event_loop</code>，后者 <code>get_running_loop</code>，所以在没有 loop 的环境下执行会有差异，比如 py 文件的第一级写如下代码：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">task </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># error：RuntimeError: no running event loop —— 报错退出</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">futu </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># py3.9- PASS; py3.10+: DeprecationWarning: There is no current event loop</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果写在某个函数中，用 <code>asyncio.run()</code> 调用，则都 OK。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>上面代码演示的都是 awaitable 对象<strong>同步、串行</strong>执行的方式（通过 <code>await</code> 关键字），<strong>异步、并发</strong>执行则需要 <code>asyncio.gather()</code> 或 <code>asyncio.wait()</code> 上场了。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"复习-asynciogather--asynciowait\">复习 <code>asyncio.gather()</code> &amp; <code>asyncio.wait()</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%A4%8D%E4%B9%A0-asynciogather--asynciowait\" class=\"hash-link\" aria-label=\"Direct link to 复习-asynciogather--asynciowait\" title=\"Direct link to 复习-asynciogather--asynciowait\">​</a></h4>\n<p>函数签名：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">awaitable asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">gather</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">aws</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_exceptions</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>**并发（多个 awaitable 交替运行）**的典型方法是：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _w </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> random</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">randint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sleep</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_w</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> i</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    futus </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">10</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">gather</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">futus</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># await asyncio.wait([*tasks, *futus])</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 2 12</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 3 10</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 4 0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 4 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 4 2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 5 11</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<blockquote>\n<p>注：上例仍是同步的，即线程（协程）在等待并发的协程完成才继续走。但这是为了便于演示，弄清楚了并发，设计一个异步并不是难事儿。</p>\n</blockquote>\n<p><code>gather</code> 和 <code>wait</code> 能达到差不多的并发效果，但在入参、返回值、如何取消等方面还是有差异：</p>\n<p>文档：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># doc</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">coroutine asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">wait</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">aws</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> timeout</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_when</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">ALL_COMPLETED</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">done</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> pending</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">awaitable asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">gather</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">aws</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_exceptions</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> GatheringFuture</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>源码：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python_src/Libasyncio/tasks.py</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">wait</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">fs</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> timeout</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_when</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">ALL_COMPLETED</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">gather</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">coros_or_futures</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_exceptions</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>签名不同：<!-- -->\n<ul>\n<li><code>wait</code> 是个协程函数，返回 task 的集合，<code>await</code> 的是个协程函数；</li>\n<li><code>gather</code> 是个普通函数，返回 Future，<code>await</code> 该 Future 得到 tasks 的运行结果列表。</li>\n</ul>\n</li>\n<li>入参、返回值不同：<!-- -->\n<ul>\n<li><code>wait</code> 入参是个无序集合，返回值也是无序的，还是个元祖：<code>(已完成, 未完成)</code>；</li>\n<li><code>gather</code> 入参是依次多个 awaitable，返回值也是个 awaitable(与入参相同顺序的 list)。</li>\n</ul>\n</li>\n</ul>\n<p><code>wait</code> 的入参 <code>return_when</code> 有 3 个可选值，控制 <code>wait</code> 函数的返回时机：</p>\n<ul>\n<li><code>ALL_COMPLETED</code>(默认)：所有 task 完成，<code>wait</code> 才完成，此时 done 有包含所有 task，pending 没有 task。</li>\n<li><code>FIRST_EXCEPTION</code>：某一个 task 异常，<code>wait</code> 即完成，此时 done、pending 可能都有 task。</li>\n<li><code>FIRST_COMPLETED</code>：某一个 task 完成，<code>wait</code> 即完成，此时 done 仅有 1 个 task，pending 包含其他 task。——下面代码演示：</li>\n</ul>\n<p>但即使 <code>wait</code> 返回了，其他 task 还是在继续运行的：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _w </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> random</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">randint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sleep</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    futus </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">10</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    done</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> pending </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">wait</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">futus</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_when</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">FIRST_COMPLETED</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_state</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">result</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> done</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_state</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> pending</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sleep</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_state</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">result</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> done</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_state</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">result</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> pending</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [('Task-7', 'FINISHED', (12, 1))]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [('Task-6', 'PENDING'), ('Task-4', 'PENDING'), ('Task-5', 'PENDING'), ('Task-3', 'PENDING'), ('Task-2', 'PENDING')]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [('Task-7', 'FINISHED', (12, 1))]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [('Task-6', 'FINISHED', (11, 5)), ('Task-4', 'FINISHED', (2, 5)), ('Task-5', 'FINISHED', (10, 5)), ('Task-3', 'FINISHED', (1, 2)), ('Task-2', 'FINISHED', (0, 2))]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>可见经过一段时间后，原来 <code>PENDING</code> 的 5 个 task 都 <code>FINISHED</code> 了，并且计算出了正确的结果。</p>\n<p>但是如果遇到某个（些） task 抛异常，<code>wait</code> 的表现会很怪异：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _w </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> random</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">randint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sleep</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    i </span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\"> _w  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 当 _w = 0 时异常</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    futus </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">10</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        done</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> pending </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">wait</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">futus</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_when</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ALL_COMPLETED</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">finally</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_state</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> done</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># print([(_task.get_name(), _task._state, _task.result()) for _task in done]) # 主动引发异常</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_state</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> pending</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 2</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 3</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [('Task-6', 'FINISHED'), ('Task-4', 'FINISHED'), ('Task-7', 'FINISHED'), ('Task-5', 'FINISHED'), ('Task-3', 'FINISHED'), ('Task-2', 'FINISHED')]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># []</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Task exception was never retrieved</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># future: &lt;Task finished name='Task-6' coro=&lt;foobar() done, defined at /data/kevin/workspace/zproject/me/ME/blog/2022-11-11-python3.11/main.py:5&gt; exception=ZeroDivisionError('division by zero')&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Traceback (most recent call last):</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#   File \"/data/kevin/workspace/zproject/me/ME/blog/2022-11-11-python3.11/main.py\", line 9, in foobar</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     i / _w  # 当 _w = 0 时异常</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#     ~~^~~~</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># ZeroDivisionError: division by zero</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>其中的 except 并不能捕获异常，当退出 <code>main()</code> 前释放 task 时会触发异常，如果去掉“主动引发异常”那行，则会在调用 <code>_task.result()</code> 时就触发异常。—— <code>wait</code> 处理异常的方式就比较蹩脚，想捕获看不到，不小心又触雷。</p>\n<p>再来聊聊 <code>gather()</code>:</p>\n<p><code>gather</code> 的入参 <code>return_exceptions</code> 含义是是否将异常和普通 result 一样对待，常规返回，有 2 个可选值：</p>\n<ul>\n<li><code>False</code>(默认)：不随 result 一起返回，即：一旦某个 task 引发异常，则等待 <code>gather</code> 的外部任务立即感知，但其他 tasks 是不会被取消的，会继续在并发协程里运行。</li>\n<li><code>True</code>：异常随 result 一起返回。</li>\n</ul>\n<p>下面代码演示 True 时情况:</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _w </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> random</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">randint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sleep</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    i </span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\"> _w  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 当 _w = 0 时异常</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> i</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    futus </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">10</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _results </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">gather</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">futus</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_exceptions</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_results</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># [ZeroDivisionError('division by zero'), 2, 4, 20, 22, 24]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果 False，则会直接引发异常，就需要 <code>try...except</code> 上场了：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _w </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> random</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">randint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sleep</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    i </span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\"> _w  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 当 _w = 0 时异常</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> i</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    futus </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ensure_future</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">10</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        _results </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">gather</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">futus</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> return_exceptions</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">finally</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># print(_results)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>第一个抛异常的 task 会让 <code>gather()</code> 退出，此时不能 <code>print(_results)</code>，因为 <code>_results</code> 是没有定义的。</p>\n<p>总结一下对于 task 抛出的异常处理，<code>gather</code> 和 <code>wait</code> 策略异同：</p>\n<ul>\n<li><code>wait</code> 的 <code>return_when</code> 控制返回时机，区分异常；抛异常的 task 视同正常完成的 task，放入 done 列表中；所以外层不捕获异常，但对异常 task 执行 <code>task.result()</code> 则引发异常，如果不处理异常销毁 task 时也会引发看似莫名其妙的异常。。</li>\n<li><code>gather</code> 的 <code>return_exceptions</code> 控制返回时机和返回值，<code>True</code> 是一起返回，异常放入返回值，<code>False</code> 是异常立即返回，外层可以捕获到异常，但其他 task 的返回值获取变得困难。</li>\n</ul>\n<p>如何更加优雅的统筹 “返回时机”、“返回值”、“异常处理” 处理方式 —— 就是 python3.11 设计 <code>asyncio.TaskGroup</code> 的初衷。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"class-asynciotaskgroup\"><code>class asyncio.TaskGroup</code><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#class-asynciotaskgroup\" class=\"hash-link\" aria-label=\"Direct link to class-asynciotaskgroup\" title=\"Direct link to class-asynciotaskgroup\">​</a></h4>\n<p><code>TaskGroup</code> 是个 class，目前只公开了一个方法：<strong><code>create_task()</code> - 将协程函数封装成 task</strong>，和一个 <code>async with...as...</code> 的用法 —— 简练而不简单。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> context</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>源码实现也不复杂</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python_src/Lib/asyncio/taskgroups.py</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">TaskGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> coro</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> context</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> context </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            task </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_loop</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">else</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            task </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_loop</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">coro</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> context</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">context</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_set_task_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">task</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">add_done_callback</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_on_task_done</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">add</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">task</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> task</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>官方推荐 <code>async with...as...</code> 典型用法：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">TaskGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> tg</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">tg</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">result</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>先说设计目标（即：当前的已实现的功能）：</p>\n<ul>\n<li><code>async with...as...</code> 语句将等待组中所有 task 完成才退出，退出前执行 <code>tg.__aexit__()</code>。</li>\n<li>tg 执行期间，可以随时使用 <code>tg.create_task()</code> 添加新任务到组中。tg 已经全部完成之后不能再添加。</li>\n<li>组内某个 task 被取消（抛出 <code>asyncio.CancelledError</code> 异常），组内其他 task 不受影响。—— <strong>可以单独取消某个 task，不波及其他 task。</strong></li>\n<li>组内任何 task 抛出非 <code>asyncio.CancelledError</code> 的异常，组内其他任务将全部被 Cancell。—— <strong>其他异常时，组内 task 同进退。</strong></li>\n<li>所有在 <code>async with...as...</code> 中抛出的异常都是异常组，所以建议 <code>try...except*</code> 捕获。</li>\n</ul>\n<p>看下面代码</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> asyncio</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> random</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _w </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> random</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">randint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 随机 sleep _w 秒</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">await</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sleep</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_w</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> _w </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ValueError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> _w </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">CancelledError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> _w </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">TimeoutError</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> i </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> i</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">async</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">TaskGroup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> tg</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">tg</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create_task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">_i</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _i </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">range</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">result</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> ValueError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Catch ValueError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">e</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> Exception </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Catch Exception: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">e</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">CancelledError </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> ce</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># `CancelledError` 比较特殊，继承自 `BaseException`</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Catch CancelledError: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">ce</span><span class=\"token string-interpolation interpolation operator\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">finally</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_name</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_state</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 打印所有 task 最终的结束状态</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">asyncio</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>多次运行 <code>$ time python main.py</code>，得到几种不同的结果：</p>\n<ul>\n<li><strong>所有 task 无异常</strong>\n<ul>\n<li>3 个 task 都正常结束，执行了 <code>async with...as...</code> 外的 print 语句。<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">0 4</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">1 4</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">2 5</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[0, 2, 4]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[('0', 'FINISHED'), ('1', 'FINISHED'), ('2', 'FINISHED')]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python main.py  0.10s user 0.01s system 2% cpu 5.105 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n</ul>\n</li>\n<li><strong>取消异常：不波及其他</strong>\n<ul>\n<li>0 号 task 抛出 <code>CancelledError</code>，不影响其他 task 运行到 <code>FINISHED</code>，总共耗时 4s。<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">0 2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">1 4</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">2 4</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Catch CancelledError: ce=CancelledError(0)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[('0', 'CANCELLED'), ('1', 'FINISHED'), ('2', 'FINISHED')]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python main.py  0.07s user 0.02s system 2% cpu 4.092 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>0、1 号 task （几乎）同时抛 <code>CancelledError</code> 异常，也不波及剩下的 1 个 task，4s 才退出。<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">0 2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">1 2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">2 4</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Catch CancelledError: ce=CancelledError(0)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[('0', 'CANCELLED'), ('1', 'CANCELLED'), ('2', 'FINISHED')]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python main.py  0.10s user 0.00s system 2% cpu 4.104 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n</ul>\n</li>\n<li><strong>普通异常：同进退、异常组</strong>\n<ul>\n<li>2 号 task 1s 时抛出普通异常，立即退出，其他 task 以 <code>CANCELLED</code> 结束，即使其他 task 在 3s 后也会抛异常（没机会了），捕获到的是异常组。<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">0 3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">1 3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">2 1</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Catch Exception: e=ExceptionGroup('unhandled errors in a TaskGroup', [ValueError(2)])</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[('0', 'CANCELLED'), ('1', 'CANCELLED'), ('2', 'FINISHED')]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python main.py  0.09s user 0.01s system 8% cpu 1.099 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n<li>1、2 号 task （几乎）同时抛 <code>TimeoutError</code> 异常，会自动组合成异常组，而不会其中 1 个 cancell 掉另一个。—— <strong>临近的普通异常自动组合</strong>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">0 5</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">1 3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">2 3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Catch Exception: e=ExceptionGroup('unhandled errors in a TaskGroup', [TimeoutError(1), TimeoutError(2)])</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[('0', 'CANCELLED'), ('1', 'FINISHED'), ('2', 'FINISHED')]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python main.py  0.08s user 0.00s system 2% cpu 3.088 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n</ul>\n</li>\n<li><strong>取消 + 普通异常：不波及、其余同进退、异常组</strong>\n<ul>\n<li>2 个 <code>CancelledError</code> + 1 个普通异常：普通异常合成异常组，4s 才退出。<!-- -->\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">0 3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">1 2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">2 2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Catch Exception: e=ExceptionGroup('unhandled errors in a TaskGroup', [TimeoutError(0)])</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[('0', 'FINISHED'), ('1', 'CANCELLED'), ('2', 'CANCELLED')]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python main.py  0.09s user 0.01s system 3% cpu 3.105 total</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n</li>\n</ul>\n</li>\n</ul>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"taskgroupgatherwait-对比\"><code>TaskGroup</code>、<code>gather</code>、<code>wait</code> 对比<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#taskgroupgatherwait-%E5%AF%B9%E6%AF%94\" class=\"hash-link\" aria-label=\"Direct link to taskgroupgatherwait-对比\" title=\"Direct link to taskgroupgatherwait-对比\">​</a></h4>\n<table><thead><tr><th>特性</th><th><code>results = await gather()</code></th><th><code>(done, pending) = await wait()</code></th><th><code>async with TaskGroup() as tg</code></th></tr></thead><tbody><tr><td>返回时机</td><td><code>return_exceptions</code> 控制：<code>True</code>全完成共同返回；<code>False</code>首异常立即返回。</td><td><code>return_when</code> 控制：全完成共同、首异常立即、首完成立即。</td><td>非取消异常立即返回；其他全完成共同返回；</td></tr><tr><td>返回值</td><td><code>Future.results()</code></td><td><code>(done, pending)</code></td><td></td></tr><tr><td>外层捕获异常</td><td>全完成共同返回时遍历查找返回值找出异常；首异常立即返回时可捕获。</td><td>异常处理有坑，遇到异常 <code>result()</code> 或销毁时才会遇到。</td><td>都需要外层捕获</td></tr></tbody></table>\n<p>所以:</p>\n<ul>\n<li>3 种方式都可以实现“<strong>全完成共同返回、首异常立即返回</strong>”，<code>gather</code> 和 <code>wait</code> 需要用入参控制，<code>TaskGroup</code> 没法控制。</li>\n<li><code>gather</code> 便于获取 result；<code>wait</code> 便于按状态分组；<code>TaskGroup</code> 便于绑定 task 命运共同体。</li>\n<li>如需要实现取消 1 个 task 而不影响组中其他 task 的需求时：<code>gather</code> 和 <code>wait</code> 受限或无法实现， <code>TaskGroup</code> 则就是为此而生的。</li>\n</ul>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"typingtypevartuple-pep-646\">typing.TypeVarTuple: <a href=\"https://peps.python.org/pep-0646/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 646</a><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#typingtypevartuple-pep-646\" class=\"hash-link\" aria-label=\"Direct link to typingtypevartuple-pep-646\" title=\"Direct link to typingtypevartuple-pep-646\">​</a></h3>\n<ul>\n<li>Python3.5 引入了 <a href=\"https://peps.python.org/pep-0484/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 484</a> 规范的类型标注（typing hints），定义了用于类型检查而 <code>Any</code>, <code>Union</code>, <code>Tuple</code>, <code>Callable</code>等，用于泛型的 <code>TypeVar</code>,<code>Optional</code>和 <code>Generic</code>等；</li>\n<li>python3.10 新增了语法 <code>T = int | str</code></li>\n<li>Python3.11 引入了 <a href=\"https://peps.python.org/pep-0646/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 646</a> 规范的 <code>TypeVarTuple</code>，用于可变参数的泛型。</li>\n</ul>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"复习-typevar\">复习 TypeVar<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%A4%8D%E4%B9%A0-typevar\" class=\"hash-link\" aria-label=\"Direct link to 复习 TypeVar\" title=\"Direct link to 复习 TypeVar\">​</a></h4>\n<p>类型标注是对参数文档的替代，可以使用 mypy 工具检查，但目前不会影响运行：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"hello: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>类型标注为 str，但送入的 int 变量，mypy 可以提示错误，但仍可以正常运行。</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python main.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">hello: 100</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ mypy main.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">main.py:13: error: Argument 1 to \"foobar\" has incompatible type \"int\"; expected \"str\"  [arg-type]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>强烈建议你将 mypy 配置到 VSCode 中，开启自动检查：VSCode -- Settings -- Python&gt;Linting: Mypy Enabled -- 勾选。</p>\n<p>这样你会在 100 下面看到红色的波浪号。</p>\n<p><code>Union</code> 等类型可以做限定某些类型的入参标注，有点泛型的那个意思了：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Union</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Union</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"hello: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Tom\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: Tom</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: 100</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>python3.10 引入了 <code>T = int | str</code> 后，又多了一个等效的选择：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">U </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">|</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> U</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"hello: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Tom\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: Tom</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: 100</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>使用 TypeVar 可实现更通用的泛型：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypeVar</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">T </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"T\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"hello: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Tom\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: Tom</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: 100</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>TypeVar 可以添加任意多你指定的类型，甚至可以用 <code>TypeVar(\"T\")</code> 表示不限定类型。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> List</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Dict</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">T </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"T\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> List</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Dict</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"hello: </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Tom\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"Tom\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"Tom\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Jerry\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">99</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: Tom</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: 100</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: True</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: ['Tom', 100, True]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># hello: {'Tom': 100, 'Jerry': 99}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>TypeVar 创建一个泛型类的签名为：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># python_src/Libtyping.py</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_Final</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _Immutable</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _BoundVarianceMixin</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _PickleUsingNameMixin</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">_root</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">constraints</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> bound</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> covariant</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> contravariant</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>第一个参数是 name，后面跟类型的限制，没有则不限制，所以常见用法是：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">T </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'T'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Can be anything</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">A </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'A'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Must be str or bytes</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>所以你可能会发现：</p>\n<p><code>Union[int, str]</code> 与 <code>U = int | str</code> 与 <code>T = TypeVar('T', int, str)</code> 三者是等效的。</p>\n<p>并且似乎 <code>T = TypeVar('T') </code> 就是我们想要的泛型了，其实不然。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypeVar</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">U </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">|</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">max_1</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> U</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> U</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> U</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token builtin\">max</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">T </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"T\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">max_2</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token builtin\">max</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> b</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">max_1</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foo\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># mypy 没有给出错误提示</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">max_2</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"foo\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># mypy 可以识别标注，并给出错误提示</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Value of type variable \"T\" of \"max_2\" cannot be \"object\"  [type-var]mypy(error)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>TypeVar 比 Union 更深层而表达了泛型而一致性问题，同理：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">max_3</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">items</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">U</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> U</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token builtin\">max</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">items</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">max_4</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">items</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">T</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> T</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token builtin\">max</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">items</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">max_3</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"3\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># mypy 没有错误提示</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">max_4</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"3\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># mypy 给出错误提示</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"复习-generic\">复习 Generic<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%A4%8D%E4%B9%A0-generic\" class=\"hash-link\" aria-label=\"Direct link to 复习 Generic\" title=\"Direct link to 复习 Generic\">​</a></h4>\n<p>Generic 是个抽象基类，专用于创建泛型类型。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Generic</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> List</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">KT </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"KT\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">VT </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"VT\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">MyDict</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Generic</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">KT</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> VT</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> keys</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> List</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">KT</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> values</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> List</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">VT</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token builtin\">super</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">data </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> _k</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> _v </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">zip</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">keys</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> values</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">_k</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> _v</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__getitem__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> key</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> KT</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> VT</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">lookup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">mapping</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> MyDict</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">KT</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> VT</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> key</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> KT</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> default</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> VT</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> VT</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> mapping</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> KeyError</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> default</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_m1 </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> MyDict</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"A\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"B\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_m2 </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> MyDict</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"A\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"B\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">lookup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_m1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"A\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">lookup</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_m2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"B\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># A</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 1</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"学习-typevartuple\">学习 TypeVarTuple<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%AD%A6%E4%B9%A0-typevartuple\" class=\"hash-link\" aria-label=\"Direct link to 学习 TypeVarTuple\" title=\"Direct link to 学习 TypeVarTuple\">​</a></h4>\n<p>可变参数泛型一直是 python 社区的多年来强烈要求，比如 numpy 中换算图像矩阵：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">to_gray</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">videos</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>从签名上你无法看出 videos 是 <code>batch × time × height × width × channels</code> 还是 <code>time × batch × channels × height × width</code>，送错了参数可能很难察觉，用文档约束是历史上能用的、但不好用的手段。</p>\n<p>python 社区提议用：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">to_gray</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">videos</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">Time</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Batch</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Height</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Width</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Channels</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>即使允许了这种语法，函数的开发者将会感觉不灵活，没有泛型的加持后续升级就很难搞兼容性。</p>\n<p>python3.11 提供了新的解决方案：<code>TypeVarTuple</code></p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TypeVarTuple</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> NewType</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">DType </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'DType'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Shape </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TypeVarTuple</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'Shape'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Array</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Generic</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">DType</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__abs__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">DType</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__add__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> other</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">DType</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">DType</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Batch </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> NewType</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'Batch'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Height </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> NewType</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'Height'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Width </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> NewType</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'Width'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">channels </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> NewType</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'channels'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">to_gray</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">videos</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">float</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Batch</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Height</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Width</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> channels</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>用户调用：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Literal </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> L</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">x</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">float</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> L</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> L</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">480</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> L</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">640</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> L</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Array</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">to_gray</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">x</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"typingself-pep-673\">typing.Self: <a href=\"https://peps.python.org/pep-0673/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 673</a><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#typingself-pep-673\" class=\"hash-link\" aria-label=\"Direct link to typingself-pep-673\" title=\"Direct link to typingself-pep-673\">​</a></h3>\n<p>python3.11 之前，没有手段对返回实例自己的方法做返回值标注：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">set_scale</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> scale</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">float</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 语法错误</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_scale </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> scale</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> self</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">area</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这可以说是标注技术的一个缺陷，3.11 填补这个遗憾，python 首先想到的也是让上面的语法能够不错误，但是：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Circle</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> radius</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_r </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> radius</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_scale </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">area</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3.14</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_r </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_r </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_scale</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">c </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Circle</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">c </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> c</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">set_scale</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">0.5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># c 将用 Shape 做类型判断，而不是希望的 Circle</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">c</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">area</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>可见返回 Shape 会让继承类很尴尬，虽然不影响执行，但类型标注和类型检查还是不正确。所以：新增了 Self。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Self</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">set_scale</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> scale</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">float</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> Self</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_scale </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> scale</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> self</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">area</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Circle</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Shape</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> radius</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_r </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> radius</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_scale </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">area</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3.14</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_r </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_r </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_scale</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">cut_circle</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">circle</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Circle</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">c </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Circle</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">c </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> c</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">set_scale</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">0.5</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># 函数签名为：(method) set_scale: (scale: float) -&gt; Circle</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cut_circle</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">c</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样不但 checker 正确检查出了函数签名中返回值而标注，<code>cut_circle(c)</code> 中也不会报入参错误了。</p>\n<p>Self 也可以做方法对的参数，还有更多用法参考 PEP673。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"typingliteralstring-pep-675\">typing.LiteralString: <a href=\"https://peps.python.org/pep-0675/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 675</a><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#typingliteralstring-pep-675\" class=\"hash-link\" aria-label=\"Direct link to typingliteralstring-pep-675\" title=\"Direct link to typingliteralstring-pep-675\">​</a></h3>\n<ul>\n<li>Python3.8 引入了 <a href=\"https://peps.python.org/pep-0586/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 586</a> 规范的 <code>typing.Literal</code>（字面量）</li>\n<li>Python3.11 引入 <a href=\"https://peps.python.org/pep-0675/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 675</a> 规范的 LiteralString</li>\n</ul>\n<p>和前面一样，使用 <code>typing</code> 中的类型标注最终都是为了尽早、及时的找到 <code>TypeError</code>，无论是用 mypy 这种 checker，或者在运行时找到。</p>\n<p><code>typing.Literal</code> 是干啥的？—— 它是解决这种需求的：用户只想允许某些值（比如 3）作为变量/入参，不希望其他值（比如 1、2、4...），这种需求用 typing 中其他的类型标注实现不了，所以设计了 Literal。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Literal</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">accepts_only_four</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">x</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Literal</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">accepts_only_four</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">4</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># OK</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">accepts_only_four</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">19</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># mypy 报错：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Argument 1 to \"accepts_only_four\" has incompatible type \"Literal[19]\"; expected \"Literal[4]\"  [arg-type]mypy(error)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>或者字符字面量：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">MODE </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Literal</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"r\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"rb\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"w\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"wb\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">open_helper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> mode</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> MODE</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">open_helper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/some/path\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"r\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Passes type check</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">open_helper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/other/path\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"typo\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># mypy 报错：</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Argument 2 to \"open_helper\" has incompatible type \"Literal['typo']\"; expected \"Literal['r', 'rb', 'w', 'wb']\"  [arg-type]mypy(error)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>所谓字面量类型检查，就是要字面上一模一样匹配才算检查通过。</p>\n<p>假如有这样一个操作 SQL 数据库而函数：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">query_user</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">conn</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Connection</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> user_id</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> User</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    query </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"SELECT * FROM data WHERE user_id = </span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">user_id</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    conn</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">execute</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Transform data to a User object and return it</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>用户执行下面是正常操作：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query_user</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">conn</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"user123\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># OK.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但如果用户执行下面操作将会删除整个 table：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query_user</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">conn</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"user123; DROP TABLE data;\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如何防止这样的“SQL 注入”攻击？—— LiteralString：仅接受由已知字面量组成的字符串。</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> LiteralString</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">query_user</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sql</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> LiteralString</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>具体是如何检查错误的……似乎还没实现好，mypy 也尚不支持。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"typingdataclass_transform-pep-681\">typing.dataclass_transform: <a href=\"https://peps.python.org/pep-0681/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 681</a><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#typingdataclass_transform-pep-681\" class=\"hash-link\" aria-label=\"Direct link to typingdataclass_transform-pep-681\" title=\"Direct link to typingdataclass_transform-pep-681\">​</a></h3>\n<p>python3.7 引入了 <a href=\"https://peps.python.org/pep-0681/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 557</a> 规范的 dataclasses，用于存储数据对象（如：数据库相关联的 data 对象），这类对象一般具有的特征是：</p>\n<ul>\n<li>同类，并可比较</li>\n<li>值很重要，不需要太多方法</li>\n<li>一旦赋值，通常不可变</li>\n</ul>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"复习-dataclassesdataclass-装饰器\">复习 <code>@dataclasses.dataclass</code> 装饰器<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%A4%8D%E4%B9%A0-dataclassesdataclass-%E8%A3%85%E9%A5%B0%E5%99%A8\" class=\"hash-link\" aria-label=\"Direct link to 复习-dataclassesdataclass-装饰器\" title=\"Direct link to 复习-dataclassesdataclass-装饰器\">​</a></h4>\n<p>dataclasses 模块提供了一个装饰器 <code>@dataclass</code> 来方便我们实现这样的对象：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> dataclasses </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> dataclass</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> List</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@dataclass</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">AAU</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token builtin\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    SLAVE_NUM</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    CHN_NUM</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    BAND0</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">dict</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    opt_port</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> List</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">aau </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> AAU</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"9642A\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token builtin\">type</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"S26\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    SLAVE_NUM</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    CHN_NUM</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">32</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    BAND0</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"start_freq\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2515000</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"stop_freq\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2675000</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    opt_port</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">21</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">19</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">aau</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># output:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># AAU(name='9642A', type='S26', SLAVE_NUM=2, CHN_NUM=32, BAND0={'start_freq': 2515000, 'stop_freq': 2675000}, opt_port=[21, 19])</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>装饰器 <code>@dataclass()</code> 为你自动生成 <code>__init__()</code>, <code>__eq__()</code>、<code>__lt__()</code> 等方法，当然你也可以不让它自动生成，自己来手动实现。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"学习-typingdataclass_transform-装饰器\">学习 <code>@typing.dataclass_transform</code> 装饰器<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E5%AD%A6%E4%B9%A0-typingdataclass_transform-%E8%A3%85%E9%A5%B0%E5%99%A8\" class=\"hash-link\" aria-label=\"Direct link to 学习-typingdataclass_transform-装饰器\" title=\"Direct link to 学习-typingdataclass_transform-装饰�器\">​</a></h4>\n<p>待补充</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"typingtypeddict-pep-655\">typing.TypedDict: <a href=\"https://peps.python.org/pep-0655/\" target=\"_blank\" rel=\"noopener noreferrer\">PEP 655</a><a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#typingtypeddict-pep-655\" class=\"hash-link\" aria-label=\"Direct link to typingtypeddict-pep-655\" title=\"Direct link to typingtypeddict-pep-655\">​</a></h3>\n<p>python3.8 引入了 <code>typing.TypedDict</code>，让字典类型使用更方便：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypedDict</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Point2D</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">TypedDict</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    y</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    label</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">a</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Point2D </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"x\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"y\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"label\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"good\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># OK</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">b</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Point2D </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"z\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"label\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"bad\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Fails type check</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">c</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Point2D </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"label\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"bad\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Fails type check</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">assert</span><span class=\"token plain\"> Point2D</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">x</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> y</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> label</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"first\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token builtin\">dict</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">x</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> y</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> label</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"first\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ol>\n<li>定义、赋值都更方便了</li>\n<li>增加不满足预期的 <code>key: value</code> 会报错（如：b 中增加了 z）</li>\n<li>没有定义需要的 <code>key: value</code> 也会报错（如：c 中缺少 x、y）</li>\n</ol>\n<p>后 2 点有点极端，不能多也不能缺，而 PEP 655 通过引入 <code>Required[]</code> 和 <code>NotRequired[]</code> 可以让 TypedDict 里面的键的定义明确是否强依赖:</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> TypedDict</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Required</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> NotRequired</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Point2D</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">TypedDict</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    x</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Required</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    y</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> NotRequired</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    label</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样在实例化对象时检查器就能够正确区分了。这种功能在 typescript 和 go 中最初就设计了，python 发展了 20 年了才加入。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"getmembers_static\">getmembers_static<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#getmembers_static\" class=\"hash-link\" aria-label=\"Direct link to getmembers_static\" title=\"Direct link to getmembers_static\">​</a></h3>\n<p>3.11 之前：</p>\n<p><code>getattr(obj, attrname)</code> 和 <code>hasattr(obj, attrname)</code> 都可能会在获取或者判断属性是否存在时触发代码执行，尤其是写在获取目标所在 py 文件根级别下的代码都会被执行，及其 import 的文件。</p>\n<p><code>inspect.getmembers(obj)</code> 获取 obj 所有的属性，同样也会触发代码的执行。</p>\n<p>为了更省资源的获取属性和方法，python3.2 引入了 <code>inspect.getattr_static(obj, attrname)</code>，可以静态的内省，获取属性而不触发动态查找功能，但只是获取指定 name 的 attr。获取所有 members 没有静态的方法。</p>\n<p>3.11，时隔 9 年，终于加入了 <code>inspect.getmembers_static(obj)</code> —— 终于有了静态内省获取所有成员的函数了。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"缺陷与陷阱\">缺陷与陷阱<a href=\"https://wkevin.github.io/blog/2022/11/10/python3.11#%E7%BC%BA%E9%99%B7%E4%B8%8E%E9%99%B7%E9%98%B1\" class=\"hash-link\" aria-label=\"Direct link to 缺陷与陷阱\" title=\"Direct link to 缺陷与陷阱\">​</a></h2>\n<p>最后，泼一点冷水。</p>\n<p>不要升级这么快，至少等到几个月后的 3.11.1 或 3.11.2，一般这 2 个都是比较重要或重大的 bugfix，追求稳定性的话，不如再等几个月。</p>\n<p>其次，distutils 曾经是 python 打包的官方必选，写个 setup.py 就能打包了，但 distutils 即将与 3.12 废弃，3.11 中也开始提示预废弃，并提示用 setuptools 替代。setuptools 使用 setup.cfg 作为打包配置文件，为了兼容，python 官方推荐用 setuptools 入口运行 setup.py —— 一个蹩脚的方案。</p>\n<p>setup.cfg 当前简直是个垃圾桶，大量与打包无关的内容写入其中，而不是更应该去的 project.toml，使得 setup 这个单词失去了应有的意义。这可能是官方此次加入 tomllib 的用意吧：赶紧吧 project.toml 给我用起来。</p>",
            "url": "https://wkevin.github.io/blog/2022/11/10/python3.11",
            "title": "Python3.11 介绍",
            "summary": "python3.11",
            "date_modified": "2022-11-10T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "python",
                "python3.11",
                "TaskGroup",
                "try...except*",
                "TypeVarTuple",
                "LiteralString",
                "dataclass_transform",
                "TypedDict"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/10/14/git.daemon",
            "content_html": "<p>局域网内多人之间、个人多台电脑之间 —— 如何快速分享、互传 git 管理的代码？</p>\n<ul>\n<li>邮件？</li>\n<li>ftp？</li>\n<li><code>scp [-P &lt;port&gt;] &lt;src-file&gt; &lt;user&gt;@&lt;ip&gt;/&lt;dst-file&gt;</code></li>\n<li><code>python -m http.server</code></li>\n<li><code>npm install http-server -g</code> then <code>http-server &lt;root/dir&gt; [-p &lt;port&gt;]</code> ?</li>\n</ul>\n<p>上面都行，但文件要逐个传或打包，然后手工合并……不妨用 git 内置的 server 来处理:</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git daemon</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"server\">Server<a href=\"https://wkevin.github.io/blog/2022/10/14/git.daemon#server\" class=\"hash-link\" aria-label=\"Direct link to Server\" title=\"Direct link to Server\">​</a></h2>\n<ul>\n<li>创建一个空的项目库。</li>\n</ul>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ mkdir repos</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cd repos</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ mkdir myproject-repo.git</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cd myproject-repo.git</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git init</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cd ../../</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>在本地可以用相对路径直接 push 代码</li>\n</ul>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cd myproject</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git push ../repos/myproject-repo.git foo-branch:bar-branch</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>如果还想从这个库里 fetch 代码，那还要创建 remote</li>\n</ul>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git remote add local ../repos/myproject-repo.git</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>打开防火墙的 9418 端口</li>\n</ul>\n<p>windowns 和 linux 不同，各自找办法吧。</p>\n<ul>\n<li>启动 daemon 服务</li>\n</ul>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git daemon --base-path=. --export-all --reuseaddr --informative-errors --verbose</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>上面是只读的，如果希望 Client 还能 push，则：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git daemon --base-path=. --export-all --enable=receive-pack --reuseaddr --informative-errors --verbose</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>其中，<code>--export-all</code> 能够让 <code>repos/</code> 下所有文件夹暴露为 git 库，否则 <code>git daemon</code> 仅搜索包含 <code>git-daemon-export-ok</code> 文件的目录暴露出来。</p>\n<ul>\n<li>创建 alias</li>\n</ul>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git config --global alias.serve '!git daemon --base-path=. --export-all --reuseaddr --informative-errors --verbose'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git config --global alias.hub '!git daemon --base-path=. --export-all --enable=receive-pack --reuseaddr --informative-errors --verbose'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"client\">Client<a href=\"https://wkevin.github.io/blog/2022/10/14/git.daemon#client\" class=\"hash-link\" aria-label=\"Direct link to Client\" title=\"Direct link to Client\">​</a></h2>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git clone git://&lt;server-ip&gt;/myproject-repo</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果希望 push，则需要配置:</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git config --global sendpack.sideband false</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>否则容易卡死在 <code>Writing objects: 100% (3/3)</code> 不动，尤其 windows 常见。</p>\n<p>然后就是普通的 push.</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"server-1\">Server<a href=\"https://wkevin.github.io/blog/2022/10/14/git.daemon#server-1\" class=\"hash-link\" aria-label=\"Direct link to Server\" title=\"Direct link to Server\">​</a></h2>\n<p>client push 后，server 也是常规的 pull or fetch，使用上面创建的 local remote。</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ git fetch local</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"ref\">Ref<a href=\"https://wkevin.github.io/blog/2022/10/14/git.daemon#ref\" class=\"hash-link\" aria-label=\"Direct link to Ref\" title=\"Direct link to Ref\">​</a></h2>\n<ul>\n<li><a href=\"https://railsware.com/blog/taming-the-git-daemon-to-quickly-share-git-repository/\" target=\"_blank\" rel=\"noopener noreferrer\">Taming The Git-Daemon To Quickly Share Git Repository</a></li>\n<li><a href=\"https://linuxconfig.org/how-to-export-repositories-with-the-git-daemon\" target=\"_blank\" rel=\"noopener noreferrer\">How to export repositories with the git-daemon</a></li>\n<li><a href=\"https://stackoverflow.com/questions/7104182/git-push-halts-on-writing-objects-100\" target=\"_blank\" rel=\"noopener noreferrer\">Git push halts on \"Writing Objects: 100%\"</a></li>\n</ul>",
            "url": "https://wkevin.github.io/blog/2022/10/14/git.daemon",
            "title": "使用 git daemon 快速传递代码",
            "summary": "git.daemon",
            "date_modified": "2022-10-14T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "git"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/09/07/vue.route",
            "content_html": "<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/screenshot-cd04a06c36e68ca889fab45fca7f931b.png\" width=\"2560\" height=\"1600\" class=\"img_ev3q\"></p>\n<p><code>/user</code> 匹配到第 2 个路由上，第 2 根白线所示，因为是一级路由，与所有一级路由一样（如：<code>/</code>），都会在 App.vue 的 <code>&lt;RouterView&gt;</code> 上渲染。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"命名视图\">命名视图<a href=\"https://wkevin.github.io/blog/2022/09/07/vue.route#%E5%91%BD%E5%90%8D%E8%A7%86%E5%9B%BE\" class=\"hash-link\" aria-label=\"Direct link to 命名视图\" title=\"Direct link to 命名视图\">​</a></h2>\n<p>第 2、3 根白线，发现 components 中有多个组件，就根据 <code>&lt;RouterView&gt;</code> 中的有 name 的进行渲染，所以可以达到“命名视图根据 routes 中是否定义而进行选择性渲染”的效果。</p>\n<p>这样 Header 就可以选择性出现了，选择权在 routes 的定义中。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"嵌套路由\">嵌套路由<a href=\"https://wkevin.github.io/blog/2022/09/07/vue.route#%E5%B5%8C%E5%A5%97%E8%B7%AF%E7%94%B1\" class=\"hash-link\" aria-label=\"Direct link to 嵌套路由\" title=\"Direct link to 嵌套路由\">​</a></h2>\n<p><code>/user/3</code> 先匹配到 <code>/user/:id</code> 上（第 3 根白线），命名视图依然会起效，在 App.vue 的 <code>&lt;RouterView&gt;</code> 中渲染。</p>\n<p><code>/user/3/foo</code> or <code>/user/3/bar</code> 首先同上，但继续会发现 children 中的嵌套路由，继续匹配，但会在父组件中的 <code>&lt;router-view /&gt;</code> 中渲染，而不是 App.vue 中的。</p>\n<p>嵌套路由可以防止路由更新时整体网页重新渲染。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"命名路由\">命名路由<a href=\"https://wkevin.github.io/blog/2022/09/07/vue.route#%E5%91%BD%E5%90%8D%E8%B7%AF%E7%94%B1\" class=\"hash-link\" aria-label=\"Direct link to 命名路由\" title=\"Direct link to 命名路由\">​</a></h2>\n<p>不要与前面的命名视图混淆了。</p>\n<p>在用 <code>&lt;RouterLink&gt;</code> 生成嵌套路由的 URL 时，可以有几种方式：</p>\n<ol>\n<li>使用相对路径，如： <code>to:\"./foo\"</code> —— 但这基本上很难正常工作，因为相对路径很容易变化。</li>\n<li>使用命名路由：无论是哪一级路由，都可以起个唯一性的 name，<code>&lt;RouterLink :to=\"{name: ...}\"&gt;</code> 即可构造出目标 URL。</li>\n</ol>",
            "url": "https://wkevin.github.io/blog/2022/09/07/vue.route",
            "title": "Vue Router 中的几个概念",
            "summary": "vue.route",
            "date_modified": "2022-09-07T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "vue",
                "router"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/08/25/how.to.create.vite.project",
            "content_html": "<p>自从 vite 被 vue 官方替代了 vue-cli(webpack) 用来创建 vue 项目之后，先后出现了几个工具（封装）来作为创建项目的脚手架，各种 blog 中会搜到各个历史时期的用法，和各种变换用法，我来整理一下，因为搜到了废弃的用法还不小心用了起来，还挺烦人的。</p>\n<p>下表中每种脚手架的 3 种使用方式效果是等价的，先说结论：<strong>用下表中的 (4)、(5)，等效的</strong>。</p>\n<table><thead><tr><th>脚手架</th><th>npm install</th><th>npx</th><th>npm init</th></tr></thead><tbody><tr><td><a href=\"https://www.npmmirror.com/package/create-vite-app\" target=\"_blank\" rel=\"noopener noreferrer\">create-vite-app</a><br>(已废弃)</td><td>(1)<br><code>npm install -g create-vite-app</code><br><code>create-vite-app my-project</code></td><td><code>npx create-vite-app</code></td><td>(2)<br><code>npm init vite-app my-project</code><br><code>cd my-project</code><br><code>npm i</code></td></tr><tr><td><a href=\"https://www.npmmirror.com/package/%40vitejs%2Fcreate-app\" target=\"_blank\" rel=\"noopener noreferrer\">@vitejs/create-app</a><br>(已废弃)</td><td></td><td><code>npx @vitejs/create-app</code></td><td>(3)<code>npm init @vitejs/app</code></td></tr><tr><td><a href=\"https://www.npmmirror.com/package/create-vite\" target=\"_blank\" rel=\"noopener noreferrer\">create-vite</a><br>(<strong>官方推荐</strong>)</td><td></td><td><code>npx create-vite</code></td><td>(4)<code>npm init vite@latest</code><br>(5)<code>npm create vite@latest</code></td></tr></tbody></table>\n<ul>\n<li>create-vite-app 已废弃多年，用它创建的项目还在用 vit 1.x 的版本，现在已结 3.x 了。其官方 README 中写的用法是 (2)，但很多 blog 中用的是 (1)。</li>\n<li>@vitejs/create-app 看名字是官方的，但也于 2021 年废弃，应该是用了不短的时间，很多 blog 都在使用 (3) 的方式创建 vite 项目。</li>\n<li>create-vite 是现行官方推荐，README 中写的是方法 (5)，但一些 blog 就是写 (4)，可能是为了展示一下自己指导 npm create 是 npm init 的别名吧。</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"npx-避免了本地全局安装\">npx 避免了本地全局安装<a href=\"https://wkevin.github.io/blog/2022/08/25/how.to.create.vite.project#npx-%E9%81%BF%E5%85%8D%E4%BA%86%E6%9C%AC%E5%9C%B0%E5%85%A8%E5%B1%80%E5%AE%89%E8%A3%85\" class=\"hash-link\" aria-label=\"Direct link to npx 避免了本地全局安装\" title=\"Direct link to npx 避免了本地全局安装\">​</a></h2>\n<p>脚手架都可以用 npx 执行，并且推荐用 npx 执行，但只有 create-vite-app 还创建了命令行入口，所以可以 shell 启动。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"npm-init-是个封装\">npm init 是个封装<a href=\"https://wkevin.github.io/blog/2022/08/25/how.to.create.vite.project#npm-init-%E6%98%AF%E4%B8%AA%E5%B0%81%E8%A3%85\" class=\"hash-link\" aria-label=\"Direct link to npm init 是个封装\" title=\"Direct link to npm init 是个封装\">​</a></h2>\n<p>会自动转换为 npx 命令，转换规则：</p>\n<ul>\n<li>npm init foo -&gt; npx create-foo</li>\n<li>npm init @usr/foo -&gt; npx @usr/create-foo</li>\n<li>npm init @usr -&gt; npx @usr/create</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"npm-create-是别名\">npm create 是别名<a href=\"https://wkevin.github.io/blog/2022/08/25/how.to.create.vite.project#npm-create-%E6%98%AF%E5%88%AB%E5%90%8D\" class=\"hash-link\" aria-label=\"Direct link to npm create 是别名\" title=\"Direct link to npm create 是别名\">​</a></h2>\n<p>2018.4 npm v6 中发布：npm create 是 npm init 的别名。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"vite-脚手架只创建了基础\">vite 脚手架只创建了基础<a href=\"https://wkevin.github.io/blog/2022/08/25/how.to.create.vite.project#vite-%E8%84%9A%E6%89%8B%E6%9E%B6%E5%8F%AA%E5%88%9B%E5%BB%BA%E4%BA%86%E5%9F%BA%E7%A1%80\" class=\"hash-link\" aria-label=\"Direct link to vite 脚手架只创建了基础\" title=\"Direct link to vite 脚手架只创建了基础\">​</a></h2>\n<p>上面所有脚手架都是基于 vite 的，所以创建的只有 vite（打包、热加载、动态 server），如果想创建一个完整的 web app，还需要使用更大的脚手架：</p>\n<ol>\n<li><a href=\"https://www.npmmirror.com/package/create-vue\" target=\"_blank\" rel=\"noopener noreferrer\">create-vue</a>:<!-- -->\n<ul>\n<li><code>npm init vue@3</code> 等价于 <code>npx create-vue@3</code></li>\n<li>vite + vue-router + pinia + eslint + prettier + ts...</li>\n</ul>\n</li>\n<li><a href=\"https://www.npmmirror.com/package/vue-cli\" target=\"_blank\" rel=\"noopener noreferrer\">vue-cli</a>:<!-- -->\n<ul>\n<li><code>npm install -g vue-cli</code>、<code>vue init &lt;template-name&gt; &lt;project-name&gt;</code>，其中 template-name 有 webpack、browserify……</li>\n<li><strong>已废弃，2018 年已停止开发</strong></li>\n</ul>\n</li>\n</ol>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"最后\">最后<a href=\"https://wkevin.github.io/blog/2022/08/25/how.to.create.vite.project#%E6%9C%80%E5%90%8E\" class=\"hash-link\" aria-label=\"Direct link to 最后\" title=\"Direct link to 最后\">​</a></h2>\n<p>3 个 vite 脚手架，加上 2 个 vue APP 脚手架，5 个项目的开发者中都有 1 个人： <a href=\"https://github.com/yyx990803\" target=\"_blank\" rel=\"noopener noreferrer\">yyx990803</a>，就是尤雨溪，大神真是能折腾，工具开发一个再来一打的人。</p>",
            "url": "https://wkevin.github.io/blog/2022/08/25/how.to.create.vite.project",
            "title": "到底用哪个方式创建 vite 项目",
            "summary": "how.to.create.vite.project",
            "date_modified": "2022-08-25T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "vite"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/08/13/rust.resource",
            "content_html": "<ul>\n<li>官方的 4 本书，英文版在安装 rust 后可以 <code>rustup doc</code> 本地打开阅读，无需在线阅读。</li>\n<li>Rust 中文翻译组(<strong>rust-lang-cn</strong>) 翻译了官方的 4 本，在线阅读托管在自己维护的 <a href=\"https://www.rustwiki.org.cn/\" target=\"_blank\" rel=\"noopener noreferrer\">rustwiki</a> 上。</li>\n<li><a href=\"https://github.com/rustlang-cn\" target=\"_blank\" rel=\"noopener noreferrer\">RustCN</a> 社区(<strong>rustlang-cn</strong>) 写了 4 本，其中创始人 Sunface 自己写了 2 本，同时他也是 <a href=\"https://hub.fgit.ml/rustlang-cn/Rustt\" target=\"_blank\" rel=\"noopener noreferrer\">Rust 语言周刊</a> 的维护者。</li>\n<li>官方的 《程序设计语言》指定中文版并不是 Rust 中文翻译组的版本，而是 KaiserY 同学的。</li>\n</ul>\n<table><thead><tr><th>Name</th><th><a href=\"https://www.rust-lang.org/\" target=\"_blank\" rel=\"noopener noreferrer\">官方</a></th><th><a href=\"https://github.com/rust-lang-cn\" target=\"_blank\" rel=\"noopener noreferrer\">Rust 翻译组</a></th><th><a href=\"https://github.com/rustlang-cn\" target=\"_blank\" rel=\"noopener noreferrer\">RustCN</a></th><th>个人</th></tr></thead><tbody><tr><td>《The Rust Programming Language》<br>《Rust 程序设计语言》</td><td><a href=\"https://github.com/rust-lang/book\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://doc.rust-lang.org/book/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td><a href=\"https://github.com/rust-lang-cn/book-cn\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://rustwiki.org/zh-CN/book/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td><td>KaiserY<br><a href=\"https://github.com/KaiserY/trpl-zh-cn\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://kaisery.github.io/trpl-zh-cn/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td></tr><tr><td>《Rust by Example》<br>《通过例子学 Rust》</td><td><a href=\"https://github.com/rust-lang/book\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://doc.rust-lang.org/book/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td><a href=\"https://github.com/rust-lang-cn/rust-by-example-cn\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://rustwiki.org/zh-CN/rust-by-example/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td><td></td></tr><tr><td>《The Rustonomicon》<br> 《Rust 秘典（死灵书）》</td><td><a href=\"https://github.com/rust-lang/nomicon\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://doc.rust-lang.org/nomicon/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td><a href=\"https://github.com/rust-lang-cn/nomicon-zh-Hans\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://nomicon.purewhite.io/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td><td></td></tr><tr><td>《The Rust Language Reference》<br>《Rust 参考手册》</td><td><a href=\"https://github.com/rust-lang/reference/\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://doc.rust-lang.org/stable/reference/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td><a href=\"https://github.com/rust-lang-cn/reference-cn\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://rustwiki.org/zh-CN/reference/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td><td></td></tr><tr><td>《Rust 语言圣经》</td><td></td><td></td><td>Sunface<br><a href=\"https://github.com/sunface/rust-course\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://course.rs/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td></tr><tr><td>《Rust 语言实战》</td><td></td><td></td><td>Sunface<br><a href=\"https://github.com/sunface/rust-by-practice\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://zh.practice.rs/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td></tr><tr><td>《Rust 绣书》</td><td></td><td></td><td><a href=\"https://github.com/rustlang-cn/rusty-book\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://rusty.rs/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td></tr><tr><td>《Rust 算法题解》</td><td></td><td></td><td><a href=\"https://github.com/rustlang-cn/rust-algos\" target=\"_blank\" rel=\"noopener noreferrer\">github</a><br><a href=\"https://algos.rs/\" target=\"_blank\" rel=\"noopener noreferrer\">在线阅读</a></td><td></td></tr></tbody></table>",
            "url": "https://wkevin.github.io/blog/2022/08/13/rust.resource",
            "title": "Rust 开源书",
            "summary": "rust.resource",
            "date_modified": "2022-08-13T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "rust",
                "open source book"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/06/17/gitee.jenkins.plugin",
            "content_html": "<p>6.18 又买了一个新的腾讯云 VPS，本以为轻车熟路 10 分钟配置完毕，没想到搞了半小时，配置 gitee 的 jenkins 插件就 10 分钟，又翻了一遍<a href=\"https://gitee.com/oschina/Gitee-Jenkins-Plugin\" target=\"_blank\" rel=\"noopener noreferrer\">gitee 插件文档</a>，每次都要翻一遍这个文档。</p>\n<p>这次画个图，争取下次 3 分钟搞定 —— 但画图花了半小时，哈哈！</p>\n<img decoding=\"async\" loading=\"lazy\" src=\"https://www.plantuml.com/plantuml/svg/XLDTJnf157sVNt7ZapwWJtqXnTXgGgLjOgfj7ysmZBjJTcV8pcnDtr1HiHM1XZGDzejegsa2-jIe-F5ZO7VXoR_G3ek8nTR7ENFdtdFFEJCX9BQbOvb892bBOHjRO776DSFc5W5fEmIX5BObrMWACmanmfAK2S02OZSkebGIek0eGenB0YPPa113ZVHRjxRHsbdryk-RzL-Dz3lq53Eiarwhq3YQPa9YquGPqz6xq2p1jcR0KAVlK5yH8Ym1QiB0dFPgpZ-hNS_f6p0uSfAp1QexDe7PDq8IIs713bStM5BEhc6DCqOqXGcaNdSFmB1580B3mvsoaP5kkS65XEVFda0432bJ8ZmsfgkBKOrRQD8c2S8anQQ0C3n8920K6lzxCPlgXeIesimlVVMoXTR55s_hEu3aISBKWWEDnrB45fnXSnvh6X5YlbCga5VT3Lv1yoZdb_QR9rlUIS7_jkJNAdvXpIzdtFMgbwjTdcuYD_ypg81EMmZqzCiPU30p3Qt35R-q7rGtqijzdACG6eTO61hfAw9TdiMxZ0g5L4Yossxz97YfTflY5gOC8X0rUHoRewEZw35b2GLqQ2aoSse0wfrVt0iGYDn6OdeA8j0kvxrC7aqHeTaqrV6l1w8v8YHSEnk6MQUZ8hXhER--vzUhTsKFOZpUIHwFGoYa8hD0zO7yt4ZBGuUQ2PYpgQx_yUxoj8m00cpH80mmQ0PcEW4g8EK8WoH0ya029Ga0W7kUTNVBpOkQLpfkLuulJpVT_86RNswbLxmFwrvb1taRvsxsK8coIE86vqbmFnswdzEDz59FdjP1LolmFXx0g-v7QHvLW-pvvKpVyZ7bTJJy_uu3AMvNZltjMg2KKkabYJ_YF2aWI65Wsx_xANjkoPjRA4BlKRxOJYy5UtJdyzV4LcMjlHzklgWCKlJl1_oRPnT-QNymB3gLa79C4u9VWYO8IpYM-Hi0\" class=\"img_ev3q\">\n<p>总结：</p>\n<ul>\n<li>2 个 token<!-- -->\n<ul>\n<li>连接 token：在 gitee 上创建，写在 jenkins 的插件配置里 —— 每个 jenkins 一个。</li>\n<li>webhook token：在 jenkins job 中创建，写在 gitee 的项目 webhook 配置里 —— 每个 Jenkins Job 一个。</li>\n</ul>\n</li>\n<li>文档里的 Job 配置写了很多，我大多数没配，默认或置空也跑的起来。</li>\n<li>Jenkins docker 启动参数关注：<!-- -->\n<ul>\n<li><code>-u root</code>：否则 jenkins 容器没有权限操作本地路径，因为我把 jenkins_home <code>-v</code> 到本地其他路径上了。</li>\n<li><code>-e TZ=Asia/Shanghai</code>: 否则 jenkins 中的时间是格林尼治时间。</li>\n</ul>\n</li>\n</ul>",
            "url": "https://wkevin.github.io/blog/2022/06/17/gitee.jenkins.plugin",
            "title": "Gitee Jenkins Plugin",
            "summary": "gitee.jenkins.plugin",
            "date_modified": "2022-06-17T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "gitee",
                "jenkins",
                "plugin"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go",
            "content_html": "<p>Go 怎么调用 Python？或者说 Python 怎么嵌入到 Go？—— 我要研究明白。</p>\n<ul>\n<li>方案 1：go -- RESTFul -- python<!-- -->\n<ul>\n<li>需要用户起一个 python 进程的 http server 进程，并且定义 RESTFul API。</li>\n</ul>\n</li>\n<li>方案 2：go -- rpc -- python<!-- -->\n<ul>\n<li>可用 grpc 或其他 rpc，也是需要单独启动一个 python 进程并开启 rpc server，go 中代码作为 rpc client。</li>\n</ul>\n</li>\n<li>方案 3：go -- cgo/内存共享 -- python(C-API)<!-- -->\n<ul>\n<li>python 的解释器绝大多数人都是使用官方的 CPython，内核和解释器是用 C 实现的，可以用 C 代码方便的调用。</li>\n<li>go 又和 C 是天然搭档，通过标准库中的 cgo 组件可以无缝调用 C。</li>\n<li>此时 python core 作为动态库链接到 go 上。</li>\n</ul>\n</li>\n</ul>\n<p>RESTFul 和 RPC 都是网络调用方式，更适合高度解耦的场景，cgo 或直接内存共享则是效率优先。 —— 我打算先摸索一下方案 3。一通搜索，找到了一些好文章，再加上 10 天左右的实战摸索，总结以下要点：</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/key-point.drawio-9c9934ba623716a13b85bc764822920b.svg\" class=\"img_ev3q\"></p>\n<p>下面依次展开描述图中 1、2、3：</p>\n<ol>\n<li><strong>Python C-API</strong>\n<ul>\n<li>Python 对外提供 <code>Python.h</code>，include 此文件即可访问 CPython 提供的 C API。</li>\n<li>通过 Python C API，调用 Python C 库，包括 Python 解析器、Python Core、Python 标准库……，由此可以实现 2 类需求：<!-- -->\n<ul>\n<li>为 Python 写<strong>扩展</strong>：可以用 C 语言或其他语言（如 go），通过 C-API 写个扩展，编译后放在 Python 库中，供任意 py 脚本调用。—— 官方文档中称之为 Extending Python With C</li>\n<li>将 Python <strong>嵌入</strong>到其他语言中：—— 官方文档称之为 Embedding Python into C，我们这里要进一步 Embedding Python into Go。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><strong>cgo</strong>\n<ul>\n<li>cgo 是 go 官方实现的一套 toolchain 工具 + 转换库函数，能够将 go 的数据转为 c（如：<code>C.CString()</code>）或反之（如：<code>C.GoString()</code>），其工具能够自动调用 gcc、glibc、能够使用 pkg-config 等工具发现编译参数……。</li>\n<li>cgo 调用 C 标准库仅需 1 行 <code>import \"C\"</code> ，然后在 go 代码中即可 <code>C.print(\"foobar\");</code></li>\n<li>基于 cgo 的方式，有热心网友做了更高层次的封装，如：<!-- -->\n<ul>\n<li>封装 Python2 C-API 的 <a href=\"https://github.com/sbinet/go-python\" target=\"_blank\" rel=\"noopener noreferrer\">sbinet/go-python</a>、<a href=\"https://github.com/spikeekips/embedding-python-in-golang\" target=\"_blank\" rel=\"noopener noreferrer\">spikeekips/embedding-python-in-golang</a></li>\n<li>封装 Python3.7 C-API 的 <a href=\"https://github.com/DataDog/go-python3\" target=\"_blank\" rel=\"noopener noreferrer\">DataDog/go-python3</a>（已停止）及其 fork <a href=\"https://github.com/go-python/cpy3\" target=\"_blank\" rel=\"noopener noreferrer\">go-python/cpy3</a>，但都仅限于 python3.7，并且已经多年不维护。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><strong>go</strong>\n<ul>\n<li>go 中除了直接调用 <code>C.xxx</code> 变量和函数之外，就是要特别考虑：<!-- -->\n<ul>\n<li>协程并发：go 中的协程如何与 C 中的函数保持可重入性和幂等性，如果 C 函数不可重入，要封装加锁，或 go 代码中加锁。</li>\n<li>对 C 对象生命周期的管理：C 中本来没有对象，它也不是面向对象语言，但 Python 封装带 PyObject 数据结构，具有高级语言对象的完整特征，但又不能自动垃圾回收，所以使用 PyObject 但手工维护指针计数，以放置内存泄露——几乎可以说搞定 Python C-API 的第一个必过考点、难点。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<p>好吧，开始启程，章节安排依然是上图中的 1、2、3。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python--c\">Python ~ C<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#python--c\" class=\"hash-link\" aria-label=\"Direct link to Python ~ C\" title=\"Direct link to Python ~ C\">​</a></h2>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"嵌入与扩展\">嵌入与扩展<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%B5%8C%E5%85%A5%E4%B8%8E%E6%89%A9%E5%B1%95\" class=\"hash-link\" aria-label=\"Direct link to 嵌入与扩展\" title=\"Direct link to 嵌入与扩展\">​</a></h3>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/Selection_014-459475125fa59b537a2eab1d35be085b.png#size80\" width=\"1055\" height=\"545\" class=\"img_ev3q\"></p>\n<p>Python 官方文档首页中的这个主题：<a href=\"https://docs.python.org/3/extending/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">Extending and Embedding</a>，从 python2 至今 3.10，一直都在这里，其中内容分 2 块：</p>\n<ul>\n<li>Extending（扩展）：使用 C 编写 python 扩展模块，作为 Python 自身源码中大量扩展模块（有 C 也有 Python 实现的）的扩充。</li>\n<li>Embedding（嵌入）：将 Python 解释器、Core 嵌入到另一个应用程序中，这样另一名语言可以调用 Python 的 Core 和标准库、第 3 方库……。</li>\n</ul>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/python.extending.and.embedding-f11742d802937f69d5a836cd5aed4dc7.svg\" class=\"img_ev3q\"></p>\n<p>画了个可能不是很准确的图，表达一下我对扩展和嵌入的理解。</p>\n<ul>\n<li>括号中的部分(<code>(Python/*.c)</code>、<code>(Lib/*.py)</code>)表示这些模块在 CPython 源码中的文件夹，及其实现语言，<a href=\"https://www.python.org/downloads/source/\" target=\"_blank\" rel=\"noopener noreferrer\">官方网站</a>可以下载任一版本的源码。</li>\n<li>大圆圈中的 Python Core 与 Parser、Objects、Moudules 等编译后生成 python 解释器(一般位于 <code>/usr/bin/python</code>)和 python 库（一般位于<code>/usr/lib/x86_64_linux-gnu/libpythonx.y.a</code>）,都是二进制文件。其中我把 C-API 放在了正中间，表示几乎所有其他模块的源码，都会 include 其中的头文件。</li>\n<li>标准库的 python 部分源码在 <code>Lib/*.py</code>，安装时不编译，以源码形式安装（一般位于<code>/usr/lib/pythonx.y/</code>）</li>\n</ul>\n<p>官方文档中有一段对比的解释：</p>\n<p>扩展 Python 和嵌入 Python 的过程相当类似：</p>\n<p>从 Python 到 C 的扩展代码到底做了什么： —— 对应上图中红色线条及 1、2、3。</p>\n<ol>\n<li>将 Python 的数据转换为 C 格式，</li>\n<li>用转换后的数据执行 C 程序的函数调用，</li>\n<li>将调用返回的数据从 C 转换为 Python 格式。</li>\n</ol>\n<p>嵌入 Python 时，接口代码会这样做： —— 对应上图中蓝色线条及 1、2、3。</p>\n<ol>\n<li>将 C 数据转换为 Python 格式，</li>\n<li>用转换后的数据执行对 Python 接口的函数调用，</li>\n<li>将调用返回的数据从 Python 转换为 C 格式。</li>\n</ol>\n<p>可能一般我们认识 python 都是从 python 的命令行开始的，比如我们查看 python3.8 可执行文件（解释器）：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ file /usr/bin/python3.8</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/bin/python3.8: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=1f3df9df2b5e575fdee41890fe17f6de614f93f6, for GNU/Linux 3.2.0, stripped</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>从这个命令行可以启动一个 py 文件：<code>python foobar.py</code>，但同时 python 还包含一个二进制的库，根据安装或源码编译的参数不同，可以是静态库或动态库：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ file /usr/lib/x86_64-linux-gnu/libpython3.8.a</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">./libpython3.8.a: symbolic link to ../python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>原来是个软连接</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ file /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a: current ar archive</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>还是个压缩包</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ readelf -h /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a |grep \"^File:*\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(getbuildinfo.o)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(acceler.o)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(grammar1.o)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(listnode.o)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(node.o)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(parser.o)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">......</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>170+ .o 合并而成，对应上图中的大圆圈中相应的 .c 文件。</p>\n<p>我们来总结一下：</p>\n<ul>\n<li>扩展：指的是 C 语言实现的与标准库 C 部分类似的，可以通过 C-API 调用 Core、Object、Moudules，从而实现的功能扩展。<!-- -->\n<ul>\n<li>相比 python 在上层基于标准库实现的扩展或模块，C 扩展可以实现更底层的功能，比如：实现新的内置对象类型、调用 C 的库函数和系统调用 —— 这都是 python 调用标准库而实现的扩展模块做不到的。</li>\n<li>C 写的扩展也需要编译为二进制、连接后才能使用，不能像 python 一样由词法器、解释器运行期处理。</li>\n<li>可以用 disutils 编译 C 扩展，如：<code>python setup.py build</code>，会自动调用 gcc 生成 .so 或 .o。</li>\n<li>然后扩展也可以与其他 python 编写的扩展一样，发布到 pypi</li>\n</ul>\n</li>\n<li>嵌入：指的是将 python 解释器嵌入到其他语言或 APP 中，不再是主进程，而是被其他语言（C、go 等）主进程调用的派成进程。</li>\n<li>扩展和嵌入都是调用 C-API</li>\n</ul>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python-c-的编译\">python C 的编译<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#python-c-%E7%9A%84%E7%BC%96%E8%AF%91\" class=\"hash-link\" aria-label=\"Direct link to python C 的编译\" title=\"Direct link to python C 的编译\">​</a></h3>\n<p>下面我们来写一些简短的 C 来实际调用一下 Python C API。但是写代码之前，非常有必要认识一下 pkg-config 这个工具。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pkg-config\">pkg-config<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#pkg-config\" class=\"hash-link\" aria-label=\"Direct link to pkg-config\" title=\"Direct link to pkg-config\">​</a></h4>\n<p>pkg-config 是用来收集系统上已安装库的元数据的小工具，Linux、macOS、Windows 上都可以使用，可以用在向 gcc、make 等提供数据的场景，是 <strong>gcc 的好帮手</strong>。</p>\n<p>对于库的开发人员来说，随库版本一起发布和安装 pkg-config 文件（<code>*.pc</code>）可以简化用户（gcc）寻找信息的方法和时间。</p>\n<p><strong>安装：</strong></p>\n<p>如果想从源码安装，可以到 <a href=\"https://www.freedesktop.org/wiki/Software/pkg-config/\" target=\"_blank\" rel=\"noopener noreferrer\">官网</a> 上<a href=\"http://pkgconfig.freedesktop.org/releases/\" target=\"_blank\" rel=\"noopener noreferrer\">下载源码</a>，或从 <a href=\"https://gitlab.freedesktop.org/pkg-config/pkg-config\" target=\"_blank\" rel=\"noopener noreferrer\">这里</a>找到 git 库地址 <code>git clone https://gitlab.freedesktop.org/pkg-config/pkg-config.git</code>。然后 configuration、make...</p>\n<p>但还是简单点，不折腾，安装二进制版本吧：</p>\n<ul>\n<li>Linux: 各大发行版都默认安装了，直接使用。</li>\n<li>macOS: <code>brew -v install pkg-config</code></li>\n<li>windows: 待研究，好像要用到 MinGW，那干脆直接用微软在 windows 内嵌的原生 Linux 算了。</li>\n</ul>\n<p><strong>工作原理：</strong></p>\n<p>pkg-config 搜索 <code>*.pc</code> 文件，路径可以用下面命令查看：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --variable pc_path pkg-config</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/local/lib/x86_64-linux-gnu/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/share/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li><code>/usr/local/lib/x86_64-linux-gnu/pkgconfig</code></li>\n<li><code>/usr/local/lib/pkgconfig</code></li>\n<li><code>/usr/local/share/pkgconfig</code></li>\n<li><code>/usr/lib/x86_64-linux-gnu/pkgconfig</code> —— 我的电脑这里有 280+ 个</li>\n<li><code>/usr/lib/pkgconfig</code></li>\n<li><code>/usr/share/pkgconfig</code> —— 40+ 个</li>\n</ul>\n<p>另外，环境变量 <code>PKG_CONFIG_PATH</code> 也影响 pkg-config 搜索 pc 文件的路径。</p>\n<p>用下面的命令可以查看已经搜索到 pc 文件，即表示能够使用的库，比如：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --list-all | grep glib-2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">glib-2.0                       GLib - C Utility Library</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>说明本机已经安装了 glib-2.0 库，可以使用了：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --cflags glib-2.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --libs glib-2.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-lglib-2.0</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><code>--cflags</code> 和 <code>--libs</code> 是最常用的 pkg-config 参数，获取指定库自己暴露的头文件和库文件位置，并封装为相应的 gcc 参数（即添加 <code>-I</code>、<code>-L</code> 前缀）。在我的电脑里：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --cflags --libs glib-2.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include -lglib-2.0</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样聚合到 gcc 或 make 中就可以这样：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs glib-2.0` main.c -o main</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>等效于</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc -I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include -lglib-2.0 main.c -o main</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pythons-pkg-config\">python's pkg-config<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#pythons-pkg-config\" class=\"hash-link\" aria-label=\"Direct link to python's pkg-config\" title=\"Direct link to python's pkg-config\">​</a></h4>\n<p>我本机安装了多个版本的 python，pkg-config 都可以找到：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --list-all | grep python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python2                        Python - Python library</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-2.7                     Python - Python library</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python3                        Python - Build a C extension for Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python3-embed                  Python - Embed Python into an application</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.8                     Python - Build a C extension for Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.8-embed               Python - Embed Python into an application</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>还可以通过 <code>PKG_CONFIG_PATH</code> 环境变量增加搜索 <code>*.pc</code> 文件的路径，如新增我用 pyenv 安装的更多 python：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">export PKG_CONFIG_PATH=~/.pyenv/versions/3.9.2/lib/pkgconfig</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>然后就可以找到 3.9 的 python 了：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --list-all | grep python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python2                        Python - Python library</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-2.7                     Python - Python library</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python3                        Python - Build a C extension for Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python3-embed                  Python - Embed Python into an application</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.8                     Python - Build a C extension for Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.8-embed               Python - Embed Python into an application</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.9                     Python - Build a C extension for Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.9-embed               Python - Embed Python into an application</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>你应该注意到了，每个 python 都有 2 个 pc 文件，根据其注释，明确表明了 2 个 pc 的用途：</p>\n<ol>\n<li>Build a C extension for Python —— 扩展</li>\n<li>Embed Python into an application —— 嵌入</li>\n</ol>\n<p>所以当我们开发扩展 or 嵌入的时候，一定要使用相应的 pc 文件。</p>\n<p>对比一下：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cat /usr/lib/x86_64-linux-gnu/pkgconfig/python3.pc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># See: man pkg-config</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">prefix=/usr</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">exec_prefix=${prefix}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">includedir=${prefix}/include</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Name: Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Description: Build a C extension for Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Requires:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Version: 3.8</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Libs.private: -lcrypt -lpthread -ldl  -lutil -lm</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Libs:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Cflags: -I${includedir}/python3.8 -I${includedir}/x86_64-linux-gnu/python3.8</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cat /usr/lib/x86_64-linux-gnu/pkgconfig/python3-embed.pc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># See: man pkg-config</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">prefix=/usr</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">exec_prefix=${prefix}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">libdir=${exec_prefix}/lib</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">includedir=${prefix}/include</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Name: Python</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Description: Embed Python into an application</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Requires:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Version: 3.8</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Libs.private: -lcrypt -lpthread -ldl  -lutil -lm</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Libs: -L${libdir} -lpython3.8</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Cflags: -I${includedir}/python3.8</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>所以相同命令得到不同结果：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --libs python3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --libs python3-embed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-lpython3.8</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>扩展不需要 Libs 配置参数，嵌入需要 —— 想想为什么？</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python-共享库\">python 共享库<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#python-%E5%85%B1%E4%BA%AB%E5%BA%93\" class=\"hash-link\" aria-label=\"Direct link to python 共享库\" title=\"Direct link to python 共享库\">​</a></h4>\n<p>如果你使用 pyenv，通过编译 python 源码生成的 python 可执行文件，通常会连带生成其静态库，如：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ls /home/me/.pyenv/versions/3.9.2/lib/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">libpython3.9.a  pkgconfig  python3.9</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但 python 还可以编译成共享库（动态库）：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ env PYTHON_CONFIGURE_OPTS=\"--enable-shared\" pyenv install 3.9.2</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">...</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ls /home/me/.pyenv/versions/3.9.2/lib/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">libpython3.9.a  libpython3.9.so  libpython3.9.so.1.0  libpython3.so  pkgconfig  python3.9</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>多出来的 <code>libpython3.9.so</code> 即共享库，可用于嵌入 python 的相关开发，前面 <code>-lpython3.x</code> 也就是指的它了。</p>\n<p>文档参考<a href=\"https://kgithub.com/pyenv/pyenv/wiki#how-to-build-cpython-with---enable-shared\" target=\"_blank\" rel=\"noopener noreferrer\">pyenv 的 wiki</a>。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python-的-flag-还能这样获取\">python 的 flag 还能这样获取<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#python-%E7%9A%84-flag-%E8%BF%98%E8%83%BD%E8%BF%99%E6%A0%B7%E8%8E%B7%E5%8F%96\" class=\"hash-link\" aria-label=\"Direct link to python 的 flag 还能这样获取\" title=\"Direct link to python 的 flag 还能这样获取\">​</a></h4>\n<p>python 官方还提供了另外一个工具，更专业的提供 gcc 编译参数：</p>\n<p>输入 python3. 然后 tab 键，自动弹出的工具里有一类： pythonx.x-config</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python3.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python3.5          python3.5m         python3.6-config   python3.6m-config  python3.7-gdb.py   python3.8          python3.9</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python3.5-config   python3.5m-config  python3.6-gdb.py   python3.7          python3.7m         python3.8-config   python3.9-config</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python3.5-gdb.py   python3.6          python3.6m         python3.7-config   python3.7m-config  python3.8-gdb.py   python3.9-gdb.py</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>用法示例：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python3.9-config --cflags</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-I/home/me/.pyenv/versions/3.9.2/include/python3.9 -I/home/me/.pyenv/versions/3.9.2/include/python3.9  -Wno-unused-result -Wsign-compare  -DNDEBUG -g -fwrapv -O3 -Wall</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python3.8-config --ldflags</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-L/usr/lib/python3.8/config-3.8-x86_64-linux-gnu -L/usr/lib  -lcrypt -lpthread -ldl  -lutil -lm -lm</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果要使用嵌入特性，则使用 <code>--embed</code> 参数，如：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ python3.8-config --cflags --ldflags --embed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-I/usr/include/python3.8 -I/usr/include/python3.8</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-Wno-unused-result -Wsign-compare -g</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-fdebug-prefix-map=/build/python3.8-4wuY7n/python3.8-3.8.10=.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-specs=/usr/share/dpkg/no-pie-compile.specs -fstack-protector</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-Wformat -Werror=format-security  -DNDEBUG -g -fwrapv -O3 -Wall</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-L/usr/lib/python3.8/config-3.8-x86_64-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-L/usr/lib</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-lpython3.8</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-lcrypt -lpthread -ldl  -lutil -lm -lm</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>比暴露给 pkg-config 的更完整，对故障打印格式等信息也做了优化，所以我们就可以这样：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `python3-config --cflags --ldflags --embed` main.c</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>来代替</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs python3-embed` main.c</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>或者干脆写一个二合一的 shell 脚本：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcc `pkg-config --cflags --libs python3-embed` main.c</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">if [ $? != 0 ];then</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcc `python3-config --cflags --ldflags --embed` main.c</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">fi</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"hello-world\">Hello World<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#hello-world\" class=\"hash-link\" aria-label=\"Direct link to Hello World\" title=\"Direct link to Hello World\">​</a></h3>\n<p>现在，我们必须来实现一个上面提到的、简单的 main.c 了。</p>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// main.c</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token macro property directive-hash\" style=\"color:#36acaa\">#</span><span class=\"token macro property directive keyword\" style=\"color:#00009f\">include</span><span class=\"token macro property\" style=\"color:#36acaa\"> </span><span class=\"token macro property string\" style=\"color:#e3116c\">&lt;Python.h&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">int</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">printf</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"hello python c api\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">Py_Initialize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">printf</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"%s\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">Py_GetVersion</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">Py_Finalize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li><code>Py_Initialize</code> 初始化 Python Core</li>\n<li><code>Py_Finalize</code> 停止 Python Core</li>\n<li><code>Py_GetVersion</code> 中间用 c 语言的 print，打印了 Python 的版本。</li>\n</ul>\n<p>3 个函数都是 <code>&lt;Python.h&gt;</code> 中提供的。执行结果：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">hello python c api</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.9.13 (main, May 24 2022, 21:28:12)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[Clang 12.0.0 (clang-1200.0.32.29)]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"情况-1-编译失败\">情况 1: 编译失败<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E6%83%85%E5%86%B5-1-%E7%BC%96%E8%AF%91%E5%A4%B1%E8%B4%A5\" class=\"hash-link\" aria-label=\"Direct link to 情况 1: 编译失败\" title=\"Direct link to 情况 1: 编译失败\">​</a></h4>\n<p>也许你不是很顺利，编译报错，比如：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/bin/ld: /tmp/ccteb8Kn.o: in function `main':</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">main.c:(.text+0x15): undefined reference to `Py_Initialize'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/bin/ld: main.c:(.text+0x1a): undefined reference to `Py_GetVersion'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/bin/ld: main.c:(.text+0x33): undefined reference to `Py_Finalize'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">collect2: error: ld returned 1 exit status</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>找不到需要的动态库?</p>\n<p>确认一下 libpython3...</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --cflags --libs python3-embed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-I/home/me/.pyenv/versions/3.8.13/include/python3.8 -L/home/me/.pyenv/versions/3.8.13/lib -lpython3.8</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ls /home/me/.pyenv/versions/3.8.13/lib</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">libpython3.8.so  libpython3.8.so.1.0  libpython3.so  pkgconfig  python3.8</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>libpython3.8.so 就在指定的位置，那为啥找不到？</p>\n<p>把动态库放在本地试试</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ln -s /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so.1.0 ./</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo ./libpython3.8.so.1.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">hello python c api</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.8.13 (default, Jun 15 2022, 09:07:53)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[GCC 9.4.0]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>成功！难道 <code>-L</code> 参数不工作了？</p>\n<p>试试编译和链接分开：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags python3-embed` main.c -c</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ file main.o</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">main.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc main.o /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so -o demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">hello python c api</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.8.10 (default, Mar 15 2022, 12:22:08)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[GCC 9.4.0]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>咦？链接的 3.8.13，运行是 3.8.10？</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ldd demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libpython3.8.so.1.0 =&gt; /lib/x86_64-linux-gnu/libpython3.8.so.1.0 (0x00007f51bc49d000)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  ......</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>哦，这应该是那个 linker and loader 的常见问题，重新来：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ LD_LIBRARY_PATH=/home/me/.pyenv/versions/3.8.13/lib/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">hello python c api</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.8.13 (default, Jun 15 2022, 09:07:53)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[GCC 9.4.0]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>偶然间发现：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so main.o -o demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/bin/ld: /tmp/ccZv3FZH.o: in function `_Py_DECREF':</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">main.c:(.text+0x39): undefined reference to `_Py_Dealloc'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/bin/ld: /tmp/ccZv3FZH.o: in function `main':</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">main.c:(.text+0x59): undefined reference to `Py_Initialize'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/bin/ld: main.c:(.text+0x5e): undefined reference to `Py_GetVersion'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这就诡异了：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc main.o /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so -o demo # 成功</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so main.o -o demo # 失败</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc main.o `pkg-config --libs python3-embed` -o demo # 成功</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --libs python3-embed` main.o -o demo # 失败</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>那不分开编译，也更换一下顺序呢？</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc main.c `pkg-config --cflags --libs python3-embed` -o demo # 成功</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo # 失败</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>难道是我健忘症犯了？忘记了 gcc 的哪个细节？我怎么完全没印象以前遇到过这个问题啊？</p>\n<p>又找了几个电脑的 gcc 测试，发现有些版本的都成功，有些和我一样，macOS 的则全部都成功 —— 不会是某个 gcc 版本的 bug 吧！</p>\n<p>最后我又测试了这样：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags python3-embed` main.c `pkg-config --libs python3-embed` -o demo</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>也是成功的，难道 linker 必须放在 compiler 后面，gcc 哪个版本开始做这个强制要求了？</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"高层-api\">高层 API<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E9%AB%98%E5%B1%82-api\" class=\"hash-link\" aria-label=\"Direct link to 高层 API\" title=\"Direct link to 高层 API\">​</a></h4>\n<p>可以使用 <code>PyRun_SimpleString</code> 直接执行 python 语句：</p>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">int</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">printf</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"hello python c api\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">Py_Initialize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">PyRun_SimpleString</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"import datetime\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">PyRun_SimpleString</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"print(datetime.datetime.now())\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">Py_Finalize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">hello python c api</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">2022-06-13 20:41:05.210003</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"底层-api\">底层 API<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%BA%95%E5%B1%82-api\" class=\"hash-link\" aria-label=\"Direct link to 底层 API\" title=\"Direct link to 底层 API\">​</a></h4>\n<p><code>PyRun_SimpleString</code> 可以说是最高层、也是最简单的 Python 提供的 C-API 了，就是个简单的套壳，相当于从 C 切入，运行了 py 代码，再转回 c 代码。从效率上讲不是个好方案，还好 python 只提供了这 1 个高层函数，其他大量、巨量的都是底层函数，比如：</p>\n<ul>\n<li><code>mod = PyImport_ImportModule(\"foo.bar\")</code> 导入模块，相当于 <code>import foo.bar</code>，mod 是个 C 的 struct <code>struct PyObject</code>。</li>\n<li><code>attr = PyObject_GetAttrString(mod, \"foobar\")</code> 获取 module 的某个属性，比如函数、class、变量……返回的 attr 也是 PyObject —— 一切都是 PyObject。</li>\n<li><code>PyTuple_New</code>、<code>PyTuple_New</code> 创建并赋值元组</li>\n<li><code>PyLong_FromLong</code>、<code>PyLong_AsLong</code> 在 c 语言的 long 和 PyObject 之间互转。</li>\n<li><code>PyObject_CallObject</code> 调用函数</li>\n</ul>\n<p>来看代码吧：</p>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">int</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 底层 API</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">mod</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">func</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">val</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">rlt</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  mod </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyImport_ImportModule</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"random\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">mod </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token constant\" style=\"color:#36acaa\">NULL</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    func </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyObject_GetAttrString</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">mod</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"randint\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">func </span><span class=\"token operator\" style=\"color:#393A34\">&amp;&amp;</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyCallable_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">func</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      args </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyTuple_New</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 添加第 0 个参数</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      val </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyLong_FromLong</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token function\" style=\"color:#d73a49\">PyTuple_SetItem</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> val</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token function\" style=\"color:#d73a49\">Py_DECREF</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">val</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 添加第 1 个参数</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      val </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyLong_FromLong</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token function\" style=\"color:#d73a49\">PyTuple_SetItem</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> val</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token function\" style=\"color:#d73a49\">Py_DECREF</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">val</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 调用函数</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      rlt </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyObject_CallObject</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">func</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token function\" style=\"color:#d73a49\">printf</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Result of call: %ld\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyLong_AsLong</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">rlt</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token function\" style=\"color:#d73a49\">Py_DECREF</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token function\" style=\"color:#d73a49\">Py_DECREF</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">rlt</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">Py_Finalize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><a href=\"https://wkevin.github.io/assets/files/main-afee0b835a93747983bda535ebe8c528.c\" target=\"_blank\">下载 main.c</a></p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Result of call: 54</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>得到了一个随机数 54。上面近 30 行的 C 代码如果用 python 来实现的话可能只需这样：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> random</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Result of call:\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> random</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">randint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token number\" style=\"color:#36acaa\">100</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>没错，就是 2 行 —— 为啥用了 python 就再也回不去 C 了，因为这是血淋淋的降维打击。</p>\n<p>最后还需特别说明一下 <code>Py_DECREF</code>，因为 C 没有对象，Python 的 PyObject 完全是用 C 实现了面向对象，但又不能用 Python 自己的对象指针自动维护、垃圾回收。创建一个 PyObject 对象，对象的指针会 +1，但 -1 的任务就落在了使用者身上，如果不及时 -1，PyObject 对象实例就会永远驻留在内存中，造成内存泄露。<code>Py_DECREF</code> 就是操作 PyObject 指针指向的 PyObject 对象内的指针引用计数 -1。</p>\n<p>OK，Hello World 差不多了，如果在团队中不负责这一块，了解到这里就差不多了，可以跳过下面的几个小结，直奔 go-c 章节了。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python-c-api-知识要点\">python C-API 知识要点<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#python-c-api-%E7%9F%A5%E8%AF%86%E8%A6%81%E7%82%B9\" class=\"hash-link\" aria-label=\"Direct link to python C-API 知识要点\" title=\"Direct link to python C-API 知识要点\">​</a></h3>\n<p>几乎一切都可以在 Python 的官方文档中找到答案。</p>\n<ul>\n<li><a href=\"https://docs.python.org/zh-cn/3/extending/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">扩展和嵌入 Python 解释器</a></li>\n<li><a href=\"https://docs.python.org/zh-cn/3/c-api/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">Python/C-API 参考手册</a></li>\n</ul>\n<p>都有中文翻译，但大概只有 50% 左右翻译了。下面根据我实战中经验记录一些陷阱和提示吧。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"pyobject引用计数垃圾回收\">PyObject、引用计数、垃圾回收<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#pyobject%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6\" class=\"hash-link\" aria-label=\"Direct link to PyObject、引用计数、垃圾回收\" title=\"Direct link to PyObject、引用计数、垃圾回收\">​</a></h4>\n<div class=\"theme-admonition theme-admonition-info admonition_xJq3 alert alert--info\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>Spec</div><div class=\"admonitionContent_BuS1\"><p><strong>没有人可以拥有一个对象，对象都在内存堆上，你只能拥有一个对象的指针（引用）。</strong></p></div></div>\n<p>几乎所有 Python 对象存放在堆中：你不能声明一个类型为 PyObject 的自动或静态的变量，只能声明类型为 <code>PyObject*</code> 的指针。</p>\n<ul>\n<li>对象指针的拥有：生成某个对象指针变量的函数称为其拥有者，有责任及时调用 <code>Py_DECREF()</code>。</li>\n<li>对象指针的借用：<!-- -->\n<ul>\n<li>拥有者将指针 copy 给另一方，借用出去，即接收方不新建指针（临时）变量，也不应该调用 <code>Py_DECREF()</code>。</li>\n<li>因为借入者（接收方）只是借用，你的 Py_DECREF 会导致拥有者逻辑失效，当拥有者 Py_DECREF 的时候出现异常。</li>\n<li>借入者一旦 <code>Py_INCREF()</code>，则变为拥有者，就要及时 <code>Py_DECREF()</code>。</li>\n</ul>\n</li>\n</ul>\n<p>我这里做个比喻</p>\n<ul>\n<li><strong>管杀不管埋（传递）</strong>，即：负责创建 PyObject 对象，然后 <code>Py_INCREF()</code>，或不是新建对象，但都是获取到了一个新的对象指针（变量），但传递出去后自己不再负责 <code>Py_DECREF()</code>（即把拥有权传递出去），由<strong>接收方埋</strong>， 此时接受者变成拥有者，要负责及时调用 <code>Py_DECREF()</code>。这样的函数有：<!-- -->\n<ul>\n<li><code>PyLong_FromLong()</code></li>\n<li><code>Py_BuildValue()</code></li>\n<li><code>PyObject_Str()</code></li>\n<li><code>PyUnicode_AsUTF8()</code></li>\n<li><code>PyObject_GetAttrString()</code></li>\n</ul>\n</li>\n<li><strong>管杀也管埋（借用）</strong>，即：负责创建 PyObject 对象，然后 <code>Py_INCREF()</code> ，但同时也负责必要时调用 <code>Py_DECREF()</code> 消亡该对象，不需要接收者 <code>Py_DECREF()</code>，对象指针在它们与接收者之间是<strong>借用</strong>关系。接收者要注意借用时长不要超过借出方的给定时长，如果会超出，先 <code>Py_INCREF()</code> 一下。这样的函数有：<!-- -->\n<ul>\n<li><code>PyTuple_GetItem()</code></li>\n<li><code>PyList_GetItem()</code></li>\n<li><code>PyDict_GetItem()</code></li>\n<li><code>PyDict_GetItemString()</code></li>\n<li><code>PyImport_AddModule()</code></li>\n</ul>\n</li>\n</ul>\n<div class=\"theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 16 16\"><path fill-rule=\"evenodd\" d=\"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z\"></path></svg></span>注意</div><div class=\"admonitionContent_BuS1\"><p>所以，我们自己用库函数或写自己的函数时，都要首先弄清楚、想明白这个函数是情况 1、还是 2，然后决策自己是否需要 Py_INCREF 和 Py_DECREF。</p></div></div>\n<p>没有必要为每个包含指向对象的指针的局部变量增加对象的引用计数。理论上，当变量指向对象时，对象的引用计数增加 1 ，当变量超出范围时，对象的引用计数减少 1 。但是，这两者相互抵消，所以最后引用计数没有改变。—— 所以函数内临时变量就可以省略 Py_INCREF 和 Py_DECREF。</p>\n<p>使用引用计数的唯一真正原因是防止对象被释放。—— 即把根留住，自己要用。类似锁机制。</p>\n<p>比如：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">void</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bug</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">item </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> PyList_GetItem</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyList_SetItem</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> PyLong_FromLong</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">0L</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyObject_Print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">item</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> stdout</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> BUG! </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>首先借用一个引用 list[0] ，然后替换 list[1] 为值 0 ，最后打印借用的 list[0] 的引用。\n如果借用方代码写的有问题，当替换 list[1] 的时候，原来的 list[1] 会被释放，自动调用 <code>__del__()</code>，把 list[0] 也释放了，则打印那句就 emo 了。\n所以改进为：</p>\n<div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">void</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">no_bug</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">item </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> PyList_GetItem</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    Py_INCREF</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">item</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyList_SetItem</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> PyLong_FromLong</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">0L</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    PyObject_Print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">item</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> stdout</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    Py_DECREF</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">item</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果知道至少有一个对该对象的其他引用存活时间至少和我们的变量一样长，则没必要临时增加引用计数。一个典型的情形是，对象作为参数从 Python 中传递给扩展模块中的 C 函数时，调用机制会保证在调用期间持有对所有参数的引用 —— 所以扩展中的 C 函数内不必 Py_INCREF 和 Py_DECREF。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"load-and-import\">Load and Import<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#load-and-import\" class=\"hash-link\" aria-label=\"Direct link to Load and Import\" title=\"Direct link to Load and Import\">​</a></h4>\n<ul>\n<li><code>PyObject *PyImport_ImportModule(const char *name)</code></li>\n<li><code>PyObject *PyImport_Import(PyObject *name)</code></li>\n<li><code>PyObject *PyImport_AddModule(const char *name)</code></li>\n</ul>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"实例化类和方法\">实例化类和方法<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95\" class=\"hash-link\" aria-label=\"Direct link to 实例化类和方法\" title=\"Direct link to 实例化类和方法\">​</a></h4>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"创建-class\">创建 class<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%88%9B%E5%BB%BA-class\" class=\"hash-link\" aria-label=\"Direct link to 创建 class\" title=\"Direct link to 创建 class\">​</a></h4>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"参考文档\">参考文档<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3\" class=\"hash-link\" aria-label=\"Direct link to 参考文档\" title=\"Direct link to 参考文档\">​</a></h3>\n<ul>\n<li><strong>pkg-config</strong>\n<ul>\n<li><a href=\"https://people.freedesktop.org/~dbn/pkg-config-guide.html\" target=\"_blank\" rel=\"noopener noreferrer\">Guide to pkg-config</a></li>\n<li><a href=\"https://askubuntu.com/questions/210210/pkg-config-path-environment-variable\" target=\"_blank\" rel=\"noopener noreferrer\">PKG_CONFIG_PATH environment variable</a></li>\n</ul>\n</li>\n<li><strong>Python C-API</strong>\n<ul>\n<li><a href=\"https://zhuanlan.zhihu.com/p/165232299\" target=\"_blank\" rel=\"noopener noreferrer\">第 1 篇<!-- -->:CPython<!-- --> 实现原理：万物皆为 PyObject</a></li>\n<li><a href=\"https://stackoverflow.com/questions/37281669/how-to-define-a-new-class-with-methods-via-the-c-api-with-python-3\" target=\"_blank\" rel=\"noopener noreferrer\">How to define a new class with methods via the C-API with Python 3?</a>\n<ul>\n<li><a href=\"https://www.coder.work/article/5018891\" target=\"_blank\" rel=\"noopener noreferrer\">翻译： 如何使用 Python 3 通过 C-API 使用方法定义新类？ </a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"go--c\">go ~ C<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#go--c\" class=\"hash-link\" aria-label=\"Direct link to go ~ C\" title=\"Direct link to go ~ C\">​</a></h2>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/key-point.drawio-9c9934ba623716a13b85bc764822920b.svg\" class=\"img_ev3q\"></p>\n<p>下面聊聊图中的 2：神奇的 cgo ……</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"hello-world-1\">Hello World<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#hello-world-1\" class=\"hash-link\" aria-label=\"Direct link to Hello World\" title=\"Direct link to Hello World\">​</a></h3>\n<p>新建一个 go demo 项目</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ mkdir hello-world</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cd hello-world</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go mod init github.com/wkevin/demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ vi main.go</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>在 main.go 文件中通过 cgo 调用 C 标准库函数获取浮点数的最大值：</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// #include &lt;float.h&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"fmt\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\tfmt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Println</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Max float value of float is\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">FLT_MAX</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><code>import \"C\"</code> 是启动 cgo 的标志，cgo 还会自动解析紧挨这的上面的注释行，这些内容称为序文，cgo 自动解析这些注释行，减低用户的心智负担。</p>\n<p>可以通过 <code>go run</code> 直接运行：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go run main.go</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Max float value of float is 3.4028234663852886e+38</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>也可见使用 <code>go build</code> 编译后得到目标文件：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go build</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Max float value of float is 3.4028234663852886e+38</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cgo-编译过程\">cgo 编译过程<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#cgo-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B\" class=\"hash-link\" aria-label=\"Direct link to cgo 编译过程\" title=\"Direct link to cgo 编译过程\">​</a></h3>\n<p>完整的编译过程在<a href=\"https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-05-internal.html\" target=\"_blank\" rel=\"noopener noreferrer\">这里</a>有详细的描述，我来画点重点。</p>\n<p>如果 build 时添加 <code>-x</code> 参数，还能看到 cgo 完整的编译过程：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go build -x</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">WORK=/tmp/go-build4264576471</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cd /data/kevin/workspace/klearn/blog</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">git status --porcelain</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cd /data/kevin/workspace/klearn/blog</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">git -c log.showsignature=false show -s --format=%H:%ct</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">......</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>虽然代码很短，但打印很长，完整显示了 go build 的过程，包括：</p>\n<ul>\n<li>创建一个临时的工作目录，用于 cgo 转换文件<!-- -->\n<ul>\n<li><code>WORK=/tmp/go-build4264576471</code> 临时路径</li>\n</ul>\n</li>\n<li>gcc 编译用户源码，放在一个临时路径<!-- -->\n<ul>\n<li><code>packagefile github.com/wkevin/demo=/home/me/.cache/go-build/d9/d98fd26140760ead7452e4142299b280f7786db18cea8b9f078f488491323ebc-d</code> -- 我的 demo，放在了 <code>~/.cache/...</code> 下面</li>\n</ul>\n</li>\n<li>创建一个 importcfg.link 文件记录所依赖的 go 包的路径<!-- -->\n<ul>\n<li><code>packagefile xxx=yyy</code></li>\n</ul>\n</li>\n<li>link 链接<!-- -->\n<ul>\n<li><code>mkdir -p $WORK/b001/exe/</code></li>\n<li><code>/data/software/go/go.root/go1.18.2/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out ...</code></li>\n</ul>\n</li>\n<li>目标拷贝到用户目录<!-- -->\n<ul>\n<li><code>cp $WORK/b001/exe/a.out demo</code></li>\n</ul>\n</li>\n<li>删除临时路径<!-- -->\n<ul>\n<li><code>rm -r $WORK/b001/</code></li>\n</ul>\n</li>\n</ul>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cgo-知识要点\">cgo 知识要点<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#cgo-%E7%9F%A5%E8%AF%86%E8%A6%81%E7%82%B9\" class=\"hash-link\" aria-label=\"Direct link to cgo 知识要点\" title=\"Direct link to cgo 知识要点\">​</a></h3>\n<p>cgo 有 2 块内容：</p>\n<ul>\n<li>cmd/go<!-- -->\n<ul>\n<li><code>go tool cgo [cgo options] [-- compiler options] gofiles...</code></li>\n</ul>\n</li>\n<li>runtime/go: 用于在 Go 和 C 之间安全地传递 Go 值</li>\n</ul>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"命令行\">命令行<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%91%BD%E4%BB%A4%E8%A1%8C\" class=\"hash-link\" aria-label=\"Direct link to 命令行\" title=\"Direct link to 命令行\">​</a></h4>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go tool cgo --help</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"序文\">序文<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%BA%8F%E6%96%87\" class=\"hash-link\" aria-label=\"Direct link to 序文\" title=\"Direct link to 序文\">​</a></h4>\n<p>cgo 可以识别源码中 <code>import \"C\"</code> 紧挨着的上面的注释行，并分析出所需的参数，cgo 给这些注释行起了个名字：<strong>序文</strong> —— 这点总是让从其他语言转移而来的新同学大开眼界。</p>\n<p>前面 hello world 中的</p>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// #include &lt;float.h&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">import </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>也可以写成</p>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#include &lt;float.h&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">*/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">import </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><code>import \"C\"</code> 与注释之间不能有空行，注释可以多行：</p>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#include &lt;stdio.h&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#include &lt;float.h&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">*/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">import </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>序文中还支持 <code>#cgo</code> 开头的指令(directive)：</p>\n<ul>\n<li><code>CGO_CFLAGS</code>, <code>CGO_CPPFLAGS</code>, <code>CGO_CXXFLAGS</code>, <code>CGO_FFLAGS</code>, <code>CGO_LDFLAGS</code></li>\n<li><code>CFLAGS</code>, <code>CPPFLAGS</code>, <code>CXXFLAGS</code>, <code>FFLAGS</code>, <code>CPPFFLAGS</code>, <code>LDFLAGS</code></li>\n<li>交叉编译时还支持 <code>CXX*FOR_TARGET</code>, <code>CXX_FOR*${GOOS}_${GOARCH}</code></li>\n</ul>\n<p>举例</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// #cgo CFLAGS: -DPNG_DEBUG=1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// #cgo amd64 386 CFLAGS: -DX86=1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// #cgo LDFLAGS: -lpng</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// #include &lt;png.h&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"数据类型转换\">数据类型转换<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2\" class=\"hash-link\" aria-label=\"Direct link to 数据类型转换\" title=\"Direct link to 数据类型转换\">​</a></h4>\n<p>cgo 是 go 官方标准库中的一个模块，<a href=\"https://pkg.go.dev/runtime/cgo\" target=\"_blank\" rel=\"noopener noreferrer\">go doc</a> 中</p>\n<table><thead><tr><th>C 语言类型</th><th>CGO 类型</th><th>Go 语言类型</th></tr></thead><tbody><tr><td>char</td><td>C.char</td><td>byte</td></tr><tr><td>singed char</td><td>C.schar</td><td>int8</td></tr><tr><td>unsigned char</td><td>C.uchar</td><td>uint8</td></tr><tr><td>short</td><td>C.short</td><td>int16</td></tr><tr><td>unsigned short</td><td>C.ushort</td><td>uint16</td></tr><tr><td>int</td><td>C.int</td><td>int32</td></tr><tr><td>unsigned int</td><td>C.uint</td><td>uint32</td></tr><tr><td>long</td><td>C.long</td><td>int32</td></tr><tr><td>unsigned long</td><td>C.ulong</td><td>uint32</td></tr><tr><td>long long int</td><td>C.longlong</td><td>int64</td></tr><tr><td>unsigned long long int</td><td>C.ulonglong</td><td>uint64</td></tr><tr><td>float</td><td>C.float</td><td>float32</td></tr><tr><td>double</td><td>C.double</td><td>float64</td></tr><tr><td>size_t</td><td>C.size_t</td><td>uint</td></tr></tbody></table>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"参考文档-1\">参考文档<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3-1\" class=\"hash-link\" aria-label=\"Direct link to 参考文档\" title=\"Direct link to 参考文档\">​</a></h3>\n<ul>\n<li>官方文档：<a href=\"https://pkg.go.dev/cmd/cgo\" target=\"_blank\" rel=\"noopener noreferrer\">cmd/cgo</a>、<a href=\"https://pkg.go.dev/runtime/cgo\" target=\"_blank\" rel=\"noopener noreferrer\">runtime/cgo</a></li>\n<li><a href=\"https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/readme.html\" target=\"_blank\" rel=\"noopener noreferrer\">《Go 语言高级编程(Advanced Go Programming)》-- 第 2 章 CGO 编程</a>\n<ul>\n<li>内容完整，篇幅较长，并且中文，书籍的两位作者都是 Go 语言最早期国内推广者。</li>\n</ul>\n</li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/349197066\" target=\"_blank\" rel=\"noopener noreferrer\">2021.02 - Go 与 C 的桥梁：cgo 入门，剖析与实践 @ 腾讯 IEG 后台开发工程师</a>\n<ul>\n<li>完整描述了 cgo 所需的各方面知识：cgo 的 N 种语法、数据类型转换、内部机制</li>\n<li>后来发现本文大部分内容有抄袭上面书籍的嫌疑。</li>\n</ul>\n</li>\n<li><a href=\"https://cloud.tencent.com/developer/article/1650525\" target=\"_blank\" rel=\"noopener noreferrer\">2020.6 - CGO 和 CGO 性能之谜</a>\n<ul>\n<li>先报了 cgo 的黑料（不能交叉编译、性能……），然后用个小例子说明了 cgo 的原理，然后弄了个大例子说明性能损耗在真实情况下可以忽略不计，最后推荐了一些使用 cgo 的开源项目。—— 很棒的一篇文章！</li>\n</ul>\n</li>\n<li><a href=\"https://golang.design/under-the-hood/zh-cn/part3tools/ch11compile/cgo/\" target=\"_blank\" rel=\"noopener noreferrer\">13.10 cgo</a>\n<ul>\n<li><a href=\"https://golang.design/under-the-hood/\" target=\"_blank\" rel=\"noopener noreferrer\">《Go 语言原本》- 2018</a>中的一个章节，本书是 Go 源码解读系列，作者是 B 站 Go 夜读的发起人和网友们。</li>\n<li>但此章节非常简短，只是贬低了一下 cgo，并且由于撰写时已年代久远，应该已经不足为据。</li>\n</ul>\n</li>\n<li><a href=\"https://go.dev/blog/cgo\" target=\"_blank\" rel=\"noopener noreferrer\">2011.3 - C? Go? Cgo!</a>\n<ul>\n<li>go 官方网站上的一篇博客文章，2011 年，OMG，11 年前的文章，但百度上的很多水文都 copy 了这篇，一直 copy 到 2022 年。</li>\n</ul>\n</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"go--c--python\">go ~ C ~ python<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#go--c--python\" class=\"hash-link\" aria-label=\"Direct link to go ~ C ~ python\" title=\"Direct link to go ~ C ~ python\">​</a></h2>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/key-point.drawio-9c9934ba623716a13b85bc764822920b.svg\" class=\"img_ev3q\"></p>\n<p>下面聊聊图中的 3：贯穿、打通 go(cgo)--python(C-API)。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"hello-world-2\">Hello World<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#hello-world-2\" class=\"hash-link\" aria-label=\"Direct link to Hello World\" title=\"Direct link to Hello World\">​</a></h3>\n<p>同前一个 hello world 一样，新建一个 go demo 项目</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ mkdir hello-world</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cd hello-world</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go mod init github.com/wkevin/demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ vi main.go</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>在 main.go 文件中通过 cgo 调用 python C-API：</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">package</span><span class=\"token plain\"> main</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#cgo pkg-config: python-3.8-embed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#include &lt;Python.h&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">*/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token string\" style=\"color:#e3116c\">\"fmt\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">main</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\tC</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Py_Initialize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">defer</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Py_Finalize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\tfmt</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Println</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">GoString</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Py_GetVersion</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>运行或编译：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go run main.go</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.8.10 (default, Mar 15 2022, 12:22:08)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[GCC 9.4.0]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但您可能不会那么顺利，如果 python 的版本没有指定好，会遇到一些令人沮丧的提示，比如：</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"情况-1-跑不起来\">情况 1: 跑不起来<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E6%83%85%E5%86%B5-1-%E8%B7%91%E4%B8%8D%E8%B5%B7%E6%9D%A5\" class=\"hash-link\" aria-label=\"Direct link to 情况 1: 跑不起来\" title=\"Direct link to 情况 1: 跑不起来\">​</a></h4>\n<p>在我本机上虽然已经安装好了 python3.10，并且已经成功找到了其 pc 文件</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --list-all | grep python-3.10</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.10-embed              Python - Embed Python into an application</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-3.10                    Python - Build a C extension for Python</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但当我修改为</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">#cgo pkg</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">config</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> python</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">3.10</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">embed</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>时报错：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go run main.go</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/tmp/go-build3500527914/b001/exe/main: error while loading shared libraries: libpython3.10.so.1.0: cannot open shared object file: No such file or directory</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p><strong>诊断：</strong></p>\n<p>首先查看编译出的 demo 是否依赖对了：</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ objdump -x demo |grep NEEDED</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">DED</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  NEEDED               libpython3.10.so.1.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  NEEDED               libpthread.so.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  NEEDED               libc.so.6</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>或</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ readelf -d demo |grep \"Shared\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 0x0000000000000001 (NEEDED)             Shared library: [libpython3.10.so.1.0]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>或</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ldd demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  linux-vdso.so.1 (0x00007fff497b1000)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libpython3.10.so.1.0 =&gt; not found</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f8d5394d000)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8d5375b000)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  /lib64/ld-linux-x86-64.so.2 (0x00007f8d539a9000)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>3 种方法都表明依赖对了，就是找不到 libpython3.10.so.1.0。</p>\n<p>那么其实原理是这样的：</p>\n<p>Linux 中 编译运行大体分 3 步：</p>\n<ol>\n<li>compile：编译</li>\n<li>link：链接</li>\n<li>load：运行</li>\n</ol>\n<p>我们使用 <code>gcc -I... -L... -l... main.c</code> 只执行上 1、2 两步，其中 link 阶段涉及搜索库的问题，但第 3 步 load 也存在到哪里搜索依赖库文件的问题。</p>\n<ul>\n<li>首先要明确，gcc 编译过程中，gcc 只是前端，后端还有很多工具支持，如：linker、ar...</li>\n<li>linker 链接时使用 <code>LIBRARY_PATH</code> 环境变量和送入的 <code>-Lxxx</code> 参数</li>\n<li>loader 运行时使用 <code>LD_LIBRARY_PATH</code> 环境变量和 <code>/etc/ld.so.conf</code></li>\n</ul>\n<div class=\"theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary\"><div class=\"admonitionHeading_Gvgb\"><span class=\"admonitionIcon_Rf37\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>loader 知识复习</div><div class=\"admonitionContent_BuS1\"><p>运行二进制文件时，ld 更具默认查找 lib 的路径是从 <code>/etc/ld.so.conf</code> 文件和环境变量 <code>LD_LIBRARY_PATH</code> 获取的。</p><p><code>ldconfig -p</code> 可以查看当前 ld 命令能够看到的动态库，比如：</p><div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ldconfig -p |grep libpython</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libpython3.8.so.1.0 (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython3.8.so.1.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libpython3.8.so (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython3.8.so</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libpython2.7.so.1.0 (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython2.7.so.1.0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  libpython2.7.so (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython2.7.so</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>平常使用 gcc 编译、ld 链接的时候，添加临时目录可以使用 <code>LD_LIBRARY_PATH</code>，添加常用目录可以修改 <code>/etc/ld.so.conf</code> 下的文件。</p><div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ cat /etc/ld.so.conf</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">include /etc/ld.so.conf.d/*.conf</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ls /etc/ld.so.conf.d/*.conf | xargs cat</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/lib/x86_64-linux-gnu/libfakeroot</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Multiarch support</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/local/lib/i386-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/lib/i386-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/lib/i386-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/local/lib/i686-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/lib/i686-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/lib/i686-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># libc default configuration</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/local/lib</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Multiarch support</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/local/lib/x86_64-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/lib/x86_64-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/lib/x86_64-linux-gnu</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>也可以继续查看一下具体哪个路径下有多少文件：</p><div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ls /etc/ld.so.conf.d/*.conf  | xargs cat | sed '/^#/d' | xargs -I{} sh -c 'du -sh {} 2&gt;/dev/null'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">116K    /usr/lib/x86_64-linux-gnu/libfakeroot</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">368M    /lib/i386-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">368M    /usr/lib/i386-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">548K    /usr/local/lib</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.6G    /lib/x86_64-linux-gnu</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.6G    /usr/lib/x86_64-linux-gnu</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>由于我 ubuntu 根目录下的 <code>lib*</code> 都是软连接：</p><div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ll /lib*</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">lrwxrwxrwx 1 root root  7 4月   2  2020 /lib -&gt; usr/lib</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">lrwxrwxrwx 1 root root  9 4月   2  2020 /lib32 -&gt; usr/lib32</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">lrwxrwxrwx 1 root root  9 4月   2  2020 /lib64 -&gt; usr/lib64</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">lrwxrwxrwx 1 root root 10 4月   2  2020 /libx32 -&gt; usr/libx32</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>所以可见，ubuntu 主要将 lib 放在 <code>/usr/lib/i386-linux-gnu</code> 和 <code>/usr/lib/x86_64-linux-gnu</code> 中。</p></div></div>\n<p>所以解决方案也就得到了：</p>\n<ul>\n<li>临时方案</li>\n</ul>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ echo $LD_LIBRARY_PATH</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/usr/local/lib:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ LD_LIBRARY_PATH=/home/me/.pyenv/versions/3.10.5/lib:$LD_LIBRARY_PATH</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./demo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.10.5 (main, Jun 13 2022, 18:16:59) [GCC 9.4.0]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>长期方案</li>\n</ul>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ sudo ln -s ~/.pyenv/versions/3.10.5/lib/libpython3.10.so.1.0 /usr/local/lib/</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>其实 gcc 对此也是有更佳解决方案的：<code>gcc -Wl,-rpath-link,&lt;dir&gt;</code> 可以向 loader 传递寻找依赖库的路径，但一是 cgo 我暂时没找到如何传 <code>-Wl</code> 参数的方式，二来这也不是个好方案，一旦用户挪走了依赖库，则造成更难定位的故障。</p>\n<p>我尝试了</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">#cgo LDFLAGS</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">Wl</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">rpath</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">link</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\">home</span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\">me</span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">pyenv</span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\">versions</span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token number\" style=\"color:#36acaa\">3.10</span><span class=\"token number\" style=\"color:#36acaa\">.5</span><span class=\"token operator\" style=\"color:#393A34\">/</span><span class=\"token plain\">lib</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但没有成功。</p>\n<h4 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"情况-2-更新不了\">情况 2: 更新不了<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E6%83%85%E5%86%B5-2-%E6%9B%B4%E6%96%B0%E4%B8%8D%E4%BA%86\" class=\"hash-link\" aria-label=\"Direct link to 情况 2: 更新不了\" title=\"Direct link to 情况 2: 更新不了\">​</a></h4>\n<p>我将 python3-embed.pc 做成了指向 python-3.10-pc 的软连接</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ sudo rm python3-embed.pc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ sudo ln -s python-3.10-embed.pc python3-embed.pc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ pkg-config --libs python3-embed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-L/home/me/.pyenv/versions/3.10.5/lib -lpython3.10</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但执行这样的 main.go</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">#cgo pkg</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">config</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> python3</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\">embed</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>时仍然找到的是 python3.8</p>\n<div class=\"language-sh codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sh codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ go run main.go</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">3.8.10 (default, Mar 15 2022, 12:22:08)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">[GCC 9.4.0]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>有点诡异，不科学，甚至删掉 <code>//usr/lib/x86_64-linux-gnu/pkgconfig/python3-embed.pc</code> 都仍然能基于 python3.8 运行 —— 盲猜可能是被缓存了，一时不能使用最新的。</p>\n<p>过了一会再试，果然就好了。</p>\n<p>后来搜到<a href=\"https://github.com/golang/go/issues/24544\" target=\"_blank\" rel=\"noopener noreferrer\">一篇文章</a>，提到 <code>go clean -cache</code> —— 有用！再遇到就不用等了。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cgo-不识别宏定义\">cgo 不识别宏定义<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#cgo-%E4%B8%8D%E8%AF%86%E5%88%AB%E5%AE%8F%E5%AE%9A%E4%B9%89\" class=\"hash-link\" aria-label=\"Direct link to cgo 不识别宏定义\" title=\"Direct link to cgo 不识别宏定义\">​</a></h3>\n<p><code>&lt;Python.h&gt;</code>中的宏定义在 cgo 中看不到</p>\n<p>比如在 python C-API 的源码中可以找到 <code>PyNumber_Check</code> 和 <code>PyType_FastSubclass</code> 的定义：</p>\n<div class=\"language-c codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-c codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token function\" style=\"color:#d73a49\">PyAPI_FUNC</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyNumber_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">PyObject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">o</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token macro property directive-hash\" style=\"color:#36acaa\">#</span><span class=\"token macro property directive keyword\" style=\"color:#00009f\">define</span><span class=\"token macro property\" style=\"color:#36acaa\"> </span><span class=\"token macro property macro-name function\" style=\"color:#d73a49\">PyDict_Check</span><span class=\"token macro property expression punctuation\" style=\"color:#393A34\">(</span><span class=\"token macro property expression\" style=\"color:#36acaa\">op</span><span class=\"token macro property expression punctuation\" style=\"color:#393A34\">)</span><span class=\"token macro property expression\" style=\"color:#36acaa\"> </span><span class=\"token macro property expression function\" style=\"color:#d73a49\">PyType_FastSubclass</span><span class=\"token macro property expression punctuation\" style=\"color:#393A34\">(</span><span class=\"token macro property expression function\" style=\"color:#d73a49\">Py_TYPE</span><span class=\"token macro property expression punctuation\" style=\"color:#393A34\">(</span><span class=\"token macro property expression\" style=\"color:#36acaa\">op</span><span class=\"token macro property expression punctuation\" style=\"color:#393A34\">)</span><span class=\"token macro property expression punctuation\" style=\"color:#393A34\">,</span><span class=\"token macro property expression\" style=\"color:#36acaa\"> Py_TPFLAGS_DICT_SUBCLASS</span><span class=\"token macro property expression punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<ul>\n<li>PyNumber_Check: cgo 能够使用</li>\n<li>PyDict_Check: cgo 不能够使用</li>\n</ul>\n<p>可以做个封装给 cgo</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#cgo pkg-config: python3-embed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#include &lt;Python.h&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">int Cgo_PyDict_Check(PyObject *o){</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">\treturn PyDict_Check(o);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">*/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"C\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyDict_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Cgo_PyDict_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token function\" style=\"color:#d73a49\">toc</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python-c-api-的-go-封装\">Python C-API 的 go 封装<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#python-c-api-%E7%9A%84-go-%E5%B0%81%E8%A3%85\" class=\"hash-link\" aria-label=\"Direct link to Python C-API 的 go 封装\" title=\"Direct link to Python C-API 的 go 封装\">​</a></h3>\n<p>上面的 <code>PyDict_Check</code> 就是对 <code>C.Cgo_PyDict_Check</code> 的封装就是示例，直接使用 <code>C.xxx</code> 的最大问题是 VSCode 无法做智能提示，如果封装成 go，能够 <code>.</code> 出智能提示，可以减少一些工作量，同时，go 能够做强类型检查，减少编辑错误的产生。</p>\n<p>更多一些：</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">type</span><span class=\"token plain\"> PyObject C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">PyObject # </span><span class=\"token keyword\" style=\"color:#00009f\">go</span><span class=\"token plain\"> 类型直接对标 c 类型</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">togo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cobject </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cobject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">toc</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">object </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">PyObject </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">object</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyCallable_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">PyCallable_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token function\" style=\"color:#d73a49\">toc</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyNumber_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">PyNumber_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token function\" style=\"color:#d73a49\">toc</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyLong_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">PyLong_AsDouble</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token function\" style=\"color:#d73a49\">toc</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyDict_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">PyObject</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Cgo_PyDict_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token function\" style=\"color:#d73a49\">toc</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这样我的 go 代码中可以直接使用了各种 Check 函数了。</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">PyObject</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> goobj </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">PyDict_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">goobj</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// do something...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// goobj.XXX  -- go 的智能提示可以使用</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>否则需要</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">PyObject</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> cobj </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Cgo_PyDict_Check</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cobj</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// do something...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// cobj 没有智能提示</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>这里推荐 2 个开源项目:</p>\n<ul>\n<li><a href=\"https://github.com/DataDog/go-python3\" target=\"_blank\" rel=\"noopener noreferrer\">DataDog/go-python3</a>: 针对 python3 的 C-API 封装</li>\n<li><a href=\"https://github.com/sbinet/go-python\" target=\"_blank\" rel=\"noopener noreferrer\">sbinet/go-python</a>: 针对 python2 的 C-API 封装</li>\n</ul>\n<p>很可惜的是，2 个项目都已经停止开发了，不过大家仍然可以参考其源码写出自己的封装，毕竟我们一般需要封装的函数只是 C-API 全集中很少的一部分，常用的 30 个封装一下就够用了，人家维护这个项目要封装全部确实工作量很大，并且价值不高。同时该项目的目项目 DataDog，也是个不错的项目，数据收集、分析、挖掘的网络后端，下载其源码，go 写的，内部也使用了很多 python 封装，值得参考、学习。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"cpython-的-gil\">CPython 的 GIL<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#cpython-%E7%9A%84-gil\" class=\"hash-link\" aria-label=\"Direct link to CPython 的 GIL\" title=\"Direct link to CPython 的 GIL\">​</a></h3>\n<p>CPython 与其他语言（Java、C#等）实现的 python 解释器一个很大的不同点：GIL —— 它是 python 的 global interpreter lock，全局解释器锁，CPython 解释器所采用的一种机制，它确保同一时刻每个解释器进程中只有一个线程在执行 Python bytecode。单线程程序可以无视 GIL，多线程则必须先申请，拿到锁后再执行，执行完毕就释放。 —— 与二进制信号量原理一致。</p>\n<ul>\n<li><code>PyGILState_Ensure()</code>: 保存状态并锁定 GIL。</li>\n<li><code>PyGILState_Release()</code>: 恢复状态并解锁 GIL。</li>\n</ul>\n<p>由于 GIL 的存在，使得 CPython 本质上进程中只能单线程（thread），有不少网文都在试图证明多线程是个假象，如果要真正的并发，只能多进程（process）。那我有 3 个建议：</p>\n<ol>\n<li>换其他 Python 解释器吧 : )</li>\n<li>其实从嵌入式程序员角度看，这就类似于多线程（或多进程、多任务）跑在单核 CPU/MCU 上，仔细打磨照样能提升效率。比如在 GPU 计算任务、I/O 等操作时及时释放 GIL，让其他线程及时获取 GIL，整个程序的性能也能提高。——作用还是有的，仔细斟酌就是。并且线程比进程成本小，多搞几个也没啥大的副作用，不容易把程序搞死。再加上线程池的应用，就更能减少工作量了。</li>\n<li>如果没有信心这样细化操作，也可以使用 multiprocessing 模块的多进程，能够把 CPU 多核用起来了。python 的多进程是指多个解释器进程（与我们平常理解的 C 运行态的多进程还不一样），每启动一个进程本质上是创建一个解释器进程，python 代码都是喂给解释器的食物，解释器一行一行执行，就像一口一口吃，这也是 python 代码叫脚本的缘故。<strong>每个解释器进程中都维护一个 GIL，多进程可以跑在多 CPU 多核上，进程间多出来要考虑的就是进程间通信了。</strong></li>\n</ol>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"python-的进线协\">Python 的进线协<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#python-%E7%9A%84%E8%BF%9B%E7%BA%BF%E5%8D%8F\" class=\"hash-link\" aria-label=\"Direct link to Python 的进线协\" title=\"Direct link to Python 的进线协\">​</a></h3>\n<p>标准库中的下面几个模块有必要仔细阅读一下：</p>\n<p><strong>进程（Process）</strong></p>\n<ul>\n<li><a href=\"https://docs.python.org/zh-cn/3/library/subprocess.html\" target=\"_blank\" rel=\"noopener noreferrer\">subprocess --- 子进程管理（启进程执行 shell 命令）</a>\n<ul>\n<li><code>run()</code> 调用子进程，如：<code>subprocess.run([\"ls\", \"-l\"])</code>, 替代以前的 <code>os.system()</code>、<code>os.popen()</code>、<code>os.spawn*</code></li>\n<li><code>CompletedProcess</code>: <code>run()</code> 的返回值</li>\n<li><code>Popen</code>: ProcessOpen，<code>run()</code> 的底层实现</li>\n</ul>\n</li>\n<li><a href=\"https://docs.python.org/zh-cn/3/library/multiprocessing.html\" target=\"_blank\" rel=\"noopener noreferrer\">multiprocessing --- 基于进程的并行</a>\n<ul>\n<li><code>Process</code>: 进程类，<code>start()</code> 启动、<code>join()</code> 阻塞调用者，即同步</li>\n<li><code>Pool</code>：进程池</li>\n<li>进程间通信:<code>Connection=Pipe()</code>、<code>Queue</code></li>\n</ul>\n</li>\n</ul>\n<p><strong>线程（Threading）</strong></p>\n<ul>\n<li><a href=\"https://docs.python.org/zh-cn/3/library/threading.html\" target=\"_blank\" rel=\"noopener noreferrer\">threading --- 基于线程的并行</a>\n<ul>\n<li><code>Thread</code>: 线程类，<code>start()</code> 启动、<code>join()</code> 阻塞调用者，即同步</li>\n<li><strong>GIL 的 72 变</strong>：、<code>Lock</code>-原始锁、<code>RLock</code>-递归锁/重入锁、<code>Semaphore</code>-信号量、<code>Event</code>-事件、<code>Timer</code>-定时器、<code>Barrier</code>-栅栏</li>\n</ul>\n</li>\n</ul>\n<p><strong>进程 + 线程</strong></p>\n<ul>\n<li><a href=\"https://docs.python.org/zh-cn/3/library/concurrent.html\" target=\"_blank\" rel=\"noopener noreferrer\">concurrent 包</a>\n<ul>\n<li><a href=\"https://docs.python.org/zh-cn/3/library/concurrent.futures.html\" target=\"_blank\" rel=\"noopener noreferrer\">concurrent.futures --- 启动并行任务</a>\n<ul>\n<li>ThreadPoolExecutor/ProcessPoolExecutor: 创建线程池/进程池<!-- -->\n<ul>\n<li><code>.submit(fn, *args, **kwargs)</code>: 将 fn 函数提交给线程池, 返回一个 Future 对象.<!-- -->\n<ul>\n<li>Future 可以：<code>cancel()</code>、<code>running()</code>、<code>done()</code>、<code>result()</code>、<code>exception()</code>、<code>add_done_callback()</code></li>\n</ul>\n</li>\n<li><code>map(func, *iterables, timeout=None, chunksize=1)</code>: 异步方式立即对 iterables 执行 map</li>\n<li><code>shutdown(wait=True)</code>: 关闭线程池</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>协程（Coroutines）+ 进程</strong></p>\n<ul>\n<li><a href=\"https://docs.python.org/zh-cn/3/library/asyncio.html\" target=\"_blank\" rel=\"noopener noreferrer\">asyncio --- 异步 I/O</a> 包含 14 个主题，全面阐述协程的使用<!-- -->\n<ul>\n<li>高层 API<!-- -->\n<ul>\n<li>协程<!-- -->\n<ul>\n<li><code>async def foobar()</code> 定义一个协程（异步）函数</li>\n<li><code>await foobar()</code> 等待一个可等待对象（协程, 任务 和 Future）</li>\n<li><code>asyncio.create_task()</code> 并发运行作为 asyncio 任务 的多个协程</li>\n<li><code>asyncio.sleep()</code></li>\n<li><code>to_thread()</code> 在不同的 OS 线程中异步地运行一个函数</li>\n</ul>\n</li>\n<li>进程<!-- -->\n<ul>\n<li><code>asyncio.create_subprocess_shell()</code> 创建子进程</li>\n<li><code>asyncio.subprocess.PIPE/STDOUT/DEVNULL</code></li>\n</ul>\n</li>\n<li>网络 IO（略）</li>\n<li>操作<!-- -->\n<ul>\n<li><code>asyncio.run(foobar())</code> 运行协程、进程</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>底层 API（略）</li>\n</ul>\n</li>\n</ul>\n<p>协程函数不同于普通函数，调用普通函数会得到返回值，而调用异步函数会得到一个协程对象。我们需要将协程对象放到一个事件循环中才能达到与其他协程对象协作的效果，因为事件循环会负责处理子程 序切换的操作。</p>\n<p>python 将协程与异步的概念进行了强捆绑，我觉得不妥，虽然协程肯定会异步执行，但异步的并不一定就是协程，新城、进程都可以异步。相比 <code>go func()</code> 就创建一个 go 协程，就不强捆绑，舒服很多。python 背后的原因我猜想会不会也是考虑到整合网络 IO，学习 js、ts 的 async+await，但个人觉得强整不好，有害健康。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"go-的进线协\">go 的进线协<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#go-%E7%9A%84%E8%BF%9B%E7%BA%BF%E5%8D%8F\" class=\"hash-link\" aria-label=\"Direct link to go 的进线协\" title=\"Direct link to go 的进线协\">​</a></h3>\n<p>首先，python 和 go 中的进程、线程就是操作系统的进程和线程，go 和 python 以及所有语言都不会在进程（Process）、线程（Thread）上做新的定义，统一遵守操作系统的定义：</p>\n<ul>\n<li>进程：资源的最小单位</li>\n<li>线程：调度的最小单位</li>\n</ul>\n<p>但协程则没有统一的定义和规范，各家自由发挥，大概都是朝着“托管在线程中，比线程更轻量级，操作系统感知不到”这个方向努力！但是，go 和 python 的协程在创建、调度、API 方面差异还是挺大的——是几乎看不到相同点好吧！。要说 go 和 python 谁先有的协程，我还真不知道，python 好像很晚才引入的协程，但 go 才一开始就有，说不定 go 更早些。gp 还将专业术语 coroutine 演进为 gorutine，企图标榜其 G 字头的地位之特殊。</p>\n<p><strong>进程（Process）</strong></p>\n<ul>\n<li><a href=\"https://pkg.go.dev/os\" target=\"_blank\" rel=\"noopener noreferrer\">os</a>\n<ul>\n<li><code>Process</code>\n<ul>\n<li><code>func FindProcess(pid int) (*Process, error)</code></li>\n<li><code>func StartProcess()</code></li>\n<li><code>func (p *Process) Kill() error</code></li>\n<li><code>func (p *Process) Release() error</code></li>\n<li><code>func (p *Process) Signal(sig Signal) error</code></li>\n<li><code>func (p *Process) Wait() (*ProcessState, error)</code></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"https://pkg.go.dev/os/exec\" target=\"_blank\" rel=\"noopener noreferrer\">os/exec</a>\n<ul>\n<li><code>Cmd</code>\n<ul>\n<li><code>func Command(name string, arg ...string) *Cmd</code>: 创建 Cmd(shell 命令)</li>\n<li><code>func (cmd *Cmd)Run()/Start()/Wait()/...</code>: 执行/开始/等待/...</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>协程（Gorutine）与线程（Threading）</strong></p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">go</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>就创建并启动了 go 协程，极其方便，协程的生成后会被放入队列（有当前线程的本地队列，也有全局队列），然后协程调度器会自动安排，调度器可以将多个协程调度到一个线程中，一个协程也可能切换到多个线程中执行。由于线程之间也是资源共享的，所以协程之间也是资源共享的，没有“线程或协程见通信的概念和需求”，也就没有了切换开销，也不需要多线程的锁机制（没错，说的就是上面的 GIL 同学），所以效率比多线程高很多。—— 有时间的话可以看看<a href=\"https://juejin.cn/post/6844903662553137165\" target=\"_blank\" rel=\"noopener noreferrer\">Golang 的 协程调度机制 与 GOMAXPROCS 性能调优</a>。</p>\n<p>至于线程，go 编程人员几乎用不到，go 认为有协程了还用啥线程，协程比线程好用，线程的 API 就不提供了，你就认为协程就是线程算了。只留了线程锁（类似 python GIL）的 2 个接口：<code>LockOSThread()</code>,<code>UnlockOSThread()</code>，以便我们开发线程安全的可重入函数。</p>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"go-协程嵌-py-进程\">go 协程嵌 py 进程<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#go-%E5%8D%8F%E7%A8%8B%E5%B5%8C-py-%E8%BF%9B%E7%A8%8B\" class=\"hash-link\" aria-label=\"Direct link to go 协程嵌 py 进程\" title=\"Direct link to go 协程嵌 py 进程\">​</a></h3>\n<p>典型代码示例：</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">func</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">Foobar</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\truntime</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">LockOSThread</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\">         </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 别被其他 go 线程抢占了</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">defer</span><span class=\"token plain\"> runtime</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">UnlockOSThread</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Py_IsInitialized</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t\tpy</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">Py_Initialize</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t_gil </span><span class=\"token operator\" style=\"color:#393A34\">:=</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">PyGILState_Ensure</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// 别被其他 python 线程抢占了</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">defer</span><span class=\"token plain\"> C</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">PyGILState_Release</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_gil</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// do something...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>试想：</p>\n<ul>\n<li>go 程序（进程）启动后会自动创建线程池，线程池与协程之间由调度器自己安排。python 解释器进程就是 go 进程，从 <code>ps -ef</code> 里只会看到一个进程。</li>\n<li>某个调用了 C-API 的 go 函数每次可能运行在不同的协程上，也十分可能运行在不同的线程上。</li>\n<li>goroutine 执行 C 后，自身暂停。cgo 是用新线程运行 C 还是没有，我不确定，但从下面代码中看似乎 py 和 go 的 threading id 相同。</li>\n<li>如果 goroutine 函数被抢占了，安装文章 <a href=\"https://linux.cn/article-13564-1.html\" target=\"_blank\" rel=\"noopener noreferrer\">2021.7 - 如何在 Go 中嵌入 Python</a> 的说法会奔溃，但我觉得 C 和 go 已经合为一体，会延续在一个线程这执行，没有异步的情况发生，即使中间被调度到其他 CPU/核 上执行，应该也不会出错。</li>\n<li>上面示例代码我注释掉前 2 行，在 go 1.16、1.17、1.18 上测试都没有崩溃，也可能我用的框架限制了线程数，先搁置一下，以后遇到崩溃再回头来看。</li>\n</ul>\n<h3 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"参考文档-2\">参考文档<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3-2\" class=\"hash-link\" aria-label=\"Direct link to 参考文档\" title=\"Direct link to 参考文档\">​</a></h3>\n<ul>\n<li><strong>Python Embedding into Go</strong> -- go 中嵌 python<!-- -->\n<ul>\n<li>google：<code>embedding python in go</code></li>\n<li><a href=\"https://docs.python.org/zh-cn/3/extending/embedding.html\" target=\"_blank\" rel=\"noopener noreferrer\">Python 官方文档：在其它应用程序嵌入 Python</a></li>\n<li><a href=\"https://www.ardanlabs.com/blog/2020/06/python-go-grpc.html\" target=\"_blank\" rel=\"noopener noreferrer\">2020.6 - Python and Go ： Part I - gRPC</a>\n<ul>\n<li>这是有 4 篇的系列文章，分别讲述了 1.go-grpc-python、2.python-c-go、3.python 打包、4.go-内存共享-python —— 尤其是 1、4 都非常有创意，我受益匪浅。</li>\n</ul>\n</li>\n<li><a href=\"https://linux.cn/article-13564-1.html\" target=\"_blank\" rel=\"noopener noreferrer\">2021.7 - 如何在 Go 中嵌入 Python</a>\n<ul>\n<li>翻译自：<a href=\"https://www.datadoghq.com/blog/engineering/cgo-and-python/\" target=\"_blank\" rel=\"noopener noreferrer\">Cgo and Python</a> -- DataDog 的 Blog，应该是 DataDog 产品的开发者缩写，DataDog 大量使用了 Go 调 Python。</li>\n<li>特别介绍了前面书和文章中没有的 GIL（全局解释器锁）</li>\n</ul>\n</li>\n<li><a href=\"https://poweruser.blog/embedding-python-in-go-338c0399f3d5\" target=\"_blank\" rel=\"noopener noreferrer\">2020.10 - Embedding Python in Go</a></li>\n</ul>\n</li>\n<li><strong>Python Extending with Go</strong> -- python 中嵌 go<!-- -->\n<ul>\n<li><a href=\"https://hackernoon.com/extending-python-3-in-go-78f3a69552ac\" target=\"_blank\" rel=\"noopener noreferrer\">2017.12 - Extending Python 3 in Go</a>\n<ul>\n<li>文章名字与内容不符，应该是 Extending Python3 with go，但内容写的还是不错的</li>\n</ul>\n</li>\n<li><a href=\"https://www.nathanvangheem.com/posts/2017/06/03/embedding-golang-in-python-with-groupcache.html\" target=\"_blank\" rel=\"noopener noreferrer\">2017.6 - Embedding Go and groupcache in Python</a></li>\n</ul>\n</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"划重点\">划重点<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E5%88%92%E9%87%8D%E7%82%B9\" class=\"hash-link\" aria-label=\"Direct link to 划重点\" title=\"Direct link to 划重点\">​</a></h2>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/outline-bd3bc72c415a96cb53f9d8d19a058526.svg\" class=\"img_ev3q\"></p>\n<ul>\n<li>python 编译、链接<!-- -->\n<ul>\n<li><code>env PYTHON_CONFIGURE_OPTS=\"--enable-shared\" pyenv install x.y.z</code> 编译 python 的动态库</li>\n<li><code>pkg-config --variable pc_path pkg-config</code> pc 文件搜索路径</li>\n<li><code>pkg-config --list-all | grep python</code> 可用的 python pc 文件</li>\n<li><code>pkg-config --cflags --libs python3-embed</code> &amp; <code>python3.8-config --cflags --ldflags --embed</code> 获取 gcc 编译、链接参数</li>\n<li>gcc <code>pkg-config --cflags --libs python3-embed</code> main.c -o demo 可能失败</li>\n<li>gcc main.c <code>pkg-config --cflags --libs python3-embed</code> -o demo 都会成功</li>\n</ul>\n</li>\n<li>python C-API<!-- -->\n<ul>\n<li>高层 API：<code>PyRun_SimpleString</code></li>\n<li>底层 API: 其他都是</li>\n<li>PyObject：都在内存堆上，只能拥有指针，并做好引用计数。<!-- -->\n<ul>\n<li>需要用户维护引用计数的：<!-- -->\n<ul>\n<li><code>PyObject_GetAttrString()</code></li>\n<li><code>PyLong_FromLong()</code></li>\n</ul>\n</li>\n<li>不需要<!-- -->\n<ul>\n<li><code>PyImport_AddModule()</code></li>\n<li><code>PyList_GetItem()</code>、<code>PyTuple_GetItem()</code>、<code>PyDict_GetItem()</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>cgo<!-- -->\n<ul>\n<li><code>import \"C\"</code> 独立一行，前置序文 <code>#cgo</code> 指令</li>\n<li><code>go run main.go</code> or <code>go build -x</code></li>\n<li><code>go tool cgo --help</code></li>\n<li>cgo 提供的 <code>C.CString()</code>, <code>C.GoString()</code></li>\n<li><code>go clean -cache</code> 刷新 cgo 指令</li>\n</ul>\n</li>\n<li>other<!-- -->\n<ul>\n<li><code>ldd demo</code>、<code>objdump -x demo|grep NEEDED</code>、<code>readelf -d demo|grep \"Shared\"</code> 查看依赖的动态库</li>\n<li>linker use <code>LIBRARY_PATH</code></li>\n<li>loader use <code>LD_LIBRARY_PATH</code> and <code>/etc/ld.so.conf</code></li>\n</ul>\n</li>\n</ul>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"源码下载\">源码下载<a href=\"https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go#%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD\" class=\"hash-link\" aria-label=\"Direct link to 源码下载\" title=\"Direct link to 源码下载\">​</a></h2>\n<p>最后，附上本文包含，以及不包含的更深入的 <a href=\"https://wkevin.github.io/assets/files/src-70515198a66f116bc3d175cc489ce9dc.tar\" target=\"_blank\">demo 源码下载</a>。</p>",
            "url": "https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go",
            "title": "Go 调用 Python",
            "summary": "embeddding python in golang",
            "date_modified": "2022-06-02T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "python",
                "go"
            ]
        },
        {
            "id": "https://wkevin.github.io/blog/2022/05/19/vscode.wordwrap.lindwidth",
            "content_html": "<p>VSCode 中换行分 2 个方面来说：</p>\n<ol>\n<li>显示换行：用户的文档中并不真的有 <code>\\r\\n</code> 这些换行字符，而只是看到被换行了。</li>\n<li>格式化换行：用户执行格式化命令（<code>Ctrl-Shift-F</code>或<code>右鍵-formate...</code>或<code>F1-formate...</code>）时 VSCode 或扩展在文档中指定位置插入 <code>\\r\\n</code> 之类的字符。</li>\n</ol>\n<p>来看看 VSCode 中是如何配置这两种换行的。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"显示换行word-wrap\">显示换行(Word Wrap)<a href=\"https://wkevin.github.io/blog/2022/05/19/vscode.wordwrap.lindwidth#%E6%98%BE%E7%A4%BA%E6%8D%A2%E8%A1%8Cword-wrap\" class=\"hash-link\" aria-label=\"Direct link to 显示换行(Word Wrap)\" title=\"Direct link to 显示换行(Word Wrap)\">​</a></h2>\n<p>Settings 中搜索关键字 <strong>wrodwrap</strong></p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/Selection_006-c66d9f137ec9bd27c3f945095d7c75da.png#size80\" width=\"959\" height=\"545\" class=\"img_ev3q\"></p>\n<p><code>Editor:Word Wrap</code> 有 4 个选项</p>\n<ol>\n<li>off: 不换行显示</li>\n<li>on: 在窗口边缘换行显示</li>\n<li>wordWrapColumn: 用 <code>Editor: Word Wrap Column</code> 配置项中指定的数字处换行显示</li>\n<li>bounded: 取 2、3 的最小值处换行显示</li>\n</ol>\n<p>另外，编辑过程中可以使用快捷键 <code>Alt-z</code> 随时在 1 与 2/3/4 之间切换，算是个总的切换开关。</p>\n<p>希望针对某类型文件做特定设置，需要在关键字中输入：<code>@lang:... wordwrap</code>，比如 markdown</p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/markdown-wordwrap-c752e8c8774a69e2ecc01e59eaf05b56.png#size80\" width=\"1149\" height=\"548\" class=\"img_ev3q\">，<code>Word Wrap</code> 和 <code>Word Wrap Column</code> 都可以单独配置。</p>\n<p>最终写入 settings.json 中的内容形如：</p>\n<div class=\"language-json codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-json codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"editor.wordWrap\": \"wordWrapColumn\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"editor.wordWrapColumn\": 88</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"[markdown]\": {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    \"editor.wordWrap\": \"on\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  },</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"[typescript]\": {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    \"editor.wordWrap\": \"bounded\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  },</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>我比较顺手的配置是</p>\n<div class=\"language-json codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-json codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"editor.wordWrap\": \"off\",</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>哈哈，因为 <code>Alt-z</code> 我感觉已经完全够用了。</p>\n<h2 class=\"anchor anchorWithStickyNavbar_LWe7\" id=\"格式化换行format-line-width\">格式化换行(Format line width)<a href=\"https://wkevin.github.io/blog/2022/05/19/vscode.wordwrap.lindwidth#%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%8D%A2%E8%A1%8Cformat-line-width\" class=\"hash-link\" aria-label=\"Direct link to 格式化换行(Format line width)\" title=\"Direct link to 格式化换行(Format line width)\">​</a></h2>\n<p>这个主要就是各家扩展对某个特定语言的特定功能了，除了 Prettier 之外，我还很少见到其他扩展敢生成完美的格式化多种编程语言。</p>\n<p>各个扩展格式化的规则也经常在变，这里只能列举当前的一部分情况，大概率过不久就失效了。</p>\n<p>扩展安装后会注册为某种或某些文件（语言）的 formatter，此时 <code>F1 -- Format Document</code> 就可以使用，如果某个语言（文件后缀）被发现注册了多个 formatter，则会出现 <code>Format Document with...</code></p>\n<p><img decoding=\"async\" loading=\"lazy\" src=\"https://wkevin.github.io/assets/images/format.doc.with-6b552ad6e023c5d385353a71b7470b51.png#size60\" width=\"741\" height=\"140\" class=\"img_ev3q\"></p>\n<p>用户就可以选择一个，还可以设置默认的 formatter，下次 Save 的时候默认执行。</p>\n<p>但格式化换行是个危险操作，或者说至少很多人会认为是个扰民操作：凭啥替我加换行？</p>\n<p>所以很多语言 formatter 是不做主动添加换行操作的，只会在用户换行后做对齐操作。</p>\n<p>比如下面一段 go 代码：</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">append</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tes</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t\tTestEntity</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Entity1\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"PC\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t\tTestEntity</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Entity2\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"MBP\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t\tTestEntity</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Entity3\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"OPPO\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>如果使用微软官方的 go 扩展，无论怎么设置都不会自动变成一行的，除非用户自己操作，然后扩展才会接手做一些对齐操作：</p>\n<div class=\"language-go codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-go codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\t</span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">append</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tes</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TestEntity</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Entity1\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"PC\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TestEntity</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Entity2\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"MBP\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> TestEntity</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"Entity3\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"OPPO\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>又或者下面一段 ts：</p>\n<div class=\"language-ts codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-ts codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  router</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">getRoutes</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">forEach</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">val</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">val</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name </span><span class=\"token operator\" style=\"color:#393A34\">===</span><span class=\"token plain\"> _dr</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      activeMenuIcon</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">value </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> val</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">meta</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">icon </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> </span><span class=\"token builtin\">string</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>微软官方的 typescript 或 VUE 官方的 volar 等扩展都不会自动帮你换行，除非你自己添加了换行，然后它们就帮你对齐，如：</p>\n<div class=\"language-ts codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-ts codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  router</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">getRoutes</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token function\" style=\"color:#d73a49\">forEach</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">val</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">val</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name </span><span class=\"token operator\" style=\"color:#393A34\">===</span><span class=\"token plain\"> _dr</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        activeMenuIcon</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">value </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> val</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">meta</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">icon </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> </span><span class=\"token builtin\">string</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>但某些确定有歧义的地方，扩展也能帮你在换行方面纠正过来，比如：</p>\n<div class=\"language-ts codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-ts codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> </span><span class=\"token function-variable function\" style=\"color:#d73a49\">onclickMinimise</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">WindowMinimise</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>volar 就可以自动帮你删去换行，变成：</p>\n<div class=\"language-ts codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-ts codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> </span><span class=\"token function-variable function\" style=\"color:#d73a49\">onclickMinimise</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token function\" style=\"color:#d73a49\">WindowMinimise</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>总之，格式化换行是扩展都会很谨慎操作的，列个 Formatter 的表格，积累一下：</p>\n<table><thead><tr><th>Formatter</th><th>md</th><th>C/C++</th><th>python</th><th>go</th><th>ts</th><th>vue(html+js/ts+css)</th></tr></thead><tbody><tr><td>Prettier</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS-C</td><td></td><td>不断行</td><td></td><td></td><td></td><td></td></tr><tr><td>MS-python</td><td></td><td></td><td>靠扩展</td><td></td><td></td><td></td></tr><tr><td>MS-go</td><td></td><td></td><td></td><td>不断行</td><td></td><td></td></tr><tr><td>MS-ts/js</td><td></td><td></td><td></td><td></td><td>不断行</td><td></td></tr><tr><td>volar</td><td></td><td></td><td></td><td></td><td></td><td><code>&lt;template&gt;</code> 部分 <code>\"html.format.wrapLineLength\"</code><br>其他部分不断行</td></tr></tbody></table>\n<blockquote>\n<p>不断行：意思就是不主动帮用户做插入 <code>\\r\\n</code> 操作。</p>\n</blockquote>\n<p>所以其实除了会对 html、xml 等标签类文本的 formatter 会主动断行外，好像都会保持缄默。以前记得有些 formatter 会对函数入参比较多的时候进行断行，忘了是哪个扩展了。</p>\n<blockquote>\n<p>靠扩展：意思是自己不做断行，交给另外的扩展</p>\n</blockquote>\n<p>MS-python 可以使用的扩展有：Settings -- python formatting provider：</p>\n<ul>\n<li>autopep8：默认的</li>\n<li>yapf：非常权威的</li>\n<li>black：后起之秀，需要自己安装 <code>pip install black</code> —— 我个人将其设置为默认了。</li>\n</ul>\n<p>3 个 formatter 的 provider，各自断行的参数也不同：</p>\n<div class=\"language-json codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-json codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">// settings.json</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">{</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"python.formatting.provider\": \"black\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"python.formatting.blackArgs\": [\"--line-length=180\"],</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"python.formatting.autopep8Args\": [\"--max-line-length=180\"]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>最后还得提醒，volar 的这种自动断行的行为是有风险的，比如：</p>\n<div class=\"language-html codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-html codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token tag punctuation\" style=\"color:#393A34\">&lt;</span><span class=\"token tag\" style=\"color:#00009f\">td</span><span class=\"token tag punctuation\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\">{{ DateTime.fromSeconds(log.timestamp).toFormat('yyyy-MM-dd HH: MM: ss') }}</span><span class=\"token tag punctuation\" style=\"color:#393A34\">&lt;/</span><span class=\"token tag\" style=\"color:#00009f\">td</span><span class=\"token tag punctuation\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>\n<p>当我 <code>\"html.format.wrapLineLength\": 80</code> 的时候，就会被 volar 断成这样：</p>\n<div class=\"language-html codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-html codeBlock_bY9V thin-scrollbar\" style=\"color:#393A34;background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token tag punctuation\" style=\"color:#393A34\">&lt;</span><span class=\"token tag\" style=\"color:#00009f\">td</span><span class=\"token tag punctuation\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\">{{ DateTime.fromSeconds(log.timestamp).toFormat('yyyy-MM-dd</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            HH: MM: ss') }}</span><span class=\"token tag punctuation\" style=\"color:#393A34\">&lt;/</span><span class=\"token tag\" style=\"color:#00009f\">td</span><span class=\"token tag punctuation\" style=\"color:#393A34\">&gt;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" class=\"copyButtonIcon_y97N\"><path fill=\"currentColor\" d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg viewBox=\"0 0 24 24\" class=\"copyButtonSuccessIcon_LjdS\"><path fill=\"currentColor\" d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>",
            "url": "https://wkevin.github.io/blog/2022/05/19/vscode.wordwrap.lindwidth",
            "title": "VSCode 中的显示换行和格式化换行",
            "summary": "vscode.wordwrap.lindwidth",
            "date_modified": "2022-05-19T00:00:00.000Z",
            "author": {
                "name": "wKevin",
                "url": "http://weibo.com/wkevin27"
            },
            "tags": [
                "vscode",
                "word-wrap",
                "lind-width"
            ]
        }
    ]
}