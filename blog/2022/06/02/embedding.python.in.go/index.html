<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="wkevin RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="wkevin Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="wkevin JSON Feed">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Go 调用 Python | wkevin</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Go 调用 Python | wkevin"><meta data-rh="true" name="description" content="embeddding python in golang"><meta data-rh="true" property="og:description" content="embeddding python in golang"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-06-02T00:00:00.000Z"><meta data-rh="true" property="article:author" content="http://weibo.com/wkevin27"><meta data-rh="true" property="article:tag" content="python,go"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go"><link data-rh="true" rel="alternate" href="https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go" hreflang="en"><link data-rh="true" rel="alternate" href="https://wkevin.github.io/blog/2022/06/02/embedding.python.in.go" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.a44d9312.css">
<link rel="preload" href="/assets/js/runtime~main.daa8ee8e.js" as="script">
<link rel="preload" href="/assets/js/main.a87ad509.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="wkevin Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="wkevin Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">wKevin</b></a><a class="navbar__item navbar__link" href="/docs/stack/">技术栈</a><a class="navbar__item navbar__link" href="/docs/project/industry/">业务场</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog/tags">Tags</a><a class="navbar__item navbar__link" href="/blog/rss.xml">Feed</a><a href="https://github.com/wkevin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Go 调用 Python</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-06-02T00:00:00.000Z" itemprop="datePublished">June 2, 2022</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="http://weibo.com/wkevin27" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="/img/avastar/angry.bird-l.jpg" alt="wKevin"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="http://weibo.com/wkevin27" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">wKevin</span></a></div><small class="avatar__subtitle" itemprop="description">一颗向上的水滴</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Go 怎么调用 Python？或者说 Python 怎么嵌入到 Go？—— 我要研究明白。</p><ul><li>方案 1：go -- RESTFul -- python<ul><li>需要用户起一个 python 进程的 http server 进程，并且定义 RESTFul API。</li></ul></li><li>方案 2：go -- rpc -- python<ul><li>可用 grpc 或其他 rpc，也是需要单独启动一个 python 进程并开启 rpc server，go 中代码作为 rpc client。</li></ul></li><li>方案 3：go -- cgo/内存共享 -- python(C-API)<ul><li>python 的解释器绝大多数人都是使用官方的 CPython，内核和解释器是用 C 实现的，可以用 C 代码方便的调用。</li><li>go 又和 C 是天然搭档，通过标准库中的 cgo 组件可以无缝调用 C。</li><li>此时 python core 作为动态库链接到 go 上。</li></ul></li></ul><p>RESTFul 和 RPC 都是网络调用方式，更适合高度解耦的场景，cgo 或直接内存共享则是效率优先。 —— 我打算先摸索一下方案 3。一通搜索，找到了一些好文章，再加上 10 天左右的实战摸索，总结以下要点：</p><p><img loading="lazy" src="/assets/images/key-point.drawio-9c9934ba623716a13b85bc764822920b.svg" width="371" height="371" class="img_E7b_"></p><p>下面依次展开描述图中 1、2、3：</p><ol><li><strong>Python C-API</strong><ul><li>Python 对外提供 <code>Python.h</code>，include 此文件即可访问 CPython 提供的 C API。</li><li>通过 Python C API，调用 Python C 库，包括 Python 解析器、Python Core、Python 标准库……，由此可以实现 2 类需求：<ul><li>为 Python 写<strong>扩展</strong>：可以用 C 语言或其他语言（如 go），通过 C-API 写个扩展，编译后放在 Python 库中，供任意 py 脚本调用。—— 官方文档中称之为 Extending Python With C</li><li>将 Python <strong>嵌入</strong>到其他语言中：—— 官方文档称之为 Embedding Python into C，我们这里要进一步 Embedding Python into Go。</li></ul></li></ul></li><li><strong>cgo</strong><ul><li>cgo 是 go 官方实现的一套 toolchain 工具 + 转换库函数，能够将 go 的数据转为 c（如：<code>C.CString()</code>）或反之（如：<code>C.GoString()</code>），其工具能够自动调用 gcc、glibc、能够使用 pkg-config 等工具发现编译参数……。</li><li>cgo 调用 C 标准库仅需 1 行 <code>import &quot;C&quot;</code> ，然后在 go 代码中即可 <code>C.print(&quot;foobar&quot;);</code></li><li>基于 cgo 的方式，有热心网友做了更高层次的封装，如：<ul><li>封装 Python2 C-API 的 <a href="https://github.com/sbinet/go-python" target="_blank" rel="noopener noreferrer">sbinet/go-python</a>、<a href="https://github.com/spikeekips/embedding-python-in-golang" target="_blank" rel="noopener noreferrer">spikeekips/embedding-python-in-golang</a></li><li>封装 Python3.7 C-API 的 <a href="https://github.com/DataDog/go-python3" target="_blank" rel="noopener noreferrer">DataDog/go-python3</a>（已停止）及其 fork <a href="https://github.com/go-python/cpy3" target="_blank" rel="noopener noreferrer">go-python/cpy3</a>，但都仅限于 python3.7，并且已经多年不维护。</li></ul></li></ul></li><li><strong>go</strong><ul><li>go 中除了直接调用 <code>C.xxx</code> 变量和函数之外，就是要特别考虑：<ul><li>协程并发：go 中的协程如何与 C 中的函数保持可重入性和幂等性，如果 C 函数不可重入，要封装加锁，或 go 代码中加锁。</li><li>对 C 对象生命周期的管理：C 中本来没有对象，它也不是面向对象语言，但 Python 封装带 PyObject 数据结构，具有高级语言对象的完整特征，但又不能自动垃圾回收，所以使用 PyObject 但手工维护指针计数，以放置内存泄露——几乎可以说搞定 Python C-API 的第一个必过考点、难点。</li></ul></li></ul></li></ol><p>好吧，开始启程，章节安排依然是上图中的 1、2、3。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="python--c">Python ~ C<a class="hash-link" href="#python--c" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="嵌入与扩展">嵌入与扩展<a class="hash-link" href="#嵌入与扩展" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="/assets/images/Selection_014-459475125fa59b537a2eab1d35be085b.png#size80" width="1055" height="545" class="img_E7b_"></p><p>Python 官方文档首页中的这个主题：<a href="https://docs.python.org/3/extending/index.html" target="_blank" rel="noopener noreferrer">Extending and Embedding</a>，从 python2 至今 3.10，一直都在这里，其中内容分 2 块：</p><ul><li>Extending（扩展）：使用 C 编写 python 扩展模块，作为 Python 自身源码中大量扩展模块（有 C 也有 Python 实现的）的扩充。</li><li>Embedding（嵌入）：将 Python 解释器、Core 嵌入到另一个应用程序中，这样另一名语言可以调用 Python 的 Core 和标准库、第 3 方库……。</li></ul><p><img loading="lazy" src="/assets/images/python.extending.and.embedding-f11742d802937f69d5a836cd5aed4dc7.svg" width="494" height="501" class="img_E7b_"></p><p>画了个可能不是很准确的图，表达一下我对扩展和嵌入的理解。</p><ul><li>括号中的部分(<code>(Python/*.c)</code>、<code>(Lib/*.py)</code>)表示这些模块在 CPython 源码中的文件夹，及其实现语言，<a href="https://www.python.org/downloads/source/" target="_blank" rel="noopener noreferrer">官方网站</a>可以下载任一版本的源码。</li><li>大圆圈中的 Python Core 与 Parser、Objects、Moudules 等编译后生成 python 解释器(一般位于 <code>/usr/bin/python</code>)和 python 库（一般位于<code>/usr/lib/x86_64_linux-gnu/libpythonx.y.a</code>）,都是二进制文件。其中我把 C-API 放在了正中间，表示几乎所有其他模块的源码，都会 include 其中的头文件。</li><li>标准库的 python 部分源码在 <code>Lib/*.py</code>，安装时不编译，以源码形式安装（一般位于<code>/usr/lib/pythonx.y/</code>）</li></ul><p>官方文档中有一段对比的解释：</p><p>扩展 Python 和嵌入 Python 的过程相当类似：</p><p>从 Python 到 C 的扩展代码到底做了什么： —— 对应上图中红色线条及 1、2、3。</p><ol><li>将 Python 的数据转换为 C 格式，</li><li>用转换后的数据执行 C 程序的函数调用，</li><li>将调用返回的数据从 C 转换为 Python 格式。</li></ol><p>嵌入 Python 时，接口代码会这样做： —— 对应上图中蓝色线条及 1、2、3。</p><ol><li>将 C 数据转换为 Python 格式，</li><li>用转换后的数据执行对 Python 接口的函数调用，</li><li>将调用返回的数据从 Python 转换为 C 格式。</li></ol><p>可能一般我们认识 python 都是从 python 的命令行开始的，比如我们查看 python3.8 可执行文件（解释器）：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ file /usr/bin/python3.8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/bin/python3.8: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=1f3df9df2b5e575fdee41890fe17f6de614f93f6, for GNU/Linux 3.2.0, stripped</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>从这个命令行可以启动一个 py 文件：<code>python foobar.py</code>，但同时 python 还包含一个二进制的库，根据安装或源码编译的参数不同，可以是静态库或动态库：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ file /usr/lib/x86_64-linux-gnu/libpython3.8.a</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">./libpython3.8.a: symbolic link to ../python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>原来是个软连接</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ file /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a: current ar archive</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>还是个压缩包</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ readelf -h /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a |grep &quot;^File:*&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(getbuildinfo.o)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(acceler.o)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(grammar1.o)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(listnode.o)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(node.o)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">File: /usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.a(parser.o)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">......</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>170+ .o 合并而成，对应上图中的大圆圈中相应的 .c 文件。</p><p>我们来总结一下：</p><ul><li>扩展：指的是 C 语言实现的与标准库 C 部分类似的，可以通过 C-API 调用 Core、Object、Moudules，从而实现的功能扩展。<ul><li>相比 python 在上层基于标准库实现的扩展或模块，C 扩展可以实现更底层的功能，比如：实现新的内置对象类型、调用 C 的库函数和系统调用 —— 这都是 python 调用标准库而实现的扩展模块做不到的。</li><li>C 写的扩展也需要编译为二进制、连接后才能使用，不能像 python 一样由词法器、解释器运行期处理。</li><li>可以用 disutils 编译 C 扩展，如：<code>python setup.py build</code>，会自动调用 gcc 生成 .so 或 .o。</li><li>然后扩展也可以与其他 python 编写的扩展一样，发布到 pypi</li></ul></li><li>嵌入：指的是将 python 解释器嵌入到其他语言或 APP 中，不再是主进程，而是被其他语言（C、go 等）主进程调用的派成进程。</li><li>扩展和嵌入都是调用 C-API</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="python-c-的编译">python C 的编译<a class="hash-link" href="#python-c-的编译" title="Direct link to heading">​</a></h3><p>下面我们来写一些简短的 C 来实际调用一下 Python C API。但是写代码之前，非常有必要认识一下 pkg-config 这个工具。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="pkg-config">pkg-config<a class="hash-link" href="#pkg-config" title="Direct link to heading">​</a></h4><p>pkg-config 是用来收集系统上已安装库的元数据的小工具，Linux、macOS、Windows 上都可以使用，可以用在向 gcc、make 等提供数据的场景，是 <strong>gcc 的好帮手</strong>。</p><p>对于库的开发人员来说，随库版本一起发布和安装 pkg-config 文件（<code>*.pc</code>）可以简化用户（gcc）寻找信息的方法和时间。</p><p><strong>安装：</strong></p><p>如果想从源码安装，可以到 <a href="https://www.freedesktop.org/wiki/Software/pkg-config/" target="_blank" rel="noopener noreferrer">官网</a> 上<a href="http://pkgconfig.freedesktop.org/releases/" target="_blank" rel="noopener noreferrer">下载源码</a>，或从 <a href="https://gitlab.freedesktop.org/pkg-config/pkg-config" target="_blank" rel="noopener noreferrer">这里</a>找到 git 库地址 <code>git clone https://gitlab.freedesktop.org/pkg-config/pkg-config.git</code>。然后 configuration、make...</p><p>但还是简单点，不折腾，安装二进制版本吧：</p><ul><li>Linux: 各大发行版都默认安装了，直接使用。</li><li>macOS: <code>brew -v install pkg-config</code></li><li>windows: 待研究，好像要用到 MinGW，那干脆直接用微软在 windows 内嵌的原生 Linux 算了。</li></ul><p><strong>工作原理：</strong></p><p>pkg-config 搜索 <code>*.pc</code> 文件，路径可以用下面命令查看：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --variable pc_path pkg-config</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/local/lib/x86_64-linux-gnu/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/share/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li><code>/usr/local/lib/x86_64-linux-gnu/pkgconfig</code></li><li><code>/usr/local/lib/pkgconfig</code></li><li><code>/usr/local/share/pkgconfig</code></li><li><code>/usr/lib/x86_64-linux-gnu/pkgconfig</code> —— 我的电脑这里有 280+ 个</li><li><code>/usr/lib/pkgconfig</code></li><li><code>/usr/share/pkgconfig</code> —— 40+ 个</li></ul><p>另外，环境变量 <code>PKG_CONFIG_PATH</code> 也影响 pkg-config 搜索 pc 文件的路径。</p><p>用下面的命令可以查看已经搜索到 pc 文件，即表示能够使用的库，比如：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --list-all | grep glib-2</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">glib-2.0                       GLib - C Utility Library</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>说明本机已经安装了 glib-2.0 库，可以使用了：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --cflags glib-2.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --libs glib-2.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-lglib-2.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>--cflags</code> 和 <code>--libs</code> 是最常用的 pkg-config 参数，获取指定库自己暴露的头文件和库文件位置，并封装为相应的 gcc 参数（即添加 <code>-I</code>、<code>-L</code> 前缀）。在我的电脑里：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --cflags --libs glib-2.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include -lglib-2.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>这样聚合到 gcc 或 make 中就可以这样：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs glib-2.0` main.c -o main</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>等效于</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc -I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include -lglib-2.0 main.c -o main</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="pythons-pkg-config">python&#x27;s pkg-config<a class="hash-link" href="#pythons-pkg-config" title="Direct link to heading">​</a></h4><p>我本机安装了多个版本的 python，pkg-config 都可以找到：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --list-all | grep python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python2                        Python - Python library</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-2.7                     Python - Python library</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python3                        Python - Build a C extension for Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python3-embed                  Python - Embed Python into an application</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.8                     Python - Build a C extension for Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.8-embed               Python - Embed Python into an application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>还可以通过 <code>PKG_CONFIG_PATH</code> 环境变量增加搜索 <code>*.pc</code> 文件的路径，如新增我用 pyenv 安装的更多 python：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">export PKG_CONFIG_PATH=~/.pyenv/versions/3.9.2/lib/pkgconfig</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>然后就可以找到 3.9 的 python 了：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --list-all | grep python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python2                        Python - Python library</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-2.7                     Python - Python library</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python3                        Python - Build a C extension for Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python3-embed                  Python - Embed Python into an application</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.8                     Python - Build a C extension for Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.8-embed               Python - Embed Python into an application</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.9                     Python - Build a C extension for Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.9-embed               Python - Embed Python into an application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>你应该注意到了，每个 python 都有 2 个 pc 文件，根据其注释，明确表明了 2 个 pc 的用途：</p><ol><li>Build a C extension for Python —— 扩展</li><li>Embed Python into an application —— 嵌入</li></ol><p>所以当我们开发扩展 or 嵌入的时候，一定要使用相应的 pc 文件。</p><p>对比一下：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ cat /usr/lib/x86_64-linux-gnu/pkgconfig/python3.pc</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># See: man pkg-config</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">prefix=/usr</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">exec_prefix=${prefix}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">includedir=${prefix}/include</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Name: Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Description: Build a C extension for Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Requires:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Version: 3.8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Libs.private: -lcrypt -lpthread -ldl  -lutil -lm</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Libs:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Cflags: -I${includedir}/python3.8 -I${includedir}/x86_64-linux-gnu/python3.8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ cat /usr/lib/x86_64-linux-gnu/pkgconfig/python3-embed.pc</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># See: man pkg-config</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">prefix=/usr</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">exec_prefix=${prefix}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libdir=${exec_prefix}/lib</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">includedir=${prefix}/include</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Name: Python</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Description: Embed Python into an application</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Requires:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Version: 3.8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Libs.private: -lcrypt -lpthread -ldl  -lutil -lm</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Libs: -L${libdir} -lpython3.8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Cflags: -I${includedir}/python3.8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>所以相同命令得到不同结果：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --libs python3</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --libs python3-embed</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-lpython3.8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>扩展不需要 Libs 配置参数，嵌入需要 —— 想想为什么？</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="python-共享库">python 共享库<a class="hash-link" href="#python-共享库" title="Direct link to heading">​</a></h4><p>如果你使用 pyenv，通过编译 python 源码生成的 python 可执行文件，通常会连带生成其静态库，如：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ls /home/me/.pyenv/versions/3.9.2/lib/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libpython3.9.a  pkgconfig  python3.9</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>但 python 还可以编译成共享库（动态库）：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ env PYTHON_CONFIGURE_OPTS=&quot;--enable-shared&quot; pyenv install 3.9.2</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ls /home/me/.pyenv/versions/3.9.2/lib/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libpython3.9.a  libpython3.9.so  libpython3.9.so.1.0  libpython3.so  pkgconfig  python3.9</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>多出来的 <code>libpython3.9.so</code> 即共享库，可用于嵌入 python 的相关开发，前面 <code>-lpython3.x</code> 也就是指的它了。</p><p>文档参考<a href="https://kgithub.com/pyenv/pyenv/wiki#how-to-build-cpython-with---enable-shared" target="_blank" rel="noopener noreferrer">pyenv 的 wiki</a>。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="python-的-flag-还能这样获取">python 的 flag 还能这样获取<a class="hash-link" href="#python-的-flag-还能这样获取" title="Direct link to heading">​</a></h4><p>python 官方还提供了另外一个工具，更专业的提供 gcc 编译参数：</p><p>输入 python3. 然后 tab 键，自动弹出的工具里有一类： pythonx.x-config</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ python3.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python3.5          python3.5m         python3.6-config   python3.6m-config  python3.7-gdb.py   python3.8          python3.9</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python3.5-config   python3.5m-config  python3.6-gdb.py   python3.7          python3.7m         python3.8-config   python3.9-config</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python3.5-gdb.py   python3.6          python3.6m         python3.7-config   python3.7m-config  python3.8-gdb.py   python3.9-gdb.py</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>用法示例：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ python3.9-config --cflags</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-I/home/me/.pyenv/versions/3.9.2/include/python3.9 -I/home/me/.pyenv/versions/3.9.2/include/python3.9  -Wno-unused-result -Wsign-compare  -DNDEBUG -g -fwrapv -O3 -Wall</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ python3.8-config --ldflags</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-L/usr/lib/python3.8/config-3.8-x86_64-linux-gnu -L/usr/lib  -lcrypt -lpthread -ldl  -lutil -lm -lm</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>如果要使用嵌入特性，则使用 <code>--embed</code> 参数，如：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ python3.8-config --cflags --ldflags --embed</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-I/usr/include/python3.8 -I/usr/include/python3.8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-Wno-unused-result -Wsign-compare -g</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-fdebug-prefix-map=/build/python3.8-4wuY7n/python3.8-3.8.10=.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-specs=/usr/share/dpkg/no-pie-compile.specs -fstack-protector</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-Wformat -Werror=format-security  -DNDEBUG -g -fwrapv -O3 -Wall</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-L/usr/lib/python3.8/config-3.8-x86_64-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-L/usr/lib</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-lpython3.8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-lcrypt -lpthread -ldl  -lutil -lm -lm</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>比暴露给 pkg-config 的更完整，对故障打印格式等信息也做了优化，所以我们就可以这样：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `python3-config --cflags --ldflags --embed` main.c</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>来代替</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs python3-embed` main.c</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>或者干脆写一个二合一的 shell 脚本：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">gcc `pkg-config --cflags --libs python3-embed` main.c</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">if [ $? != 0 ];then</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">gcc `python3-config --cflags --ldflags --embed` main.c</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">fi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="hello-world">Hello World<a class="hash-link" href="#hello-world" title="Direct link to heading">​</a></h3><p>现在，我们必须来实现一个上面提到的、简单的 main.c 了。</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// main.c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&lt;Python.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">printf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;hello python c api\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">Py_Initialize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">printf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;%s&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">Py_GetVersion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">Py_Finalize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li><code>Py_Initialize</code> 初始化 Python Core</li><li><code>Py_Finalize</code> 停止 Python Core</li><li><code>Py_GetVersion</code> 中间用 c 语言的 print，打印了 Python 的版本。</li></ul><p>3 个函数都是 <code>&lt;Python.h&gt;</code> 中提供的。执行结果：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">hello python c api</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.9.13 (main, May 24 2022, 21:28:12)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">[Clang 12.0.0 (clang-1200.0.32.29)]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="情况-1-编译失败">情况 1: 编译失败<a class="hash-link" href="#情况-1-编译失败" title="Direct link to heading">​</a></h4><p>也许你不是很顺利，编译报错，比如：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/bin/ld: /tmp/ccteb8Kn.o: in function `main&#x27;:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">main.c:(.text+0x15): undefined reference to `Py_Initialize&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/bin/ld: main.c:(.text+0x1a): undefined reference to `Py_GetVersion&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/bin/ld: main.c:(.text+0x33): undefined reference to `Py_Finalize&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">collect2: error: ld returned 1 exit status</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>找不到需要的动态库?</p><p>确认一下 libpython3...</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --cflags --libs python3-embed</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-I/home/me/.pyenv/versions/3.8.13/include/python3.8 -L/home/me/.pyenv/versions/3.8.13/lib -lpython3.8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ls /home/me/.pyenv/versions/3.8.13/lib</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libpython3.8.so  libpython3.8.so.1.0  libpython3.so  pkgconfig  python3.8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>libpython3.8.so 就在指定的位置，那为啥找不到？</p><p>把动态库放在本地试试</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ln -s /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so.1.0 ./</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo ./libpython3.8.so.1.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">hello python c api</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.8.13 (default, Jun 15 2022, 09:07:53)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">[GCC 9.4.0]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>成功！难道 <code>-L</code> 参数不工作了？</p><p>试试编译和链接分开：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags python3-embed` main.c -c</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ file main.o</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">main.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc main.o /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so -o demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">hello python c api</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.8.10 (default, Mar 15 2022, 12:22:08)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">[GCC 9.4.0]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>咦？链接的 3.8.13，运行是 3.8.10？</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ldd demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libpython3.8.so.1.0 =&gt; /lib/x86_64-linux-gnu/libpython3.8.so.1.0 (0x00007f51bc49d000)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ......</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>哦，这应该是那个 linker and loader 的常见问题，重新来：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ LD_LIBRARY_PATH=/home/me/.pyenv/versions/3.8.13/lib/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">hello python c api</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.8.13 (default, Jun 15 2022, 09:07:53)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">[GCC 9.4.0]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>偶然间发现：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so main.o -o demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/bin/ld: /tmp/ccZv3FZH.o: in function `_Py_DECREF&#x27;:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">main.c:(.text+0x39): undefined reference to `_Py_Dealloc&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/bin/ld: /tmp/ccZv3FZH.o: in function `main&#x27;:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">main.c:(.text+0x59): undefined reference to `Py_Initialize&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/bin/ld: main.c:(.text+0x5e): undefined reference to `Py_GetVersion&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>这就诡异了：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc main.o /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so -o demo # 成功</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc /home/me/.pyenv/versions/3.8.13/lib/libpython3.8.so main.o -o demo # 失败</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc main.o `pkg-config --libs python3-embed` -o demo # 成功</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --libs python3-embed` main.o -o demo # 失败</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>那不分开编译，也更换一下顺序呢？</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc main.c `pkg-config --cflags --libs python3-embed` -o demo # 成功</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo # 失败</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>难道是我健忘症犯了？忘记了 gcc 的哪个细节？我怎么完全没印象以前遇到过这个问题啊？</p><p>又找了几个电脑的 gcc 测试，发现有些版本的都成功，有些和我一样，macOS 的则全部都成功 —— 不会是某个 gcc 版本的 bug 吧！</p><p>最后我又测试了这样：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags python3-embed` main.c `pkg-config --libs python3-embed` -o demo</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>也是成功的，难道 linker 必须放在 compiler 后面，gcc 哪个版本开始做这个强制要求了？</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="高层-api">高层 API<a class="hash-link" href="#高层-api" title="Direct link to heading">​</a></h4><p>可以使用 <code>PyRun_SimpleString</code> 直接执行 python 语句：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">printf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;hello python c api\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">Py_Initialize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">PyRun_SimpleString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;import datetime&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">PyRun_SimpleString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;print(datetime.datetime.now())&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">Py_Finalize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">hello python c api</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2022-06-13 20:41:05.210003</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="底层-api">底层 API<a class="hash-link" href="#底层-api" title="Direct link to heading">​</a></h4><p><code>PyRun_SimpleString</code> 可以说是最高层、也是最简单的 Python 提供的 C-API 了，就是个简单的套壳，相当于从 C 切入，运行了 py 代码，再转回 c 代码。从效率上讲不是个好方案，还好 python 只提供了这 1 个高层函数，其他大量、巨量的都是底层函数，比如：</p><ul><li><code>mod = PyImport_ImportModule(&quot;foo.bar&quot;)</code> 导入模块，相当于 <code>import foo.bar</code>，mod 是个 C 的 struct <code>struct PyObject</code>。</li><li><code>attr = PyObject_GetAttrString(mod, &quot;foobar&quot;)</code> 获取 module 的某个属性，比如函数、class、变量……返回的 attr 也是 PyObject —— 一切都是 PyObject。</li><li><code>PyTuple_New</code>、<code>PyTuple_New</code> 创建并赋值元组</li><li><code>PyLong_FromLong</code>、<code>PyLong_AsLong</code> 在 c 语言的 long 和 PyObject 之间互转。</li><li><code>PyObject_CallObject</code> 调用函数</li></ul><p>来看代码吧：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">// 底层 API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  PyObject </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">mod</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">val</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">rlt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  mod </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyImport_ImportModule</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;random&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mod </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    func </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyObject_GetAttrString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mod</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;randint&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">func </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyCallable_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      args </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyTuple_New</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// 添加第 0 个参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      val </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyLong_FromLong</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">PyTuple_SetItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">Py_DECREF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">val</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// 添加第 1 个参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      val </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyLong_FromLong</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">PyTuple_SetItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">Py_DECREF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">val</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// 调用函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      rlt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyObject_CallObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">printf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Result of call: %ld\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyLong_AsLong</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rlt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">Py_DECREF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">Py_DECREF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rlt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">Py_Finalize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><a target="_blank" href="/assets/files/main-afee0b835a93747983bda535ebe8c528.c">下载 main.c</a></p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Result of call: 54</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>得到了一个随机数 54。上面近 30 行的 C 代码如果用 python 来实现的话可能只需这样：</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> random</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Result of call:&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> random</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>没错，就是 2 行 —— 为啥用了 python 就再也回不去 C 了，因为这是血淋淋的降维打击。</p><p>最后还需特别说明一下 <code>Py_DECREF</code>，因为 C 没有对象，Python 的 PyObject 完全是用 C 实现了面向对象，但又不能用 Python 自己的对象指针自动维护、垃圾回收。创建一个 PyObject 对象，对象的指针会 +1，但 -1 的任务就落在了使用者身上，如果不及时 -1，PyObject 对象实例就会永远驻留在内存中，造成内存泄露。<code>Py_DECREF</code> 就是操作 PyObject 指针指向的 PyObject 对象内的指针引用计数 -1。</p><p>OK，Hello World 差不多了，如果在团队中不负责这一块，了解到这里就差不多了，可以跳过下面的几个小结，直奔 go-c 章节了。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="python-c-api-知识要点">python C-API 知识要点<a class="hash-link" href="#python-c-api-知识要点" title="Direct link to heading">​</a></h3><p>几乎一切都可以在 Python 的官方文档中找到答案。</p><ul><li><a href="https://docs.python.org/zh-cn/3/extending/index.html" target="_blank" rel="noopener noreferrer">扩展和嵌入 Python 解释器</a></li><li><a href="https://docs.python.org/zh-cn/3/c-api/index.html" target="_blank" rel="noopener noreferrer">Python/C-API 参考手册</a></li></ul><p>都有中文翻译，但大概只有 50% 左右翻译了。下面根据我实战中经验记录一些陷阱和提示吧。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="pyobject引用计数垃圾回收">PyObject、引用计数、垃圾回收<a class="hash-link" href="#pyobject引用计数垃圾回收" title="Direct link to heading">​</a></h4><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Spec</h5></div><div class="admonition-content"><p><strong>没有人可以拥有一个对象，对象都在内存堆上，你只能拥有一个对象的指针（引用）。</strong></p></div></div><p>几乎所有 Python 对象存放在堆中：你不能声明一个类型为 PyObject 的自动或静态的变量，只能声明类型为 <code>PyObject*</code> 的指针。</p><ul><li>对象指针的拥有：生成某个对象指针变量的函数称为其拥有者，有责任及时调用 <code>Py_DECREF()</code>。</li><li>对象指针的借用：<ul><li>拥有者将指针 copy 给另一方，借用出去，即接收方不新建指针（临时）变量，也不应该调用 <code>Py_DECREF()</code>。</li><li>因为借入者（接收方）只是借用，你的 Py_DECREF 会导致拥有者逻辑失效，当拥有者 Py_DECREF 的时候出现异常。</li><li>借入者一旦 <code>Py_INCREF()</code>，则变为拥有者，就要及时 <code>Py_DECREF()</code>。</li></ul></li></ul><p>我这里做个比喻</p><ul><li><strong>管杀不管埋（传递）</strong>，即：负责创建 PyObject 对象，然后 <code>Py_INCREF()</code>，或不是新建对象，但都是获取到了一个新的对象指针（变量），但传递出去后自己不再负责 <code>Py_DECREF()</code>（即把拥有权传递出去），由<strong>接收方埋</strong>， 此时接受者变成拥有者，要负责及时调用 <code>Py_DECREF()</code>。这样的函数有：<ul><li><code>PyLong_FromLong()</code></li><li><code>Py_BuildValue()</code></li><li><code>PyObject_Str()</code></li><li><code>PyUnicode_AsUTF8()</code></li><li><code>PyObject_GetAttrString()</code></li></ul></li><li><strong>管杀也管埋（借用）</strong>，即：负责创建 PyObject 对象，然后 <code>Py_INCREF()</code> ，但同时也负责必要时调用 <code>Py_DECREF()</code> 消亡该对象，不需要接收者 <code>Py_DECREF()</code>，对象指针在它们与接收者之间是<strong>借用</strong>关系。接收者要注意借用时长不要超过借出方的给定时长，如果会超出，先 <code>Py_INCREF()</code> 一下。这样的函数有：<ul><li><code>PyTuple_GetItem()</code></li><li><code>PyList_GetItem()</code></li><li><code>PyDict_GetItem()</code></li><li><code>PyDict_GetItemString()</code></li><li><code>PyImport_AddModule()</code></li></ul></li></ul><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</h5></div><div class="admonition-content"><p>所以，我们自己用库函数或写自己的函数时，都要首先弄清楚、想明白这个函数是情况 1、还是 2，然后决策自己是否需要 Py_INCREF 和 Py_DECREF。</p></div></div><p>没有必要为每个包含指向对象的指针的局部变量增加对象的引用计数。理论上，当变量指向对象时，对象的引用计数增加 1 ，当变量超出范围时，对象的引用计数减少 1 。但是，这两者相互抵消，所以最后引用计数没有改变。—— 所以函数内临时变量就可以省略 Py_INCREF 和 Py_DECREF。</p><p>使用引用计数的唯一真正原因是防止对象被释放。—— 即把根留住，自己要用。类似锁机制。</p><p>比如：</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">void</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">bug</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">PyObject </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    PyObject </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">item </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> PyList_GetItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    PyList_SetItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PyLong_FromLong</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">0L</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    PyObject_Print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> BUG! </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>首先借用一个引用 list<!-- -->[0]<!-- --> ，然后替换 list<!-- -->[1]<!-- --> 为值 0 ，最后打印借用的 list<!-- -->[0]<!-- --> 的引用。
如果借用方代码写的有问题，当替换 list<!-- -->[1]<!-- --> 的时候，原来的 list<!-- -->[1]<!-- --> 会被释放，自动调用 <code>__del__()</code>，把 list<!-- -->[0]<!-- --> 也释放了，则打印那句就 emo 了。
所以改进为：</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">void</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">no_bug</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">PyObject </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    PyObject </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">item </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> PyList_GetItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Py_INCREF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    PyList_SetItem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PyLong_FromLong</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">0L</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    PyObject_Print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    Py_DECREF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>如果知道至少有一个对该对象的其他引用存活时间至少和我们的变量一样长，则没必要临时增加引用计数。一个典型的情形是，对象作为参数从 Python 中传递给扩展模块中的 C 函数时，调用机制会保证在调用期间持有对所有参数的引用 —— 所以扩展中的 C 函数内不必 Py_INCREF 和 Py_DECREF。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="load-and-import">Load and Import<a class="hash-link" href="#load-and-import" title="Direct link to heading">​</a></h4><ul><li><code>PyObject *PyImport_ImportModule(const char *name)</code></li><li><code>PyObject *PyImport_Import(PyObject *name)</code></li><li><code>PyObject *PyImport_AddModule(const char *name)</code></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="实例化类和方法">实例化类和方法<a class="hash-link" href="#实例化类和方法" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithStickyNavbar_mojV" id="创建-class">创建 class<a class="hash-link" href="#创建-class" title="Direct link to heading">​</a></h4><h3 class="anchor anchorWithStickyNavbar_mojV" id="参考文档">参考文档<a class="hash-link" href="#参考文档" title="Direct link to heading">​</a></h3><ul><li><strong>pkg-config</strong><ul><li><a href="https://people.freedesktop.org/~dbn/pkg-config-guide.html" target="_blank" rel="noopener noreferrer">Guide to pkg-config</a></li><li><a href="https://askubuntu.com/questions/210210/pkg-config-path-environment-variable" target="_blank" rel="noopener noreferrer">PKG_CONFIG_PATH environment variable</a></li></ul></li><li><strong>Python C-API</strong><ul><li><a href="https://zhuanlan.zhihu.com/p/165232299" target="_blank" rel="noopener noreferrer">第 1 篇:CPython 实现原理：万物皆为 PyObject</a></li><li><a href="https://stackoverflow.com/questions/37281669/how-to-define-a-new-class-with-methods-via-the-c-api-with-python-3" target="_blank" rel="noopener noreferrer">How to define a new class with methods via the C-API with Python 3?</a><ul><li><a href="https://www.coder.work/article/5018891" target="_blank" rel="noopener noreferrer">翻译： 如何使用 Python 3 通过 C-API 使用方法定义新类？ </a></li></ul></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="go--c">go ~ C<a class="hash-link" href="#go--c" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="/assets/images/key-point.drawio-9c9934ba623716a13b85bc764822920b.svg" width="371" height="371" class="img_E7b_"></p><p>下面聊聊图中的 2：神奇的 cgo ……</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="hello-world-1">Hello World<a class="hash-link" href="#hello-world-1" title="Direct link to heading">​</a></h3><p>新建一个 go demo 项目</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ mkdir hello-world</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ cd hello-world</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go mod init github.com/wkevin/demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ vi main.go</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在 main.go 文件中通过 cgo 调用 C 标准库函数获取浮点数的最大值：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// #include &lt;float.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;C&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fmt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Max float value of float is&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">FLT_MAX</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>import &quot;C&quot;</code> 是启动 cgo 的标志，cgo 还会自动解析紧挨这的上面的注释行，这些内容称为序文，cgo 自动解析这些注释行，减低用户的心智负担。</p><p>可以通过 <code>go run</code> 直接运行：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go run main.go</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Max float value of float is 3.4028234663852886e+38</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>也可见使用 <code>go build</code> 编译后得到目标文件：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go build</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Max float value of float is 3.4028234663852886e+38</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="cgo-编译过程">cgo 编译过程<a class="hash-link" href="#cgo-编译过程" title="Direct link to heading">​</a></h3><p>完整的编译过程在<a href="https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-05-internal.html" target="_blank" rel="noopener noreferrer">这里</a>有详细的描述，我来画点重点。</p><p>如果 build 时添加 <code>-x</code> 参数，还能看到 cgo 完整的编译过程：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go build -x</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">WORK=/tmp/go-build4264576471</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">cd /data/kevin/workspace/klearn/blog</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">git status --porcelain</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">cd /data/kevin/workspace/klearn/blog</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">git -c log.showsignature=false show -s --format=%H:%ct</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">......</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>虽然代码很短，但打印很长，完整显示了 go build 的过程，包括：</p><ul><li>创建一个临时的工作目录，用于 cgo 转换文件<ul><li><code>WORK=/tmp/go-build4264576471</code> 临时路径</li></ul></li><li>gcc 编译用户源码，放在一个临时路径<ul><li><code>packagefile github.com/wkevin/demo=/home/me/.cache/go-build/d9/d98fd26140760ead7452e4142299b280f7786db18cea8b9f078f488491323ebc-d</code> -- 我的 demo，放在了 <code>~/.cache/...</code> 下面</li></ul></li><li>创建一个 importcfg.link 文件记录所依赖的 go 包的路径<ul><li><code>packagefile xxx=yyy</code></li></ul></li><li>link 链接<ul><li><code>mkdir -p $WORK/b001/exe/</code></li><li><code>/data/software/go/go.root/go1.18.2/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out ...</code></li></ul></li><li>目标拷贝到用户目录<ul><li><code>cp $WORK/b001/exe/a.out demo</code></li></ul></li><li>删除临时路径<ul><li><code>rm -r $WORK/b001/</code></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="cgo-知识要点">cgo 知识要点<a class="hash-link" href="#cgo-知识要点" title="Direct link to heading">​</a></h3><p>cgo 有 2 块内容：</p><ul><li>cmd/go<ul><li><code>go tool cgo [cgo options] [-- compiler options] gofiles...</code></li></ul></li><li>runtime/go: 用于在 Go 和 C 之间安全地传递 Go 值</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="命令行">命令行<a class="hash-link" href="#命令行" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go tool cgo --help</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="序文">序文<a class="hash-link" href="#序文" title="Direct link to heading">​</a></h4><p>cgo 可以识别源码中 <code>import &quot;C&quot;</code> 紧挨着的上面的注释行，并分析出所需的参数，cgo 给这些注释行起了个名字：<strong>序文</strong> —— 这点总是让从其他语言转移而来的新同学大开眼界。</p><p>前面 hello world 中的</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// #include &lt;float.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">import </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;C&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>也可以写成</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#include &lt;float.h&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">import </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;C&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>import &quot;C&quot;</code> 与注释之间不能有空行，注释可以多行：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#include &lt;float.h&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">import </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;C&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>序文中还支持 <code>#cgo</code> 开头的指令(directive)：</p><ul><li><code>CGO_CFLAGS</code>, <code>CGO_CPPFLAGS</code>, <code>CGO_CXXFLAGS</code>, <code>CGO_FFLAGS</code>, <code>CGO_LDFLAGS</code></li><li><code>CFLAGS</code>, <code>CPPFLAGS</code>, <code>CXXFLAGS</code>, <code>FFLAGS</code>, <code>CPPFFLAGS</code>, <code>LDFLAGS</code></li><li>交叉编译时还支持 <code>CXX*FOR_TARGET</code>, <code>CXX_FOR*${GOOS}_${GOARCH}</code></li></ul><p>举例</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// #cgo CFLAGS: -DPNG_DEBUG=1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// #cgo amd64 386 CFLAGS: -DX86=1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// #cgo LDFLAGS: -lpng</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// #include &lt;png.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;C&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="数据类型转换">数据类型转换<a class="hash-link" href="#数据类型转换" title="Direct link to heading">​</a></h4><p>cgo 是 go 官方标准库中的一个模块，<a href="https://pkg.go.dev/runtime/cgo" target="_blank" rel="noopener noreferrer">go doc</a> 中</p><table><thead><tr><th>C 语言类型</th><th>CGO 类型</th><th>Go 语言类型</th></tr></thead><tbody><tr><td>char</td><td>C.char</td><td>byte</td></tr><tr><td>singed char</td><td>C.schar</td><td>int8</td></tr><tr><td>unsigned char</td><td>C.uchar</td><td>uint8</td></tr><tr><td>short</td><td>C.short</td><td>int16</td></tr><tr><td>unsigned short</td><td>C.ushort</td><td>uint16</td></tr><tr><td>int</td><td>C.int</td><td>int32</td></tr><tr><td>unsigned int</td><td>C.uint</td><td>uint32</td></tr><tr><td>long</td><td>C.long</td><td>int32</td></tr><tr><td>unsigned long</td><td>C.ulong</td><td>uint32</td></tr><tr><td>long long int</td><td>C.longlong</td><td>int64</td></tr><tr><td>unsigned long long int</td><td>C.ulonglong</td><td>uint64</td></tr><tr><td>float</td><td>C.float</td><td>float32</td></tr><tr><td>double</td><td>C.double</td><td>float64</td></tr><tr><td>size_t</td><td>C.size_t</td><td>uint</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_mojV" id="参考文档-1">参考文档<a class="hash-link" href="#参考文档-1" title="Direct link to heading">​</a></h3><ul><li>官方文档：<a href="https://pkg.go.dev/cmd/cgo" target="_blank" rel="noopener noreferrer">cmd/cgo</a>、<a href="https://pkg.go.dev/runtime/cgo" target="_blank" rel="noopener noreferrer">runtime/cgo</a></li><li><a href="https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/readme.html" target="_blank" rel="noopener noreferrer">《Go 语言高级编程(Advanced Go Programming)》-- 第 2 章 CGO 编程</a><ul><li>内容完整，篇幅较长，并且中文，书籍的两位作者都是 Go 语言最早期国内推广者。</li></ul></li><li><a href="https://zhuanlan.zhihu.com/p/349197066" target="_blank" rel="noopener noreferrer">2021.02 - Go 与 C 的桥梁：cgo 入门，剖析与实践 @ 腾讯 IEG 后台开发工程师</a><ul><li>完整描述了 cgo 所需的各方面知识：cgo 的 N 种语法、数据类型转换、内部机制</li><li>后来发现本文大部分内容有抄袭上面书籍的嫌疑。</li></ul></li><li><a href="https://cloud.tencent.com/developer/article/1650525" target="_blank" rel="noopener noreferrer">2020.6 - CGO 和 CGO 性能之谜</a><ul><li>先报了 cgo 的黑料（不能交叉编译、性能……），然后用个小例子说明了 cgo 的原理，然后弄了个大例子说明性能损耗在真实情况下可以忽略不计，最后推荐了一些使用 cgo 的开源项目。—— 很棒的一篇文章！</li></ul></li><li><a href="https://golang.design/under-the-hood/zh-cn/part3tools/ch11compile/cgo/" target="_blank" rel="noopener noreferrer">13.10 cgo</a><ul><li><a href="https://golang.design/under-the-hood/" target="_blank" rel="noopener noreferrer">《Go 语言原本》- 2018</a>中的一个章节，本书是 Go 源码解读系列，作者是 B 站 Go 夜读的发起人和网友们。</li><li>但此章节非常简短，只是贬低了一下 cgo，并且由于撰写时已年代久远，应该已经不足为据。</li></ul></li><li><a href="https://go.dev/blog/cgo" target="_blank" rel="noopener noreferrer">2011.3 - C? Go? Cgo!</a><ul><li>go 官方网站上的一篇博客文章，2011 年，OMG，11 年前的文章，但百度上的很多水文都 copy 了这篇，一直 copy 到 2022 年。</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="go--c--python">go ~ C ~ python<a class="hash-link" href="#go--c--python" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="/assets/images/key-point.drawio-9c9934ba623716a13b85bc764822920b.svg" width="371" height="371" class="img_E7b_"></p><p>下面聊聊图中的 3：贯穿、打通 go(cgo)--python(C-API)。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="hello-world-2">Hello World<a class="hash-link" href="#hello-world-2" title="Direct link to heading">​</a></h3><p>同前一个 hello world 一样，新建一个 go demo 项目</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ mkdir hello-world</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ cd hello-world</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go mod init github.com/wkevin/demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ vi main.go</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在 main.go 文件中通过 cgo 调用 python C-API：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#cgo pkg-config: python-3.8-embed</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#include &lt;Python.h&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;C&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Py_Initialize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">defer</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Py_Finalize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fmt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GoString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Py_GetVersion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>运行或编译：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go run main.go</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.8.10 (default, Mar 15 2022, 12:22:08)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">[GCC 9.4.0]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>但您可能不会那么顺利，如果 python 的版本没有指定好，会遇到一些令人沮丧的提示，比如：</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="情况-1-跑不起来">情况 1: 跑不起来<a class="hash-link" href="#情况-1-跑不起来" title="Direct link to heading">​</a></h4><p>在我本机上虽然已经安装好了 python3.10，并且已经成功找到了其 pc 文件</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --list-all | grep python-3.10</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.10-embed              Python - Embed Python into an application</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">python-3.10                    Python - Build a C extension for Python</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>但当我修改为</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">#cgo pkg</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> python</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">3.10</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">embed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>时报错：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go run main.go</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/tmp/go-build3500527914/b001/exe/main: error while loading shared libraries: libpython3.10.so.1.0: cannot open shared object file: No such file or directory</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>诊断：</strong></p><p>首先查看编译出的 demo 是否依赖对了：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ objdump -x demo |grep NEEDED</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">DED</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  NEEDED               libpython3.10.so.1.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  NEEDED               libpthread.so.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  NEEDED               libc.so.6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>或</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ readelf -d demo |grep &quot;Shared&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> 0x0000000000000001 (NEEDED)             Shared library: [libpython3.10.so.1.0]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>或</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ldd demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  linux-vdso.so.1 (0x00007fff497b1000)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libpython3.10.so.1.0 =&gt; not found</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f8d5394d000)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8d5375b000)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  /lib64/ld-linux-x86-64.so.2 (0x00007f8d539a9000)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>3 种方法都表明依赖对了，就是找不到 libpython3.10.so.1.0。</p><p>那么其实原理是这样的：</p><p>Linux 中 编译运行大体分 3 步：</p><ol><li>compile：编译</li><li>link：链接</li><li>load：运行</li></ol><p>我们使用 <code>gcc -I... -L... -l... main.c</code> 只执行上 1、2 两步，其中 link 阶段涉及搜索库的问题，但第 3 步 load 也存在到哪里搜索依赖库文件的问题。</p><ul><li>首先要明确，gcc 编译过程中，gcc 只是前端，后端还有很多工具支持，如：linker、ar...</li><li>linker 链接时使用 <code>LIBRARY_PATH</code> 环境变量和送入的 <code>-Lxxx</code> 参数</li><li>loader 运行时使用 <code>LD_LIBRARY_PATH</code> 环境变量和 <code>/etc/ld.so.conf</code></li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>loader 知识复习</h5></div><div class="admonition-content"><p>运行二进制文件时，ld 更具默认查找 lib 的路径是从 <code>/etc/ld.so.conf</code> 文件和环境变量 <code>LD_LIBRARY_PATH</code> 获取的。</p><p><code>ldconfig -p</code> 可以查看当前 ld 命令能够看到的动态库，比如：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ldconfig -p |grep libpython</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libpython3.8.so.1.0 (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython3.8.so.1.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libpython3.8.so (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython3.8.so</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libpython2.7.so.1.0 (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython2.7.so.1.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  libpython2.7.so (libc6,x86-64) =&gt; /lib/x86_64-linux-gnu/libpython2.7.so</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>平常使用 gcc 编译、ld 链接的时候，添加临时目录可以使用 <code>LD_LIBRARY_PATH</code>，添加常用目录可以修改 <code>/etc/ld.so.conf</code> 下的文件。</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ cat /etc/ld.so.conf</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">include /etc/ld.so.conf.d/*.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ls /etc/ld.so.conf.d/*.conf | xargs cat</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/lib/x86_64-linux-gnu/libfakeroot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># Multiarch support</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/local/lib/i386-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/lib/i386-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/lib/i386-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/local/lib/i686-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/lib/i686-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/lib/i686-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># libc default configuration</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/local/lib</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"># Multiarch support</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/local/lib/x86_64-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/lib/x86_64-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/lib/x86_64-linux-gnu</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>也可以继续查看一下具体哪个路径下有多少文件：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ls /etc/ld.so.conf.d/*.conf  | xargs cat | sed &#x27;/^#/d&#x27; | xargs -I{} sh -c &#x27;du -sh {} 2&gt;/dev/null&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">116K    /usr/lib/x86_64-linux-gnu/libfakeroot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">368M    /lib/i386-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">368M    /usr/lib/i386-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">548K    /usr/local/lib</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.6G    /lib/x86_64-linux-gnu</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.6G    /usr/lib/x86_64-linux-gnu</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>由于我 ubuntu 根目录下的 <code>lib*</code> 都是软连接：</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ll /lib*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">lrwxrwxrwx 1 root root  7 4月   2  2020 /lib -&gt; usr/lib</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">lrwxrwxrwx 1 root root  9 4月   2  2020 /lib32 -&gt; usr/lib32</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">lrwxrwxrwx 1 root root  9 4月   2  2020 /lib64 -&gt; usr/lib64</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">lrwxrwxrwx 1 root root 10 4月   2  2020 /libx32 -&gt; usr/libx32</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>所以可见，ubuntu 主要将 lib 放在 <code>/usr/lib/i386-linux-gnu</code> 和 <code>/usr/lib/x86_64-linux-gnu</code> 中。</p></div></div><p>所以解决方案也就得到了：</p><ul><li>临时方案</li></ul><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ echo $LD_LIBRARY_PATH</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/usr/local/lib:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ LD_LIBRARY_PATH=/home/me/.pyenv/versions/3.10.5/lib:$LD_LIBRARY_PATH</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ ./demo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.10.5 (main, Jun 13 2022, 18:16:59) [GCC 9.4.0]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>长期方案</li></ul><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ sudo ln -s ~/.pyenv/versions/3.10.5/lib/libpython3.10.so.1.0 /usr/local/lib/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>其实 gcc 对此也是有更佳解决方案的：<code>gcc -Wl,-rpath-link,&lt;dir&gt;</code> 可以向 loader 传递寻找依赖库的路径，但一是 cgo 我暂时没找到如何传 <code>-Wl</code> 参数的方式，二来这也不是个好方案，一旦用户挪走了依赖库，则造成更难定位的故障。</p><p>我尝试了</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">#cgo LDFLAGS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">Wl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">rpath</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">link</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">home</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">me</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyenv</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">versions</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">3.10</span><span class="token number" style="color:rgb(181, 206, 168)">.5</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">lib</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>但没有成功。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="情况-2-更新不了">情况 2: 更新不了<a class="hash-link" href="#情况-2-更新不了" title="Direct link to heading">​</a></h4><p>我将 python3-embed.pc 做成了指向 python-3.10-pc 的软连接</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ sudo rm python3-embed.pc</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ sudo ln -s python-3.10-embed.pc python3-embed.pc</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ pkg-config --libs python3-embed</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-L/home/me/.pyenv/versions/3.10.5/lib -lpython3.10</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>但执行这样的 main.go</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">#cgo pkg</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> python3</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">embed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>时仍然找到的是 python3.8</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ go run main.go</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3.8.10 (default, Mar 15 2022, 12:22:08)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">[GCC 9.4.0]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>有点诡异，不科学，甚至删掉 <code>//usr/lib/x86_64-linux-gnu/pkgconfig/python3-embed.pc</code> 都仍然能基于 python3.8 运行 —— 盲猜可能是被缓存了，一时不能使用最新的。</p><p>过了一会再试，果然就好了。</p><p>后来搜到<a href="https://github.com/golang/go/issues/24544" target="_blank" rel="noopener noreferrer">一篇文章</a>，提到 <code>go clean -cache</code> —— 有用！再遇到就不用等了。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cgo-不识别宏定义">cgo 不识别宏定义<a class="hash-link" href="#cgo-不识别宏定义" title="Direct link to heading">​</a></h3><p><code>&lt;Python.h&gt;</code>中的宏定义在 cgo 中看不到</p><p>比如在 python C-API 的源码中可以找到 <code>PyNumber_Check</code> 和 <code>PyType_FastSubclass</code> 的定义：</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">PyAPI_FUNC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyNumber_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">PyObject </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">PyDict_Check</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">op</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">PyType_FastSubclass</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">Py_TYPE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">op</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> Py_TPFLAGS_DICT_SUBCLASS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>PyNumber_Check: cgo 能够使用</li><li>PyDict_Check: cgo 不能够使用</li></ul><p>可以做个封装给 cgo</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#cgo pkg-config: python3-embed</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">#include &lt;Python.h&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">int Cgo_PyDict_Check(PyObject *o){</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">    return PyDict_Check(o);</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;C&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyDict_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Cgo_PyDict_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">toc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="python-c-api-的-go-封装">Python C-API 的 go 封装<a class="hash-link" href="#python-c-api-的-go-封装" title="Direct link to heading">​</a></h3><p>上面的 <code>PyDict_Check</code> 就是对 <code>C.Cgo_PyDict_Check</code> 的封装就是示例，直接使用 <code>C.xxx</code> 的最大问题是 VSCode 无法做智能提示，如果封装成 go，能够 <code>.</code> 出智能提示，可以减少一些工作量，同时，go 能够做强类型检查，减少编辑错误的产生。</p><p>更多一些：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> PyObject C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">PyObject # </span><span class="token keyword" style="color:rgb(86, 156, 214)">go</span><span class="token plain"> 类型直接对标 c 类型</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">togo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cobject </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cobject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">toc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">object </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">PyObject </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">object</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyCallable_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">PyCallable_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">toc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyNumber_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">PyNumber_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">toc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyLong_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">PyLong_AsDouble</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">toc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyDict_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">PyObject</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Cgo_PyDict_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">toc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>这样我的 go 代码中可以直接使用了各种 Check 函数了。</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">PyObject</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> goobj </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">PyDict_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">goobj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">// do something...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">// goobj.XXX  -- go 的智能提示可以使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>否则需要</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token plain">C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">PyObject</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> cobj </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Cgo_PyDict_Check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cobj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">// do something...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">// cobj 没有智能提示</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>这里推荐 2 个开源项目:</p><ul><li><a href="https://github.com/DataDog/go-python3" target="_blank" rel="noopener noreferrer">DataDog/go-python3</a>: 针对 python3 的 C-API 封装</li><li><a href="https://github.com/sbinet/go-python" target="_blank" rel="noopener noreferrer">sbinet/go-python</a>: 针对 python2 的 C-API 封装</li></ul><p>很可惜的是，2 个项目都已经停止开发了，不过大家仍然可以参考其源码写出自己的封装，毕竟我们一般需要封装的函数只是 C-API 全集中很少的一部分，常用的 30 个封装一下就够用了，人家维护这个项目要封装全部确实工作量很大，并且价值不高。同时该项目的目项目 DataDog，也是个不错的项目，数据收集、分析、挖掘的网络后端，下载其源码，go 写的，内部也使用了很多 python 封装，值得参考、学习。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cpython-的-gil">CPython 的 GIL<a class="hash-link" href="#cpython-的-gil" title="Direct link to heading">​</a></h3><p>CPython 与其他语言（Java、C#等）实现的 python 解释器一个很大的不同点：GIL —— 它是 python 的 global interpreter lock，全局解释器锁，CPython 解释器所采用的一种机制，它确保同一时刻每个解释器进程中只有一个线程在执行 Python bytecode。单线程程序可以无视 GIL，多线程则必须先申请，拿到锁后再执行，执行完毕就释放。 —— 与二进制信号量原理一致。</p><ul><li><code>PyGILState_Ensure()</code>: 保存状态并锁定 GIL。</li><li><code>PyGILState_Release()</code>: 恢复状态并解锁 GIL。</li></ul><p>由于 GIL 的存在，使得 CPython 本质上进程中只能单线程（thread），有不少网文都在试图证明多线程是个假象，如果要真正的并发，只能多进程（process）。那我有 3 个建议：</p><ol><li>换其他 Python 解释器吧 : )</li><li>其实从嵌入式程序员角度看，这就类似于多线程（或多进程、多任务）跑在单核 CPU/MCU 上，仔细打磨照样能提升效率。比如在 GPU 计算任务、I/O 等操作时及时释放 GIL，让其他线程及时获取 GIL，整个程序的性能也能提高。——作用还是有的，仔细斟酌就是。并且线程比进程成本小，多搞几个也没啥大的副作用，不容易把程序搞死。再加上线程池的应用，就更能减少工作量了。</li><li>如果没有信心这样细化操作，也可以使用 multiprocessing 模块的多进程，能够把 CPU 多核用起来了。python 的多进程是指多个解释器进程（与我们平常理解的 C 运行态的多进程还不一样），每启动一个进程本质上是创建一个解释器进程，python 代码都是喂给解释器的食物，解释器一行一行执行，就像一口一口吃，这也是 python 代码叫脚本的缘故。<strong>每个解释器进程中都维护一个 GIL，多进程可以跑在多 CPU 多核上，进程间多出来要考虑的就是进程间通信了。</strong></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="python-的进线协">Python 的进线协<a class="hash-link" href="#python-的进线协" title="Direct link to heading">​</a></h3><p>标准库中的下面几个模块有必要仔细阅读一下：</p><p><strong>进程（Process）</strong></p><ul><li><a href="https://docs.python.org/zh-cn/3/library/subprocess.html" target="_blank" rel="noopener noreferrer">subprocess --- 子进程管理（启进程执行 shell 命令）</a><ul><li><code>run()</code> 调用子进程，如：<code>subprocess.run([&quot;ls&quot;, &quot;-l&quot;])</code>, 替代以前的 <code>os.system()</code>、<code>os.popen()</code>、<code>os.spawn*</code></li><li><code>CompletedProcess</code>: <code>run()</code> 的返回值</li><li><code>Popen</code>: ProcessOpen，<code>run()</code> 的底层实现</li></ul></li><li><a href="https://docs.python.org/zh-cn/3/library/multiprocessing.html" target="_blank" rel="noopener noreferrer">multiprocessing --- 基于进程的并行</a><ul><li><code>Process</code>: 进程类，<code>start()</code> 启动、<code>join()</code> 阻塞调用者，即同步</li><li><code>Pool</code>：进程池</li><li>进程间通信:<code>Connection=Pipe()</code>、<code>Queue</code></li></ul></li></ul><p><strong>线程（Threading）</strong></p><ul><li><a href="https://docs.python.org/zh-cn/3/library/threading.html" target="_blank" rel="noopener noreferrer">threading --- 基于线程的并行</a><ul><li><code>Thread</code>: 线程类，<code>start()</code> 启动、<code>join()</code> 阻塞调用者，即同步</li><li><strong>GIL 的 72 变</strong>：、<code>Lock</code>-原始锁、<code>RLock</code>-递归锁/重入锁、<code>Semaphore</code>-信号量、<code>Event</code>-事件、<code>Timer</code>-定时器、<code>Barrier</code>-栅栏</li></ul></li></ul><p><strong>进程 + 线程</strong></p><ul><li><a href="https://docs.python.org/zh-cn/3/library/concurrent.html" target="_blank" rel="noopener noreferrer">concurrent 包</a><ul><li><a href="https://docs.python.org/zh-cn/3/library/concurrent.futures.html" target="_blank" rel="noopener noreferrer">concurrent.futures --- 启动并行任务</a><ul><li>ThreadPoolExecutor/ProcessPoolExecutor: 创建线程池/进程池<ul><li><code>.submit(fn, *args, **kwargs)</code>: 将 fn 函数提交给线程池, 返回一个 Future 对象.<ul><li>Future 可以：<code>cancel()</code>、<code>running()</code>、<code>done()</code>、<code>result()</code>、<code>exception()</code>、<code>add_done_callback()</code></li></ul></li><li><code>map(func, *iterables, timeout=None, chunksize=1)</code>: 异步方式立即对 iterables 执行 map</li><li><code>shutdown(wait=True)</code>: 关闭线程池</li></ul></li></ul></li></ul></li></ul><p><strong>协程（Coroutines）+ 进程</strong></p><ul><li><a href="https://docs.python.org/zh-cn/3/library/asyncio.html" target="_blank" rel="noopener noreferrer">asyncio --- 异步 I/O</a> 包含 14 个主题，全面阐述协程的使用<ul><li>高层 API<ul><li>协程<ul><li><code>async def foobar()</code> 定义一个协程（异步）函数</li><li><code>await foobar()</code> 等待一个可等待对象（协程, 任务 和 Future）</li><li><code>asyncio.create_task()</code> 并发运行作为 asyncio 任务 的多个协程</li><li><code>asyncio.sleep()</code></li><li><code>to_thread()</code> 在不同的 OS 线程中异步地运行一个函数</li></ul></li><li>进程<ul><li><code>asyncio.create_subprocess_shell()</code> 创建子进程</li><li><code>asyncio.subprocess.PIPE/STDOUT/DEVNULL</code></li></ul></li><li>网络 IO（略）</li><li>操作<ul><li><code>asyncio.run(foobar())</code> 运行协程、进程</li></ul></li></ul></li><li>底层 API（略）</li></ul></li></ul><p>协程函数不同于普通函数，调用普通函数会得到返回值，而调用异步函数会得到一个协程对象。我们需要将协程对象放到一个事件循环中才能达到与其他协程对象协作的效果，因为事件循环会负责处理子程 序切换的操作。</p><p>python 将协程与异步的概念进行了强捆绑，我觉得不妥，虽然协程肯定会异步执行，但异步的并不一定就是协程，新城、进程都可以异步。相比 <code>go func()</code> 就创建一个 go 协程，就不强捆绑，舒服很多。python 背后的原因我猜想会不会也是考虑到整合网络 IO，学习 js、ts 的 async+await，但个人觉得强整不好，有害健康。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="go-的进线协">go 的进线协<a class="hash-link" href="#go-的进线协" title="Direct link to heading">​</a></h3><p>首先，python 和 go 中的进程、线程就是操作系统的进程和线程，go 和 python 以及所有语言都不会在进程（Process）、线程（Thread）上做新的定义，统一遵守操作系统的定义：</p><ul><li>进程：资源的最小单位</li><li>线程：调度的最小单位</li></ul><p>但协程则没有统一的定义和规范，各家自由发挥，大概都是朝着“托管在线程中，比线程更轻量级，操作系统感知不到”这个方向努力！但是，go 和 python 的协程在创建、调度、API 方面差异还是挺大的——是几乎看不到相同点好吧！。要说 go 和 python 谁先有的协程，我还真不知道，python 好像很晚才引入的协程，但 go 才一开始就有，说不定 go 更早些。gp 还将专业术语 coroutine 演进为 gorutine，企图标榜其 G 字头的地位之特殊。</p><p><strong>进程（Process）</strong></p><ul><li><a href="https://pkg.go.dev/os" target="_blank" rel="noopener noreferrer">os</a><ul><li><code>Process</code><ul><li><code>func FindProcess(pid int) (*Process, error)</code></li><li><code>func StartProcess()</code></li><li><code>func (p *Process) Kill() error</code></li><li><code>func (p *Process) Release() error</code></li><li><code>func (p *Process) Signal(sig Signal) error</code></li><li><code>func (p *Process) Wait() (*ProcessState, error)</code></li></ul></li></ul></li><li><a href="https://pkg.go.dev/os/exec" target="_blank" rel="noopener noreferrer">os/exec</a><ul><li><code>Cmd</code><ul><li><code>func Command(name string, arg ...string) *Cmd</code>: 创建 Cmd(shell 命令)</li><li><code>func (cmd *Cmd)Run()/Start()/Wait()/...</code>: 执行/开始/等待/...</li></ul></li></ul></li></ul><p><strong>协程（Gorutine）与线程（Threading）</strong></p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">go</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>就创建并启动了 go 协程，极其方便，协程的生成后会被放入队列（有当前线程的本地队列，也有全局队列），然后协程调度器会自动安排，调度器可以将多个协程调度到一个线程中，一个协程也可能切换到多个线程中执行。由于线程之间也是资源共享的，所以协程之间也是资源共享的，没有“线程或协程见通信的概念和需求”，也就没有了切换开销，也不需要多线程的锁机制（没错，说的就是上面的 GIL 同学），所以效率比多线程高很多。—— 有时间的话可以看看<a href="https://juejin.cn/post/6844903662553137165" target="_blank" rel="noopener noreferrer">Golang 的 协程调度机制 与 GOMAXPROCS 性能调优</a>。</p><p>至于线程，go 编程人员几乎用不到，go 认为有协程了还用啥线程，协程比线程好用，线程的 API 就不提供了，你就认为协程就是线程算了。只留了线程锁（类似 python GIL）的 2 个接口：<code>LockOSThread()</code>,<code>UnlockOSThread()</code>，以便我们开发线程安全的可重入函数。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="go-协程嵌-py-进程">go 协程嵌 py 进程<a class="hash-link" href="#go-协程嵌-py-进程" title="Direct link to heading">​</a></h3><p>典型代码示例：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#9CDCFE;background-color:#1E1E1E"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">Foobar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    runtime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">LockOSThread</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">         </span><span class="token comment" style="color:rgb(106, 153, 85)">// 别被其他 go 线程抢占了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">defer</span><span class="token plain"> runtime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">UnlockOSThread</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Py_IsInitialized</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        py</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Py_Initialize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    _gil </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">PyGILState_Ensure</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// 别被其他 python 线程抢占了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">defer</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">PyGILState_Release</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_gil</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">// do something...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>试想：</p><ul><li>go 程序（进程）启动后会自动创建线程池，线程池与协程之间由调度器自己安排。python 解释器进程就是 go 进程，从 <code>ps -ef</code> 里只会看到一个进程。</li><li>某个调用了 C-API 的 go 函数每次可能运行在不同的协程上，也十分可能运行在不同的线程上。</li><li>goroutine 执行 C 后，自身暂停。cgo 是用新线程运行 C 还是没有，我不确定，但从下面代码中看似乎 py 和 go 的 threading id 相同。</li><li>如果 goroutine 函数被抢占了，安装文章 <a href="https://linux.cn/article-13564-1.html" target="_blank" rel="noopener noreferrer">2021.7 - 如何在 Go 中嵌入 Python</a> 的说法会奔溃，但我觉得 C 和 go 已经合为一体，会延续在一个线程这执行，没有异步的情况发生，即使中间被调度到其他 CPU/核 上执行，应该也不会出错。</li><li>上面示例代码我注释掉前 2 行，在 go 1.16、1.17、1.18 上测试都没有崩溃，也可能我用的框架限制了线程数，先搁置一下，以后遇到崩溃再回头来看。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="参考文档-2">参考文档<a class="hash-link" href="#参考文档-2" title="Direct link to heading">​</a></h3><ul><li><strong>Python Embedding into Go</strong> -- go 中嵌 python<ul><li>google：<code>embedding python in go</code></li><li><a href="https://docs.python.org/zh-cn/3/extending/embedding.html" target="_blank" rel="noopener noreferrer">Python 官方文档：在其它应用程序嵌入 Python</a></li><li><a href="https://www.ardanlabs.com/blog/2020/06/python-go-grpc.html" target="_blank" rel="noopener noreferrer">2020.6 - Python and Go ： Part I - gRPC</a><ul><li>这是有 4 篇的系列文章，分别讲述了 1.go-grpc-python、2.python-c-go、3.python 打包、4.go-内存共享-python —— 尤其是 1、4 都非常有创意，我受益匪浅。</li></ul></li><li><a href="https://linux.cn/article-13564-1.html" target="_blank" rel="noopener noreferrer">2021.7 - 如何在 Go 中嵌入 Python</a><ul><li>翻译自：<a href="https://www.datadoghq.com/blog/engineering/cgo-and-python/" target="_blank" rel="noopener noreferrer">Cgo and Python</a> -- DataDog 的 Blog，应该是 DataDog 产品的开发者缩写，DataDog 大量使用了 Go 调 Python。</li><li>特别介绍了前面书和文章中没有的 GIL（全局解释器锁）</li></ul></li><li><a href="https://poweruser.blog/embedding-python-in-go-338c0399f3d5" target="_blank" rel="noopener noreferrer">2020.10 - Embedding Python in Go</a></li></ul></li><li><strong>Python Extending with Go</strong> -- python 中嵌 go<ul><li><a href="https://hackernoon.com/extending-python-3-in-go-78f3a69552ac" target="_blank" rel="noopener noreferrer">2017.12 - Extending Python 3 in Go</a><ul><li>文章名字与内容不符，应该是 Extending Python3 with go，但内容写的还是不错的</li></ul></li><li><a href="https://www.nathanvangheem.com/posts/2017/06/03/embedding-golang-in-python-with-groupcache.html" target="_blank" rel="noopener noreferrer">2017.6 - Embedding Go and groupcache in Python</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="划重点">划重点<a class="hash-link" href="#划重点" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="/assets/images/outline-bd3bc72c415a96cb53f9d8d19a058526.svg" width="1096" height="621" class="img_E7b_"></p><ul><li>python 编译、链接<ul><li><code>env PYTHON_CONFIGURE_OPTS=&quot;--enable-shared&quot; pyenv install x.y.z</code> 编译 python 的动态库</li><li><code>pkg-config --variable pc_path pkg-config</code> pc 文件搜索路径</li><li><code>pkg-config --list-all | grep python</code> 可用的 python pc 文件</li><li><code>pkg-config --cflags --libs python3-embed</code> &amp; <code>python3.8-config --cflags --ldflags --embed</code> 获取 gcc 编译、链接参数</li><li><code>gcc `pkg-config --cflags --libs python3-embed` main.c -o demo</code> 可能失败</li><li><code>gcc main.c `pkg-config --cflags --libs python3-embed` -o demo</code> 都会成功</li></ul></li><li>python C-API<ul><li>高层 API：<code>PyRun_SimpleString</code></li><li>底层 API: 其他都是</li><li>PyObject：都在内存堆上，只能拥有指针，并做好引用计数。<ul><li>需要用户维护引用计数的：<ul><li><code>PyObject_GetAttrString()</code></li><li><code>PyLong_FromLong()</code></li></ul></li><li>不需要<ul><li><code>PyImport_AddModule()</code></li><li><code>PyList_GetItem()</code>、<code>PyTuple_GetItem()</code>、<code>PyDict_GetItem()</code></li></ul></li></ul></li></ul></li><li>cgo<ul><li><code>import &quot;C&quot;</code> 独立一行，前置序文 <code>#cgo</code> 指令</li><li><code>go run main.go</code> or <code>go build -x</code></li><li><code>go tool cgo --help</code></li><li>cgo 提供的 <code>C.CString()</code>, <code>C.GoString()</code></li><li><code>go clean -cache</code> 刷新 cgo 指令</li></ul></li><li>other<ul><li><code>ldd demo</code>、<code>objdump -x demo|grep NEEDED</code>、<code>readelf -d demo|grep &quot;Shared&quot;</code> 查看依赖的动态库</li><li>linker use <code>LIBRARY_PATH</code></li><li>loader use <code>LD_LIBRARY_PATH</code> and <code>/etc/ld.so.conf</code></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="源码下载">源码下载<a class="hash-link" href="#源码下载" title="Direct link to heading">​</a></h2><p>最后，附上本文包含，以及不包含的更深入的 <a target="_blank" href="/assets/files/src-70515198a66f116bc3d175cc489ce9dc.tar">demo 源码下载</a>。</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/python">python</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/go">go</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2022/06/17/gitee.jenkins.plugin"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Gitee Jenkins Plugin</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/05/19/vscode.wordwrap.lindwidth"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">VSCode 中的显示换行和格式化换行</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#python--c" class="table-of-contents__link toc-highlight">Python ~ C</a><ul><li><a href="#嵌入与扩展" class="table-of-contents__link toc-highlight">嵌入与扩展</a></li><li><a href="#python-c-的编译" class="table-of-contents__link toc-highlight">python C 的编译</a><ul><li><a href="#pkg-config" class="table-of-contents__link toc-highlight">pkg-config</a></li><li><a href="#pythons-pkg-config" class="table-of-contents__link toc-highlight">python&#39;s pkg-config</a></li><li><a href="#python-共享库" class="table-of-contents__link toc-highlight">python 共享库</a></li><li><a href="#python-的-flag-还能这样获取" class="table-of-contents__link toc-highlight">python 的 flag 还能这样获取</a></li></ul></li><li><a href="#hello-world" class="table-of-contents__link toc-highlight">Hello World</a><ul><li><a href="#情况-1-编译失败" class="table-of-contents__link toc-highlight">情况 1: 编译失败</a></li><li><a href="#高层-api" class="table-of-contents__link toc-highlight">高层 API</a></li><li><a href="#底层-api" class="table-of-contents__link toc-highlight">底层 API</a></li></ul></li><li><a href="#python-c-api-知识要点" class="table-of-contents__link toc-highlight">python C-API 知识要点</a><ul><li><a href="#pyobject引用计数垃圾回收" class="table-of-contents__link toc-highlight">PyObject、引用计数、垃圾回收</a></li><li><a href="#load-and-import" class="table-of-contents__link toc-highlight">Load and Import</a></li><li><a href="#实例化类和方法" class="table-of-contents__link toc-highlight">实例化类和方法</a></li><li><a href="#创建-class" class="table-of-contents__link toc-highlight">创建 class</a></li></ul></li><li><a href="#参考文档" class="table-of-contents__link toc-highlight">参考文档</a></li></ul></li><li><a href="#go--c" class="table-of-contents__link toc-highlight">go ~ C</a><ul><li><a href="#hello-world-1" class="table-of-contents__link toc-highlight">Hello World</a></li><li><a href="#cgo-编译过程" class="table-of-contents__link toc-highlight">cgo 编译过程</a></li><li><a href="#cgo-知识要点" class="table-of-contents__link toc-highlight">cgo 知识要点</a><ul><li><a href="#命令行" class="table-of-contents__link toc-highlight">命令行</a></li><li><a href="#序文" class="table-of-contents__link toc-highlight">序文</a></li><li><a href="#数据类型转换" class="table-of-contents__link toc-highlight">数据类型转换</a></li></ul></li><li><a href="#参考文档-1" class="table-of-contents__link toc-highlight">参考文档</a></li></ul></li><li><a href="#go--c--python" class="table-of-contents__link toc-highlight">go ~ C ~ python</a><ul><li><a href="#hello-world-2" class="table-of-contents__link toc-highlight">Hello World</a><ul><li><a href="#情况-1-跑不起来" class="table-of-contents__link toc-highlight">情况 1: 跑不起来</a></li><li><a href="#情况-2-更新不了" class="table-of-contents__link toc-highlight">情况 2: 更新不了</a></li></ul></li><li><a href="#cgo-不识别宏定义" class="table-of-contents__link toc-highlight">cgo 不识别宏定义</a></li><li><a href="#python-c-api-的-go-封装" class="table-of-contents__link toc-highlight">Python C-API 的 go 封装</a></li><li><a href="#cpython-的-gil" class="table-of-contents__link toc-highlight">CPython 的 GIL</a></li><li><a href="#python-的进线协" class="table-of-contents__link toc-highlight">Python 的进线协</a></li><li><a href="#go-的进线协" class="table-of-contents__link toc-highlight">go 的进线协</a></li><li><a href="#go-协程嵌-py-进程" class="table-of-contents__link toc-highlight">go 协程嵌 py 进程</a></li><li><a href="#参考文档-2" class="table-of-contents__link toc-highlight">参考文档</a></li></ul></li><li><a href="#划重点" class="table-of-contents__link toc-highlight">划重点</a></li><li><a href="#源码下载" class="table-of-contents__link toc-highlight">源码下载</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items"><li class="footer__item"><a href="http://weibo.com/wkevin27" target="_blank" rel="noopener noreferrer" class="footer__link-item">微博</a></li><li class="footer__item"><a href="https://twitter.com/wkevin27" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://gitee.com/wkevin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee</a></li><li class="footer__item"><a href="https://blog.csdn.net/kevin881" target="_blank" rel="noopener noreferrer" class="footer__link-item">CSDN</a></li></ul></div><div class="col footer__col"><div class="footer__title">Awesome</div><ul class="footer__items"><li class="footer__item"><a href="https://arxiv.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Arxiv</a></li><li class="footer__item"><a href="https://www.tianlangbooks.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">天浪书屋</a></li><li class="footer__item"><a href="https://yts.mx/" target="_blank" rel="noopener noreferrer" class="footer__link-item">YTS</a></li></ul></div><div class="col footer__col"><div class="footer__title">Collaborate</div><ul class="footer__items"><li class="footer__item"><a href="https://mubu.com/app" target="_blank" rel="noopener noreferrer" class="footer__link-item">幕布</a></li><li class="footer__item"><a href="https://shimo.im/" target="_blank" rel="noopener noreferrer" class="footer__link-item">石墨</a></li><li class="footer__item"><a href="https://www.feishu.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">飞书</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 wkevin, built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.daa8ee8e.js"></script>
<script src="/assets/js/main.a87ad509.js"></script>
</body>
</html>