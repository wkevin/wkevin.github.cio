---
title: 网络安装 Ubuntu
date: 2019-11-04 11:03:36 +0800
description: 
author: wKevin
categories: 
    - it
tags:
    - ubuntu
    - pxe
---

参考：

- [Configure PXE Server In Ubuntu 16.04](https://www.maketecheasier.com/configure-pxe-server-ubuntu/)
- [网络安装Ubuntu16.04](https://www.cnblogs.com/zhangqunshi/p/6729823.html)

干货记录如下：

## DHCP

- `sudo apt-get install isc-dhcp-server`
- `sudo vi /etc/default/isc-dhcp-server` 限定网卡开启dhcp
- `sudo vi /etc/dhcp/dhcpd.conf`

```
option domain-name "localhost";  # 必须要改，否则syslog报异常，pxe client IP无法获取
option domain-name-servers 本机IP地址;  # 必须要改，本机IP地址必须也要在192.168.1.0/24网段中

allow booting;
allow bootp;

subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.10 192.168.1.30;
    option subnet-mask 255.255.255.0;
    option routers 本机IP地址;
    option broadcast-address 192.168.1.255;
    next-server 本机IP地址;
    filename "pxelinux.0";
}
```

- `sudo /etc/init.d/isc-dhcp-server start` —— 可以加入 `/etc/rc.local`

## tfpt

- `sudo apt install tftpd-hpa tftp-hpa inetutils-inetd`
- `sudo service tftpd-hpa start`
- `sudo vi /etc/inetd.conf`
```
tftp dgram udp wait root /usr/sbin/in.tftpd /usr/sbin/in.tftpd -s /var/lib/tftpboot
```
- `sudo vi /etc/default/tftpd-hpa`
```
TFTP_USERNAME="tftp"
TFTP_DIRECTORY="/var/lib/tftpboot"
TFTP_ADDRESS=":69"
TFTP_OPTIONS="--secure"
RUN_DAEMON="yes"
OPTIONS="-l -s /var/lib/tftpboot"
```
- `sudo update-inetd --enable BOOT` 重启时自启动
- `sudo service tftpd-hpa start`
- `netstat -lu | grep tftp` check
- test
    - `tftp localhost`
    - `get ...`

## 网络启动文件（ pxelinux.0 )

- `sudo mkdir /var/lib/tftpboot`
- 3种获取方式
    - 方式1：从 **syslinux** 拷贝 —— **没有默认配置**
        - `sudo apt install syslinux`
        - `sudo mkdir /var/lib/tftpboot/pxelinux.cfg`
        - `sudo cp /usr/lib/syslinux/vesamenu.c32 /var/lib/tftpboot/`
        - `sudo cp /usr/lib/syslinux/pxelinux.0 /var/lib/tftpboot/`
    - 方式2：从ISO中获取 —— **后来很多ISO都没有了**
    - 方式3：网上下载 **netboot** —— **推荐**
        - `wget http://archive.ubuntu.com/ubuntu/dists/[precise|xenial]/main/installer-[amd64|i386]/current/images/netboot/netboot.tar.gz`
            - 可以在 mirrors.xxx 中找到
            - precise: 12.04; xenial: 16.04
        - `mv netboot.tar.gz /var/lib/tftpboot`
        - `sudo tar -xzvf netboot.tar.gz`
- 配置 pxe 获取 kernel 和 initrd 的方式和路径 —— **此处配置要和后面 nfs、apache 中配置一致**
    - `sudo vi /var/lib/tftpboot/ubuntu-installer/[amd64|i386]/boot-screens/txt.cfg` —— **新版**
        - `sudo vi /var/lib/tftpboot/pxelinux.cfg/default`  —— **旧版**
    - 重点配置下面2行
        - `kernel ......`
        - `append initrd=......  ks=......`
        - 具体怎么配置下文分方式描述


## 准备 Ubuntu

- 路径设计
    - 支持多个版本 Ubuntu 同时安装
    - Ubuntu 释放文件到：`/var/lib/tftpboot/ubuntu/xx.xx` xx.xx 为 ubuntu 的版本号，根据需求可以设计更复杂路径
- 准备 16.04
    - `sudo mount -o loop ubuntu-16.04.3-desktop-amd64.iso /media/`
    - `sudo mkdir -p /var/lib/tftpboot/ubuntu/16.04`
    - `sudo cp -r /media/* /var/lib/tftpboot/ubuntu/16.04`
    - `sudo cp -r /media/.disk /var/lib/tftpboot/ubuntu/16.04`
    - `sudo unmout /media`
- 准备 18.04
    - `sudo mount -o loop ubuntu-18.04.3-desktop-amd64.iso /media/`
    - `sudo mkdir -p /var/lib/tftpboot/ubuntu/18.04`
    - `sudo cp -r /media/* /var/lib/tftpboot/ubuntu/18.04`
    - `sudo cp -r /media/.disk /var/lib/tftpboot/ubuntu/18.04`
    - `sudo unmout /media`

## kernel/initrd

- 方式1：使用 ISO 中 casper 的 initrd.lz 和 kernel(vmlinuz.efi) —— **支持nfs**
    - pxe 配置
        - `kernel ubuntu/16.04/casper/vmlinuz.efi`
        - `append vga=788 boot=casper netboot=nfs nfsroot=192.168.1.10:/var/lib/tftpboot/ubuntu/16.04 initrd=ubuntu/16.04/casper/initrd.lz --- quiet`
            - splash：表示loading屏幕是否显示，禁用的话loading时一片空白
        - `kernel ubuntu/18.04/casper/vmlinuz`
        - `append vga=788 boot=casper netboot=nfs nfsroot=192.168.1.10:/var/lib/tftpboot/ubuntu/18.04 initrd=ubuntu/18.04/casper/initrd --- quiet`
- 方式2：使用 netboot 包含的 initrd.gz 和 kernel(linux) ——  **不支持nfs，且client始终默认http访问server，要求server必须使用apache**
    - 前面 netboot 已经释放到 `/var/lib/tftpboot` 目录下
    - pxe 配置
        - `kernel ubuntu-installer/amd64/linux`
        - `append vga=788 netboot=nfs nfsroot=192.168.1.10:/var/lib/tftpboot/ubuntu initrd=ubuntu-installer/amd64/initrd.gz quiet splash`

### NFS

- `sudo vi /etc/exports`
    - `/var/lib/tftpboot/ubuntu *(ro,async,no_root_squash,no_subtree_check)`
- `sudo exportfs -a`
- `sudo /etc/init.d/nfs-kernel-server start`

### Apache
- `sudo apt-get install apache2`
- 配置：
    - ……

## Client 配置

- BIOS
    - net interface pxe mode： enable
    - security boot：disable
    - boot sequence：net first
- 推荐
    - 使用集成显卡，pxelinux 对扩展显卡支持不完备（异常黑屏、蓝屏、粉屏……）
    - 使用小尺寸的显示器，pxelinux 大显示器支持不完备（字体、图标过大……）
- 安装完毕后，网卡不能使用
    - NetworkManager 中找不到网卡
        - 原因：NetworkManager 没有使能
        - 解决
            - `sudo vi /tc/NetworkManager/NetworkManager.conf` 增加 `managed=true` —— 使能NM
            - `sudo service NetworkManager stop`
            - `sudo rm /var/lib/NetworkManager/NetworkManager.state`
            - `sudo service NetworkManager start`
